(()=>{"use strict";var c,me={8459:(c,z,d)=>{var q=d(5861),b=d(6656),E=d(5500),G=d(7715),X=d(2438),M=d(7398),te=d(2181),ye=d(8906),be=d(6328),fe=d(8857);var Ce=d(5592),ze=d(2384);let pe;const we=new Map;class Re{constructor(e){(0,b.Z)(this,"examName",void 0),(0,b.Z)(this,"db",void 0),this.examName=e}error(...e){console.error(...e)}initDb(e){if(void 0===this.db||!this.db.isOpen()){const t=e.oo1;this.db=e.opfs?new t.OpfsDb("/"+this.examName+".sqlite3"):new t.DB("/"+this.examName+".sqlite3","ct")}}close(){this.db.close()}initemptyDb(e){this.initDb(e);try{this.db.exec("CREATE TABLE IF NOT EXISTS template(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS align(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS nonalign(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)")}finally{this.close()}}getFirstNonAlignImage(e,t){this.initDb(e);try{return this.db.selectValue("select imageData from nonalign where page="+t)}finally{this.close()}}}!function ve(V){const e=new V,t=(0,X.R)(self,"message");return function xe(V,e){const t=e.pipe((0,M.U)(r=>r.data),(0,M.U)(r=>new E.P_(r.kind,r.value,r.error)),(0,te.h)(r=>"C"!==r.kind),(0,ye.D)());return function ge(V){return!!V.workUnit}(V)?t.pipe((0,be.b)(r=>(0,G.D)(V.workUnit(r)).pipe((0,fe.i)()))):V.work(t).pipe((0,fe.i)())}(e,t).subscribe(r=>{const s=postMessage;(function Me(V){return!!V.selectTransferables})(e)&&r.hasValue?s(r,e.selectTransferables(r.value)):s(r)})}(class Te{constructor(){(0,b.Z)(this,"opencvready",new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/5/opencv.js",onRuntimeInitialized(){cv.then(r=>{cv=r,cv.ready.then(()=>{e()}).catch(s=>{console.log(s)})})}},t.importScripts(t.Module.scriptUrl)})),(0,b.Z)(this,"db",void 0),(0,b.Z)(this,"initSqlLite",!1),(0,b.Z)(this,"sqlliteReady",e=>new Promise(e?t=>{const r=self;r.Module={scriptUrl:"content/sqlite/sqlite3.js"},r.importScripts(r.Module.scriptUrl),r.sqlite3InitModule({print:console.log,printErr:console.error}).then(function(s){pe=s,t()}).catch(s=>{console.log(s)})}:t=>{t()}))}reviver(e,t){return"object"==typeof t&&null!==t&&"Map"===t.dataType?new Map(t.value):t}loadImage(e){var t=this;return(0,q.Z)(function*(){const r=JSON.parse(e.value,t.reviver),l=yield(yield fetch(r.pages)).blob(),u=yield createImageBitmap(l),_=new OffscreenCanvas(u.width,u.height).getContext("2d");return _.drawImage(u,0,0),_.getImageData(0,0,u.width,u.height)})()}getScanImage(e,t,r){var s=this;return(0,q.Z)(function*(){if(r)return void 0===s.db&&(s.db=new ze.z),yield s.db.getFirstNonAlignImage(t,e);{let l=we.get(t);return void 0===l&&(l=new Re(t),we.set(t,l)),{examId:t,pageNumber:e,value:l.getFirstNonAlignImage(pe,e)}}})()}workUnit(e){var t=this;return new Ce.y(r=>{this.opencvready.then((0,q.Z)(function*(){!e.indexDb&&!t.initSqlLite&&(yield t.sqlliteReady(!e.indexDb),t.initSqlLite=!0);let s=yield t.getScanImage(e.pageNumber,e.examId,e.indexDb);if(void 0!==s){const l=yield t.loadImage(s);if(s=void 0,e.marker){const u=t.alignImageBasedOnCircle(e.imageA,l,e.widthA,e.heightA,e.preference,e.debug);u.pageNumber=e.pageNumber,r.next(u),r.complete()}else try{const u=t.alignImage(e.imageA,l,e.widthA,e.heightA,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.debug);e.imageA=void 0,u.pageNumber=e.pageNumber,r.next(u),r.complete()}catch(u){console.error(u)}}})).catch(s=>{console.log(s)})})}selectTransferables(e){return void 0!==e.imagesDebugTraces?[e.imageAligned,e.imagesDebugTraces]:[e.imageAligned]}imageDataFromMat(e){const t=e,r=e.type()%8,s=r<=cv.CV_8S?1:r<=cv.CV_32S?1/256:255,l=r===cv.CV_8S||r===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,s,l),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const u=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return e.delete(),u}roi(e,t){const r=e.size().width,s=e.size().height;return t.x+t.width>r&&(t.width=r-t.x),t.y+t.height>s&&(t.height=s-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,r,s,l,u,x,_){const W=new ImageData(new Uint8ClampedArray(e),r,s),f=t,n=cv.matFromImageData(W);let Y=cv.matFromImageData(f),K=Y;if(n.size().width!==Y.size().width||n.size().height!==Y.size().height){K=new cv.Mat;let i=new cv.Size(n.size().width,n.size().height);cv.resize(Y,K,i,0,0,cv.INTER_AREA),Y.delete()}let T=new cv.Mat,y=new cv.Mat;cv.cvtColor(K,T,cv.COLOR_BGRA2GRAY),cv.cvtColor(n,y,cv.COLOR_BGRA2GRAY);const Z=Math.trunc(n.size().width/10);let A=[],U=[],p={},P=!1,N=!1,o=!1,m=!1;const C=Math.min(T.size().width,y.size().width),H=Math.min(T.size().height,y.size().height);if(l){let i=new cv.Rect(0,0,C,H);P=this.matchSmallImage(T,y,A,U,i,u,x),N=!0,o=!0,m=!0}else{let i=Z;for(;!P&&i<3*C/4&&i<2*H/3;){let R=new cv.Rect(0,0,i,i);P=this.matchSmallImage(T,y,A,U,R,u,x),P||(i+=Math.trunc(C/10))}for(i=Z;!N&&i<3*C/4&&i<2*H/3;){let R=new cv.Rect(C-i,0,C,i);N=this.matchSmallImage(T,y,A,U,R,u,x),N||(i+=Math.trunc(C/10))}for(i=Z;!o&&i<3*C/4&&i<2*H/3;){let R=new cv.Rect(0,H-i,i,H);o=this.matchSmallImage(T,y,A,U,R,u,x),o||(i+=Math.trunc(C/10))}for(i=Z;!m&&i<3*C/4&&i<2*H/3;){let R=new cv.Rect(C-i,H-i,C,H);m=this.matchSmallImage(T,y,A,U,R,u,x),m||(i+=Math.trunc(C/10))}}if(P&&N&&o&&m){let i=cv.matFromArray(A.length/2,1,cv.CV_32FC2,A),R=cv.matFromArray(U.length/2,1,cv.CV_32FC2,U),J=cv.findHomography(i,R,cv.RANSAC),S=K;if(cv.warpPerspective(S,S,J,n.size()),_){let D=new cv.MatVector;D.push_back(n),D.push_back(K);let a=new cv.Mat;cv.hconcat(D,a);const k=U.length/2;for(let L=0;L<k;L++){let h={x:U[2*L],y:U[2*L+1]},I={x:n.size().width+A[2*L],y:A[2*L+1]};cv.circle(a,h,5,[0,255,0,255],1),cv.circle(a,I,5,[0,255,0,255],1),cv.line(a,h,I,[0,255,0,255],1)}p.imagesDebugTracesWidth=a.size().width,p.imagesDebugTracesHeight=a.size().height,p.imagesDebugTraces=this.imageDataFromMat(a).data.buffer,D.delete()}p.imageAlignedWidth=S.size().width,p.imageAlignedHeight=S.size().height,p.imageAligned=this.imageDataFromMat(S).data.buffer,i.delete(),R.delete(),J.delete(),t.data.set([])}else{if(_){let i=new cv.MatVector;i.push_back(n),i.push_back(K);let R=new cv.Mat;cv.hconcat(i,R),p.imagesDebugTracesWidth=R.size().width,p.imagesDebugTracesHeight=R.size().height,p.imagesDebugTraces=this.imageDataFromMat(R).data.buffer,i.delete()}p.imageAligned=t.data.buffer,p.imageAlignedWidth=t.width,p.imageAlignedHeight=t.height,K.delete()}return W.data.set([]),n.delete(),T.delete(),y.delete(),p}matchSmallImage(e,t,r,s,l,u,x){let _=new cv.Mat;_=this.roi(e,l);let W=new cv.Mat;W=this.roi(t,l);let f=new cv.KeyPointVector,n=new cv.KeyPointVector,Y=new cv.Mat,K=new cv.Mat,T=new cv.AKAZE,Z=W;T.detectAndCompute(_,_,f,Y),T.detectAndCompute(W,Z,n,K);const A=_.size().width,U=_.size().height;_.delete(),W.delete(),T.delete();let p=new cv.DMatchVector,P=new cv.BFMatcher,N=new cv.DMatchVectorVector;P.knnMatch(Y,K,N,2),Y.delete(),K.delete();for(let a=0;a<N.size();++a){let k=N.get(a),L=k.get(0),h=k.get(1);void 0!==L&&void 0!==h&&L.distance<=h.distance*parseFloat("0.7")&&p.push_back(L)}if(0===p.size())return f.delete(),n.delete(),N.delete(),p.delete(),P.delete(),!1;let o=[],m=[];for(let a=0;a<p.size();a++)o.push(f.get(p.get(a).queryIdx).pt.x+l.x),o.push(f.get(p.get(a).queryIdx).pt.y+l.y),m.push(n.get(p.get(a).trainIdx).pt.x+l.x),m.push(n.get(p.get(a).trainIdx).pt.y+l.y);let C=0,H=[];const i=[];for(let a=0;a<p.size();a++){let k=(o[2*a]-m[2*a])*(o[2*a]-m[2*a])+(o[2*a+1]-m[2*a+1])*(o[2*a+1]-m[2*a+1]);k<Math.trunc(3*A/20)*Math.trunc(3*U/20)&&(H.push(k),C+=1,i.push(a))}const R=this.numAverage(H);let J=this.dev(H);if(J<1&&(J=1),C<=u)return f.delete(),n.delete(),N.delete(),p.delete(),P.delete(),!1;let S=0,D=[];for(let a=0;a<i.length;a++){let k=(o[2*i[a]]-m[2*i[a]])*(o[2*i[a]]-m[2*i[a]])+(o[2*i[a]+1]-m[2*i[a]+1])*(o[2*i[a]+1]-m[2*i[a]+1]);k<=R+1*J&&k>=R-1*J&&(S+=1,D.push(i[a]))}if(S<=x)return f.delete(),n.delete(),N.delete(),p.delete(),P.delete(),!1;{const a=[],k=[];D.forEach(h=>{k.push((o[2*h]-m[2*h])*(o[2*h]-m[2*h])+(o[2*h+1]-m[2*h+1])*(o[2*h+1]-m[2*h+1]))});const L=this.numAverage(k);return D.sort((h,I)=>Math.abs((o[2*h]-m[2*h])*(o[2*h]-m[2*h])+(o[2*h+1]-m[2*h+1])*(o[2*h+1]-m[2*h+1])-L)-Math.abs((o[2*I]-m[2*I])*(o[2*I]-m[2*I])+(o[2*I+1]-m[2*I+1]*(o[2*I+1]-m[2*I+1]))-L)),a.push(D[0]),a.push(D[1]),a.push(D[2]),a.push(D[3]),a.push(D[4]),a.forEach(h=>{r.push(f.get(p.get(+h).queryIdx).pt.x+l.x),r.push(f.get(p.get(+h).queryIdx).pt.y+l.y),s.push(n.get(p.get(+h).trainIdx).pt.x+l.x),s.push(n.get(p.get(+h).trainIdx).pt.y+l.y)}),f.delete(),n.delete(),N.delete(),p.delete(),P.delete(),!0}}numAverage(e){return e.reduce((t,r)=>t+r,0)/e.length}dev(e){let t=e.reduce((s,l)=>s+l,0)/e.length,r=(e=e.map(s=>(s-t)**2)).reduce((s,l)=>s+l,0);return Math.sqrt(r/e.length)}alignImageBasedOnCircle(e,t,r,s,l,u){const x=new ImageData(new Uint8ClampedArray(e),r,s),_=t;let T,y,Z,A,U,p,P,N,o,m,C,H,W=cv.matFromImageData(x),f=new cv.Mat,n=new cv.Mat;cv.cvtColor(W,f,cv.COLOR_RGBA2GRAY),cv.HoughCircles(f,n,cv.HOUGH_GRADIENT,1,45,75,20,f.cols*l.minCircle/1e3,f.cols*l.maxCircle/1e3),n.cols>0&&(T=n.data32F[0],y=n.data32F[1],Z=n.data32F[2],A=n.data32F[0],U=n.data32F[1],p=n.data32F[2],P=n.data32F[0],N=n.data32F[1],o=n.data32F[2],m=n.data32F[0],C=n.data32F[1],H=n.data32F[2]);const i=f.size().width,R=f.size().height;if(n.cols>0)for(let F=1;F<n.cols;F++){let v=n.data32F[3*F],w=n.data32F[3*F+1],ee=n.data32F[3*F+2];v*v+w*w<=T*T+y*y&&(T=v,y=w,Z=ee),v*v+w*w>=m*m+C*C&&(m=v,C=w,H=ee),(i-v)*(i-v)+w*w<=(i-A)*(i-A)+U*U&&(A=v,U=w,p=ee),v*v+(R-w)*(R-w)<=P*P+(R-N)*(R-N)&&(P=v,N=w,o=ee)}let J=cv.matFromImageData(_),S=J;if(S.size().width!==f.size().width||S.size().height!==f.size().height){S=new cv.Mat;let F=new cv.Size(f.size().width,f.size().height);cv.resize(J,S,F,0,0,cv.INTER_AREA),J.delete()}let D=new cv.Mat,a=new cv.Mat;cv.cvtColor(S,D,cv.COLOR_RGBA2GRAY);const k=D.size().width,L=D.size().height;cv.HoughCircles(D,a,cv.HOUGH_GRADIENT,1,45,75,15,o-3,o+3);let h=[],I=[];const Ie=180*(4*o*o-3.14159*o*o)/100;for(let F=0;F<a.cols;F++){let v=a.data32F[3*F],w=a.data32F[3*F+1];const ee=v-o,ie=w-o;let Q=2*o,j=2*o;ee+Q>k&&(Q=k-ee),ie+j>L&&(j=L-ie);let he=new cv.Rect(v-o,w-o,Q,j),O=new cv.Mat,B=new cv.Mat;O=this.roi(D,he),cv.threshold(O,B,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(B)<Ie&&(h.push(v),I.push(w)),B.delete(),O.delete()}let ae,re,se,ne,le,ce,oe,de;if(h.length>0&&(ae=h[0],re=I[0],se=h[0],ne=I[0],le=h[0],ce=I[0],oe=h[0],de=I[0]),h.length>1)for(let F=0;F<h.length;F++){let v=h[F],w=I[F];v*v+w*w<=ae*ae+re*re&&(ae=v,re=w),v*v+w*w>=oe*oe+de*de&&(oe=v,de=w),(k-v)*(k-v)+w*w<=(k-se)*(k-se)+ne*ne&&(se=v,ne=w),v*v+(L-w)*(L-w)<=le*le+(L-ce)*(L-ce)&&(le=v,ce=w)}if(h.length>=4){let F=cv.matFromArray(4,1,cv.CV_32FC2,[T,y,A,U,P,N,m,C]),v=cv.matFromArray(4,1,cv.CV_32FC2,[ae,re,se,ne,le,ce,oe,de]),w=cv.getPerspectiveTransform(v,F),ee=new cv.Size(f.cols,f.rows);for(let j=0;j<F.rows;++j){let B=15,$=new cv.Point(v.data32F[2*j],v.data32F[2*j+1]);cv.circle(S,$,B,[0,0,255,255],1)}let ie=S;cv.warpPerspective(S,ie,w,ee,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let Q={};if(u){let j=new cv.MatVector;j.push_back(W),j.push_back(S);let he=new cv.Size(2*W.size().width,f.size().height),O=new cv.Mat(he,W.type());cv.hconcat(j,O);let B={x:T,y},$={x:f.size().width+ae,y:re};cv.circle(O,B,15,[0,255,0,255],1),cv.circle(O,$,15,[0,255,0,255],1),cv.line(O,B,$,[0,255,0,255],1),B={x:A,y:U},$={x:f.size().width+se,y:ne},cv.circle(O,B,15,[0,255,0,255],1),cv.circle(O,$,15,[0,255,0,255],1),cv.line(O,B,$,[0,255,0,255],1),B={x:P,y:N},$={x:f.size().width+le,y:ce},cv.circle(O,B,15,[0,255,0,255],1),cv.circle(O,$,15,[0,255,0,255],1),cv.line(O,B,$,[0,255,0,255],1),B={x:m,y:C},$={x:f.size().width+oe,y:de},cv.circle(O,B,15,[0,255,0,255],1),cv.circle(O,$,15,[0,255,0,255],1),cv.line(O,B,$,[0,255,0,255],1),Q.imagesDebugTracesWidth=O.size().width,Q.imagesDebugTracesHeight=O.size().height,Q.imagesDebugTraces=this.imageDataFromMat(O).data.buffer,j.delete()}return Q.imageAlignedWidth=ie.size().width,Q.imageAlignedHeight=ie.size().height,Q.imageAligned=this.imageDataFromMat(ie).data.buffer,W.delete(),f.delete(),n.delete(),D.delete(),a.delete(),F.delete(),v.delete(),w.delete(),Q}return W.delete(),f.delete(),n.delete(),D.delete(),S.delete(),a.delete(),this.alignImage(e,t,r,s,!1,l.numberofpointToMatch,l.numberofgoodpointToMatch,u)}})},9940:(c,z,d)=>{d.d(z,{yG:()=>G});var q=d(671);function G(M){return(0,q.K)(function b(M){return M[M.length-1]}(M))?M.pop():void 0}},9360:(c,z,d)=>{d.d(z,{e:()=>E});var q=d(4674);function E(G){return X=>{if(function b(G){return(0,q.m)(G?.lift)}(X))return X.lift(function(M){try{return G(M,this)}catch(te){this.error(te)}});throw new TypeError("Unable to lift unknown Observable type")}}}},ue={};function g(c){var z=ue[c];if(void 0!==z)return z.exports;var d=ue[c]={exports:{}};return me[c](d,d.exports,g),d.exports}g.m=me,g.x=()=>{var c=g.O(void 0,[173,330,592],()=>g(8459));return g.O(c)},c=[],g.O=(z,d,q,b)=>{if(!d){var G=1/0;for(E=0;E<c.length;E++){for(var[d,q,b]=c[E],X=!0,M=0;M<d.length;M++)(!1&b||G>=b)&&Object.keys(g.O).every(ge=>g.O[ge](d[M]))?d.splice(M--,1):(X=!1,b<G&&(G=b));if(X){c.splice(E--,1);var te=q();void 0!==te&&(z=te)}}return z}b=b||0;for(var E=c.length;E>0&&c[E-1][2]>b;E--)c[E]=c[E-1];c[E]=[d,q,b]},g.d=(c,z)=>{for(var d in z)g.o(z,d)&&!g.o(c,d)&&Object.defineProperty(c,d,{enumerable:!0,get:z[d]})},g.f={},g.e=c=>Promise.all(Object.keys(g.f).reduce((z,d)=>(g.f[d](c,z),z),[])),g.u=c=>(592===c?"common":c)+"."+{173:"d892aa9086209a1c",330:"c23ea5e35e0e42fc",592:"c39a7728a241b176"}[c]+".js",g.miniCssF=c=>{},g.o=(c,z)=>Object.prototype.hasOwnProperty.call(c,z),g.j=805,(()=>{var c;g.tt=()=>(void 0===c&&(c={createScriptURL:z=>z},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(c=trustedTypes.createPolicy("angular#bundler",c))),c)})(),g.tu=c=>g.tt().createScriptURL(c),g.p="",(()=>{var c={805:1};g.f.i=(b,E)=>{c[b]||importScripts(g.tu(g.p+g.u(b)))};var d=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],q=d.push.bind(d);d.push=b=>{var[E,G,X]=b;for(var M in G)g.o(G,M)&&(g.m[M]=G[M]);for(X&&X(g);E.length;)c[E.pop()]=1;q(b)}})(),(()=>{var c=g.x;g.x=()=>Promise.all([173,330,592].map(g.e,g)).then(c)})(),g.x()})();