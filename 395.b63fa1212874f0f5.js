(()=>{"use strict";class J{constructor(e){e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(n=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),n()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const r=e.width>e.height,c=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),a=r?[[c,c],[0,0],[0,0]]:[[0,0],[c,c],[0,0]];return tf.tidy(()=>{let i=tf.browser.fromPixels(e,1).pad(a,255);return i=tf.image.resizeBilinear(i,[24,24]).pad([[2,2],[2,2],[0,0]],255),i=tf.scalar(1).sub(i.toFloat().div(tf.scalar(255))),i.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const n=this.preprocessImage(e),o=this._model.predict(n).as1D(),l=o.argMax().dataSync()[0],r=o.max().dataSync()[0];return[this.characters[l],r]}}function x(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function g(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function K(t,e,n){let o=new cv.Mat;const l=new cv.Rect(e.x,e.y,n.w-2,n.h-2);return o=t.roi(l),o}function fe(t){const e=.0145*cv.arcLength(t,!0),n=new cv.Mat;let o;cv.approxPolyDP(t,n,e,!0);const l=x(n);if(l.w>=10&&l.h>=10){const r=n.rows;if(1===r)o="LIGNE";else if(3===r)o="TRIANGLE";else if(4===r){const c=l.w/l.h;o=c>=.95&&c<=1.05?"CARRE":"RECTANGLE"}else o=void 0}return{nom:o,forme:n}}function me(t,e){let n=g(t),o=g(e);return n.y<o.y?-1:n.y>o.y?1:n.x-o.x}function ee(t,e){let n=g(t),o=g(e),l=x(t),r=x(e);return(o.x>=n.x&&o.x<=n.x+l.w||o.x+r.w>=n.x&&o.x+r.w<=n.x+l.w)&&(o.y>=n.y&&o.y<=n.y+l.h||o.y+r.h>=n.y&&o.y+r.h<=n.y+l.h)}function te(t){const e=function ge(t,e=[]){const n=new cv.Mat;cv.threshold(t,n,240,255,cv.THRESH_BINARY);let o=new cv.MatVector,l=new cv.Mat;cv.findContours(n,o,l,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const r=[];for(let i=0;i<o.size();++i){const w=fe(o.get(i));e.includes(w.nom)&&r.push(w.forme)}r.sort(me);const c=[],a=[];return r.forEach((i,s)=>{!function pe(t,e){let n=e[t],o=!1;return e.forEach((l,r)=>{t<r&&function we(t,e){return ee(t,e)||ee(e,t)}(n,l)&&(o=!0)}),o}(s,r)?c.push(i):a.push(i)}),a.forEach(i=>{i.delete()}),c}(t,["CARRE","RECTANGLE"]),n=[],o=[];return e.forEach(l=>{const r=x(l),c=g(l);n.push(l),o.push(K(t,c,r))}),{cases:n,img_cases:o}}function ne(t,e,n=new cv.Scalar(255,0,0,128),o=2){return e.forEach(l=>{const r=g(l),c=x(l);c.h=c.h-2,c.w=c.w-2;let a=new cv.Point(r.x,r.y),i=new cv.Point(r.x+c.w,r.y+c.h);cv.rectangle(t,a,i,n,o,0)}),t}let G,U;function oe(t,e){let n=cv.matFromImageData(t.payload.image);const o=function xe(t){return t?(void 0===G&&(G=new J(t)),G):(void 0===U&&(U=new J(t)),U)}(e);o.isWarmedUp.then(()=>{const l=function Se(t,e,n,o,l){const r=function Ae(t,e,n){let s=t.clone(),w=new cv.Mat;cv.cvtColor(t,w,cv.COLOR_BGR2GRAY,0);let _=new cv.Mat;cv.threshold(w,_,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let O=new cv.Point(-1,-1);if(e){let d=new cv.Mat,R=new cv.Size(1,15),m=cv.getStructuringElement(cv.MORPH_RECT,R);cv.morphologyEx(_,d,cv.MORPH_OPEN,m,O,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let y=new cv.MatVector,u=new cv.Mat;cv.findContours(d,y,u,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let E=new cv.Scalar(255,255,255);cv.drawContours(s,y,-1,E,4);let C=new cv.Mat,h=new cv.Size(15,1),f=cv.getStructuringElement(cv.MORPH_RECT,h),Z=new cv.Point(-1,-1);cv.morphologyEx(_,C,cv.MORPH_OPEN,f,Z,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let L=new cv.MatVector,H=new cv.Mat;cv.findContours(C,L,H,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let D=new cv.Scalar(255,255,255);cv.drawContours(s,L,-1,D,4),d.delete(),y.delete(),u.delete(),m.delete(),C.delete(),L.delete(),H.delete(),f.delete()}let S=new cv.Size(3,3),N=cv.getStructuringElement(cv.MORPH_ELLIPSE,S),T=new cv.Mat,p=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);p.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(p,p,cv.COLOR_BGR2GRAY,0);let z=new cv.Mat;cv.cvtColor(s,z,cv.COLOR_BGR2GRAY,0);let Y=new cv.Mat;cv.subtract(p,z,Y,T,-1);let X=new cv.Mat;cv.dilate(Y,X,N,O,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let W=new cv.Mat,q=new cv.Mat;cv.bitwise_and(X,_,W),cv.morphologyEx(W,q,cv.MORPH_CLOSE,N,O,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let P=new cv.Mat;cv.bitwise_and(q,_,P);let A=new cv.Mat;cv.subtract(p,P,A,T,-1);let I=new cv.MatVector,le=new cv.Mat;cv.findContours(P,I,le,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const k=new Map;let M=[];for(let d=0;d<I.size();d++){let R=I.get(d),m=cv.boundingRect(R);(m.width>12||m.height>12)&&M.push(m)}let B=ce(M),Q=0;for(;null!==B&&Q<200;)M=M.filter(d=>d!==B.toRemove1&&d!==B.toRemove2),M.push(B.u),B=ce(M),Q+=1;M.forEach(d=>{let R=new cv.Scalar(0,0,0),m=new cv.Point(d.x,d.y),y=new cv.Point(d.x+d.width,d.y+d.height),u=new cv.Mat,E=new cv.Mat,C=new cv.Mat,h=new cv.Scalar(255,0,0,255);u=j(A,d),d.width>d.height?cv.copyMakeBorder(u,u,(d.width-d.height)/2,(d.width-d.height)/2,1,1,cv.BORDER_CONSTANT,h):cv.copyMakeBorder(u,u,1,1,(d.height-d.width)/2,(d.height-d.width)/2,cv.BORDER_CONSTANT,h);let f=new cv.Size(26,26);cv.resize(u,E,f,0,0,cv.INTER_AREA),cv.copyMakeBorder(E,C,1,1,1,1,cv.BORDER_CONSTANT,h),k.set(d,C),u.delete(),E.delete(),cv.rectangle(A,m,y,R,2,cv.LINE_AA,0)}),w.delete(),_.delete(),N.delete(),T.delete(),p.delete(),z.delete(),Y.delete(),X.delete(),s.delete(),W.delete(),q.delete(),P.delete(),I.delete(),le.delete();let v=[...k];if(v.sort((d,R)=>d[0].x<R[0].x?-1:1),n&&v.length>3){const d=(v[v.length-1][0].x-v[0][0].x)/v.length;let R=d,m=0,y=0,u=800;const E=[];for(let h=0;h<v.length-1;h++){let f=v[h+1][0].x-v[h][0].x;f<R&&(R=f),f>1.7*d&&E.push(h),v[h][0].y<u&&(u=v[h][0].y),v[h][0].height>m&&(m=v[h][0].height),v[h][0].width>y&&(y=v[h][0].width)}const C=(v[v.length-1][0].x-v[0][0].x)/(v.length+E.length);E.forEach(h=>{let f=v[h][0].x+C,Z=new cv.Scalar(0,0,0),L=new cv.Point(f,u),H=new cv.Point(f+y,u+m),D=new cv.Rect(f,u,y,m),V=new cv.Mat,$=new cv.Mat,ie=new cv.Mat;V=j(A,D);let Ne=new cv.Size(26,26);cv.resize(V,$,Ne,0,0,cv.INTER_AREA);let Te=new cv.Scalar(255,0,0,255);cv.copyMakeBorder($,ie,1,1,1,1,cv.BORDER_CONSTANT,Te),k.set(D,ie),V.delete(),$.delete(),cv.rectangle(A,L,H,Z,2,cv.LINE_AA,0)}),v=[...k],v.sort((h,f)=>h[0].x<f[0].x?-1:1)}return{letter:v,invert_final:A}}(t,!1,o);let c=[];e.forEach(i=>{c.push([i.padEnd(13," "),0])});const a=[];for(let i=0;i<r.letter.length;i++){let s=n.predict(F(r.letter[i][1]));l&&("1"===s[0]&&(s[0]="i"),"0"===s[0]&&(s[0]="o"),"5"===s[0]&&(s[0]="s"),"3"===s[0]&&(s[0]="b"),"9"===s[0]&&(s[0]="g")),a.push(s)}for(let i=0;i<c.length;i++){for(let s=0;s<13;s++)s<a.length&&(c[i][1]=c[i][0].substring(s,s+1).toLowerCase()===a[s][0].toLowerCase()?c[i][1]+a[s][1]:l?c[i][1]+(1-a[s][1])/35:c[i][1]+(1-a[s][1])/9);c[i][1]=c[i][1]/a.length}for(let i=0;i<c.length;i++)c[i][0]=c[i][0].trim(),c[i][1]=c[i][1]-Math.abs(c[i][0].length-a.length)/c[i][0].length;return c.sort((i,s)=>i[1]<s[1]?1:-1),{debug:r.invert_final,solution:c[0]}}(n,t.payload.match,o,!0,e);postMessage({msg:t.msg,payload:{debug:F(l.debug),solution:l.solution},uid:t.uid}),l.debug.delete(),n.delete()})}function F(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,l=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,l),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const r=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),r}function j(t,e,n){const o=t.size().width,l=t.size().height;return e.x+e.width>o&&(e.width=o-e.x),e.y+e.height>l&&(e.height=l-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function Oe(t,e){let n=e,o=t,l=t,r=e;t.x>e.x&&(n=t,o=e),t.y>e.y&&(l=e,r=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let c=e,a=t,i=e,s=t;return t.right>e.right&&(c=t,a=e),t.bottom>e.bottom&&(i=t,s=e),n.x<o.right&&r.y>l.y+l.height?new cv.Rect(o.x,s.y,c.right-o.x,i.bottom-l.y):n.x>o.x+o.width+5||r.y>l.y+l.height?null:new cv.Rect(o.x,s.y,c.right-o.x,i.bottom-l.y)}function ce(t){for(let e=0;e<t.length-1;e++){const n=t[e];for(let o=e+1;o<t.length;o++){const l=t[o],r=Oe(n,l);if(null!==r)return{u:r,toRemove1:n,toRemove2:l}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(n=>{cv=n,n.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function Me(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),n=new cv.Mat,o=cv.matFromImageData(t.payload.image);n=j(o,e),postMessage({msg:t.msg,payload:F(n),uid:t.uid}),n.delete(),o.delete()}(t.data);case"nameprediction":return oe(t.data,!0);case"ineprediction":return oe(t.data,!1);case"qcmresolution":return function se(t){var e;const n={solutions:[]};let o=cv.matFromImageData(t.payload.imageTemplate),l=new cv.Mat;cv.cvtColor(o,l,cv.COLOR_RGBA2GRAY,0);const r=te(l);null===(e=t.payload.pages)||void 0===e||e.forEach((c,a)=>{var i;let s=new cv.Mat,w=cv.matFromImageData(c.imageInput);cv.cvtColor(w,s,cv.COLOR_RGBA2GRAY,0);const _=te(s),O=function Re(t,e){const n=[];return t.cases.forEach(o=>{let r,l=500;if(e.cases.forEach(c=>{const a=function Ee(t,e){const n=cv.boundingRect(t),o=cv.boundingRect(e);let l=n.x+n.width/2,r=n.y+n.height/2,c=o.x+o.width/2,a=o.y+o.height/2;return Math.sqrt((l-c)*(l-c)+(r-a)*(r-a))}(o,c);l>a&&a<25&&(l=a,r=c)}),void 0!==r){let c=g(o),a=g(r);n.push({x:c.x-a.x,y:c.y-a.y})}}),function ue(t){if(t.length>0){let e=0,n=0;return t.forEach(o=>{e+=o.x,n+=o.y}),{x:e/t.length,y:n/t.length}}return{x:0,y:0}}(n)}(_,r),S=function ye(t,e){let n=new cv.Mat;if(0!==e.x||0!==e.y){let o=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),l=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,n,o,l,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),n}return t}(w,O);let N=function _e(t,e,n){const o=[],l=[];let r=new Map;return t.cases.forEach((c,a)=>{const i=K(n,g(c),x(c)),s=function Ce(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let n=new cv.Mat;return cv.threshold(e,n,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(n)/(t.rows*t.cols)}(i);s>.22?(r.set(a,{verdict:!0,prediction:s}),o.push(c)):(r.set(a,{verdict:!1,prediction:s}),l.push(c)),s>.16&&s<.25?cv.putText(n,""+s.toFixed(2),{x:g(c).x,y:g(c).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(n,""+s.toFixed(2),{x:g(c).x,y:g(c).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),i.delete()}),ne(n,o,new cv.Scalar(0,255,0,128)),ne(n,l,new cv.Scalar(0,0,255,128)),r}(r,0,S),T=function re(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,l=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,l),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const r=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),r}(S),b=[];N.forEach((p,z)=>{p.verdict&&b.push(String.fromCharCode(97+z))}),null===(i=n.solutions)||void 0===i||i.push({imageSolution:T,numero:a,solution:b.join("&")}),s.delete(),w.delete(),S!==w&&S.delete(),_.cases.forEach(p=>p.delete()),_.img_cases.forEach(p=>p.delete())}),o.delete(),l.delete(),r.cases.forEach(c=>c.delete()),r.img_cases.forEach(c=>c.delete()),postMessage({msg:t.msg,payload:n,uid:t.uid})}(t.data)}})})();