(()=>{"use strict";var l,xe={4681:(l,x,s)=>{var U=s(4942),M=s(5e3),b=s(2076),g=s(4968),J=s(4004),A=s(9300),Q=s(971),G=s(4351),d=s(4469);var Re=s(9751);!function le(L){const e=new L,r=(0,g.R)(self,"message");return function he(L,e){const r=e.pipe((0,J.U)(i=>i.data),(0,J.U)(i=>new M.P_(i.kind,i.value,i.error)),(0,A.h)(i=>"C"!==i.kind),(0,Q.D)());return function Ae(L){return!!L.workUnit}(L)?r.pipe((0,G.b)(i=>(0,b.D)(L.workUnit(i)).pipe((0,d.i)()))):L.work(r).pipe((0,d.i)())}(e,r).subscribe(i=>{const v=postMessage;(function z(L){return!!L.selectTransferables})(e)&&i.hasValue?v(i,e.selectTransferables(i.value)):v(i)})}(class Fe{constructor(){(0,U.Z)(this,"opencvready",new Promise(e=>{const r=self;r.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(i=>{cv=i,cv.ready.then(()=>{e()}).catch(v=>{console.log(v)})})}},r.importScripts(r.Module.scriptUrl)}))}workUnit(e){return new Re.y(r=>{this.opencvready.then(()=>{if(console.error("start worker"),e.marker){const i=this.alignImageBasedOnCircle(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,e.pageNumber,e.preference,e.debug);i.pageNumber=e.pageNumber,r.next(i),r.complete()}else try{const i=this.alignImage(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.pageNumber,e.debug);e.imageA=void 0,e.imageB=void 0,i.pageNumber=e.pageNumber,r.next(i),r.complete()}catch(i){console.error(i)}}).catch(i=>{console.log(i)})})}selectTransferables(e){return void 0!==e.imagesDebugTraces?[e.imageAligned,e.imagesDebugTraces]:[e.imageAligned]}imageDataFromMat(e){const r=new cv.Mat,i=e.type()%8,v=i<=cv.CV_8S?1:i<=cv.CV_32S?1/256:255,u=i===cv.CV_8S||i===cv.CV_16S?128:0;switch(e.convertTo(r,cv.CV_8U,v,u),r.type()){case cv.CV_8UC1:cv.cvtColor(r,r,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(r,r,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const N=new ImageData(new Uint8ClampedArray(r.data),r.cols,r.rows);return r.delete(),N}roi(e,r){const i=e.size().width,v=e.size().height;return r.x+r.width>i&&(r.width=i-r.x),r.y+r.height>v&&(r.height=v-r.y),r.x<0&&(r.x=0),r.y<0&&(r.y=0),e.roi(r)}alignImage(e,r,i,v,u,N,B,I,ie,P,$){const T=new ImageData(new Uint8ClampedArray(e),i,v),_=new ImageData(new Uint8ClampedArray(r),u,N),D=cv.matFromImageData(T);let n=cv.matFromImageData(_),E=new cv.Mat,j=new cv.Size(D.size().width,D.size().height);cv.resize(n,E,j,0,0,cv.INTER_AREA);let k=new cv.Mat,m=new cv.Mat;cv.cvtColor(E,k,cv.COLOR_BGRA2GRAY),cv.cvtColor(D,m,cv.COLOR_BGRA2GRAY);const X=Math.trunc(D.size().width/20);let F=[],c=[],o={},K=!1,Y=!1,p=!1,Z=!1;const R=Math.min(k.size().width,m.size().width),H=Math.min(k.size().height,m.size().height);if(B){let a=new cv.Rect(0,0,R,H);K=this.matchSmallImage(k,m,F,c,a,1,I,ie,P),Y=!0,p=!0,Z=!0}else{let a=X;for(;!K&&a<3*R/4&&a<2*H/3;){let t=new cv.Rect(0,0,a,a);K=this.matchSmallImage(k,m,F,c,t,1,I,ie,P),K||(a+=Math.trunc(R/10))}for(a=X;!Y&&a<3*R/4&&a<2*H/3;){let t=new cv.Rect(R-a,0,R,a);Y=this.matchSmallImage(k,m,F,c,t,2,I,ie,P),Y||(a+=Math.trunc(R/10))}for(a=X;!p&&a<3*R/4&&a<2*H/3;){let t=new cv.Rect(0,H-a,a,H);p=this.matchSmallImage(k,m,F,c,t,3,I,ie,P),p||(a+=Math.trunc(R/10))}for(a=X;!Z&&a<3*R/4&&a<2*H/3;){let t=new cv.Rect(R-a,H-a,R,H);Z=this.matchSmallImage(k,m,F,c,t,4,I,ie,P),Z||(a+=Math.trunc(R/10))}}if(K&&Y&&p&&Z){let a=cv.matFromArray(F.length/2,1,cv.CV_32FC2,F),t=cv.matFromArray(c.length/2,1,cv.CV_32FC2,c),V=cv.findHomography(a,t,cv.RANSAC),S=new cv.Mat;if(cv.warpPerspective(E,S,V,D.size()),o.imageAligned=this.imageDataFromMat(S).data.buffer,o.imageAlignedWidth=S.size().width,o.imageAlignedHeight=S.size().height,$){let y=new cv.MatVector;y.push_back(D),y.push_back(E);let C=new cv.Mat;cv.hconcat(y,C);const oe=c.length/2;for(let q=0;q<oe;q++){let ne={x:c[2*q],y:c[2*q+1]},ee={x:D.size().width+F[2*q],y:F[2*q+1]};cv.circle(C,ne,5,[0,255,0,255],1),cv.circle(C,ee,5,[0,255,0,255],1),cv.line(C,ne,ee,[0,255,0,255],1)}o.imagesDebugTraces=this.imageDataFromMat(C).data.buffer,o.imagesDebugTracesWidth=C.size().width,o.imagesDebugTracesHeight=C.size().height}a.delete(),t.delete(),V.delete(),S.delete(),console.log("Good match for page "+P)}else{if(o.imageAligned=r.slice(0),o.imageAlignedWidth=u,o.imageAlignedHeight=N,$){let a=new cv.MatVector;a.push_back(D),a.push_back(E);let t=new cv.Mat;cv.hconcat(a,t),o.imagesDebugTraces=this.imageDataFromMat(t).data.buffer,o.imagesDebugTracesWidth=t.size().width,o.imagesDebugTracesHeight=t.size().height}console.log("no match for page "+P)}return n.delete(),E.delete(),D.delete(),k.delete(),m.delete(),o}matchSmallImage(e,r,i,v,u,N,B,I,ie){let P=new cv.Mat;P=this.roi(e,u);let $=new cv.Mat;$=this.roi(r,u);let T=new cv.KeyPointVector,_=new cv.KeyPointVector,D=new cv.Mat,n=new cv.Mat,E=new cv.AKAZE,j=new cv.Mat,k=new cv.Mat;E.detectAndCompute(P,j,T,D),E.detectAndCompute($,k,_,n);let m=new cv.DMatchVector,X=new cv.BFMatcher,F=new cv.DMatchVectorVector;X.knnMatch(D,n,F,2);for(let t=0;t<F.size();++t){let V=F.get(t),S=V.get(0),y=V.get(1);void 0!==S&&void 0!==y&&S.distance<=y.distance*parseFloat("0.7")&&m.push_back(S)}let c=[],o=[];for(let t=0;t<m.size();t++)c.push(T.get(m.get(t).queryIdx).pt.x+u.x),c.push(T.get(m.get(t).queryIdx).pt.y+u.y),o.push(_.get(m.get(t).trainIdx).pt.x+u.x),o.push(_.get(m.get(t).trainIdx).pt.y+u.y);let K=0,Y=[];if(0===m.size())return E.delete(),T.delete(),_.delete(),D.delete(),n.delete(),j.delete(),k.delete(),P.delete(),$.delete(),F.delete(),m.delete(),X.delete(),!1;const p=[];for(let t=0;t<m.size();t++){let V=(c[2*t]-o[2*t])*(c[2*t]-o[2*t])+(c[2*t+1]-o[2*t+1])*(c[2*t+1]-o[2*t+1]);V<Math.trunc(3*P.size().width/20)*Math.trunc(3*P.size().height/20)&&(Y.push(V),K+=1,p.push(t))}const Z=this.numAverage(Y);let R=this.dev(Y);if(R<1&&(R=1),K<=B)return E.delete(),T.delete(),_.delete(),D.delete(),n.delete(),j.delete(),k.delete(),P.delete(),$.delete(),F.delete(),m.delete(),X.delete(),!1;let H=0,a=[];for(let t=0;t<p.length;t++){let V=(c[2*p[t]]-o[2*p[t]])*(c[2*p[t]]-o[2*p[t]])+(c[2*p[t]+1]-o[2*p[t]+1])*(c[2*p[t]+1]-o[2*p[t]+1]);V<=Z+1*R&&V>=Z-1*R&&(H+=1,a.push(p[t]))}if(console.error("first realgoodmatchtokeep",H,I),H<=I)return E.delete(),T.delete(),_.delete(),D.delete(),n.delete(),j.delete(),k.delete(),P.delete(),$.delete(),F.delete(),m.delete(),X.delete(),!1;{let t=[];const V=[];a.forEach(y=>{V.push((c[2*y]-o[2*y])*(c[2*y]-o[2*y])+(c[2*y+1]-o[2*y+1])*(c[2*y+1]-o[2*y+1]))});const S=this.numAverage(V);return a.sort((y,C)=>Math.abs((c[2*y]-o[2*y])*(c[2*y]-o[2*y])+(c[2*y+1]-o[2*y+1])*(c[2*y+1]-o[2*y+1])-S)-Math.abs((c[2*C]-o[2*C])*(c[2*C]-o[2*C])+(c[2*C+1]-o[2*C+1]*(c[2*C+1]-o[2*C+1]))-S)),t.push(a[0]),t.push(a[1]),t.push(a[2]),t.push(a[3]),t.push(a[4]),console.error("last realgoodmatchtokeep",t.length,I),t.forEach(y=>{i.push(T.get(m.get(+y).queryIdx).pt.x+u.x),i.push(T.get(m.get(+y).queryIdx).pt.y+u.y),v.push(_.get(m.get(+y).trainIdx).pt.x+u.x),v.push(_.get(m.get(+y).trainIdx).pt.y+u.y)}),E.delete(),T.delete(),_.delete(),D.delete(),n.delete(),j.delete(),k.delete(),P.delete(),$.delete(),F.delete(),m.delete(),X.delete(),!0}}numAverage(e){return e.reduce((r,i)=>r+i,0)/e.length}dev(e){let r=e.reduce((v,u)=>v+u,0)/e.length,i=(e=e.map(v=>(v-r)**2)).reduce((v,u)=>v+u,0);return Math.sqrt(i/e.length)}alignImageBasedOnCircle(e,r,i,v,u,N,B,I,ie){const P=new ImageData(new Uint8ClampedArray(e),i,v),$=new ImageData(new Uint8ClampedArray(r),u,N);let k,m,X,F,c,o,K,Y,p,Z,R,H,T=cv.matFromImageData(P),_=new cv.Mat,D=new cv.Mat,n=new cv.Mat;cv.cvtColor(T,_,cv.COLOR_RGBA2GRAY),cv.HoughCircles(_,n,cv.HOUGH_GRADIENT,1,45,75,20,_.cols*I.minCircle/1e3,_.cols*I.maxCircle/1e3),n.cols>0&&(k=n.data32F[0],m=n.data32F[1],X=n.data32F[2],F=n.data32F[0],c=n.data32F[1],o=n.data32F[2],K=n.data32F[0],Y=n.data32F[1],p=n.data32F[2],Z=n.data32F[0],R=n.data32F[1],H=n.data32F[2]);const a=_.size().width,t=_.size().height;if(n.cols>0)for(let W=1;W<n.cols;W++){let f=n.data32F[3*W],w=n.data32F[3*W+1],ce=n.data32F[3*W+2];f*f+w*w<=k*k+m*m&&(k=f,m=w,X=ce),f*f+w*w>=Z*Z+R*R&&(Z=f,R=w,H=ce),(a-f)*(a-f)+w*w<=(a-F)*(a-F)+c*c&&(F=f,c=w,o=ce),f*f+(t-w)*(t-w)<=K*K+(t-Y)*(t-Y)&&(K=f,Y=w,p=ce)}let V=cv.matFromImageData($),S=new cv.Mat,y=new cv.Size(_.size().width,_.size().height);cv.resize(V,S,y,0,0,cv.INTER_AREA);let C=new cv.Mat,oe=new cv.Mat;cv.cvtColor(S,C,cv.COLOR_RGBA2GRAY);const q=C.size().width,ne=C.size().height;cv.HoughCircles(C,oe,cv.HOUGH_GRADIENT,1,45,75,15,p-3,p+3);let ee=[],ue=[];const Oe=180*(4*p*p-3.14159*p*p)/100;for(let W=0;W<oe.cols;W++){let f=oe.data32F[3*W],w=oe.data32F[3*W+1];const ce=f-p,de=w-p;let se=2*p,ae=2*p;ce+se>q&&(se=q-ce),de+ae>ne&&(ae=ne-de);let Me=new cv.Rect(f-p,w-p,se,ae),O=new cv.Mat;O=this.roi(C,Me),cv.threshold(O,O,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(O)<Oe&&(ee.push(f),ue.push(w)),O.delete()}let fe,ge,me,ve,pe,ye,we,_e;if(ee.length>0&&(fe=ee[0],ge=ue[0],me=ee[0],ve=ue[0],pe=ee[0],ye=ue[0],we=ee[0],_e=ue[0]),ee.length>1)for(let W=0;W<ee.length;W++){let f=ee[W],w=ue[W];f*f+w*w<=fe*fe+ge*ge&&(fe=f,ge=w),f*f+w*w>=we*we+_e*_e&&(we=f,_e=w),(q-f)*(q-f)+w*w<=(q-me)*(q-me)+ve*ve&&(me=f,ve=w),f*f+(ne-w)*(ne-w)<=pe*pe+(ne-ye)*(ne-ye)&&(pe=f,ye=w)}if(ee.length>=4){let W=cv.matFromArray(4,1,cv.CV_32FC2,[k,m,F,c,K,Y,Z,R]),f=cv.matFromArray(4,1,cv.CV_32FC2,[fe,ge,me,ve,pe,ye,we,_e]),w=cv.getPerspectiveTransform(f,W),ce=new cv.Size(_.cols,_.rows);for(let ae=0;ae<W.rows;++ae){let te=15,re=new cv.Point(f.data32F[2*ae],f.data32F[2*ae+1]);cv.circle(S,re,te,[0,0,255,255],1)}cv.warpPerspective(S,D,w,ce,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let de=D.clone(),se={};if(se.imageAligned=this.imageDataFromMat(de).data.buffer,se.imageAlignedWidth=de.size().width,se.imageAlignedHeight=de.size().height,ie){let ae=new cv.MatVector;ae.push_back(T),ae.push_back(S);let Me=new cv.Size(2*T.size().width,_.size().height),O=new cv.Mat(Me,T.type());cv.hconcat(ae,O);let te={x:k,y:m},re={x:_.size().width+fe,y:ge};cv.circle(O,te,15,[0,255,0,255],1),cv.circle(O,re,15,[0,255,0,255],1),cv.line(O,te,re,[0,255,0,255],1),te={x:F,y:c},re={x:_.size().width+me,y:ve},cv.circle(O,te,15,[0,255,0,255],1),cv.circle(O,re,15,[0,255,0,255],1),cv.line(O,te,re,[0,255,0,255],1),te={x:K,y:Y},re={x:_.size().width+pe,y:ye},cv.circle(O,te,15,[0,255,0,255],1),cv.circle(O,re,15,[0,255,0,255],1),cv.line(O,te,re,[0,255,0,255],1),te={x:Z,y:R},re={x:_.size().width+we,y:_e},cv.circle(O,te,15,[0,255,0,255],1),cv.circle(O,re,15,[0,255,0,255],1),cv.line(O,te,re,[0,255,0,255],1),se.imagesDebugTraces=this.imageDataFromMat(O).data.buffer,se.imagesDebugTracesWidth=O.size().width,se.imagesDebugTracesHeight=O.size().height}return T.delete(),_.delete(),D.delete(),n.delete(),C.delete(),S.delete(),V.delete(),oe.delete(),W.delete(),f.delete(),de.delete(),console.error("find circle"),se}return T.delete(),_.delete(),D.delete(),n.delete(),C.delete(),S.delete(),V.delete(),oe.delete(),console.error("cannot find circle"),this.alignImage(e,r,i,v,u,N,!1,I.numberofpointToMatch,I.numberofgoodpointToMatch,B,ie)}})},6921:(l,x,s)=>{s.d(x,{Nn:()=>A,w0:()=>g});var U=s(576),M=s(7896),b=s(8737);class g{constructor(d){this.initialTeardown=d,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let d;if(!this.closed){this.closed=!0;const{_parentage:z}=this;if(z)if(this._parentage=null,Array.isArray(z))for(const le of z)le.remove(this);else z.remove(this);const{initialTeardown:Ae}=this;if((0,U.m)(Ae))try{Ae()}catch(le){d=le instanceof M.B?le.errors:[le]}const{_finalizers:he}=this;if(he){this._finalizers=null;for(const le of he)try{Q(le)}catch(Ce){d=d??[],Ce instanceof M.B?d=[...d,...Ce.errors]:d.push(Ce)}}if(d)throw new M.B(d)}}add(d){var z;if(d&&d!==this)if(this.closed)Q(d);else{if(d instanceof g){if(d.closed||d._hasParent(this))return;d._addParent(this)}(this._finalizers=null!==(z=this._finalizers)&&void 0!==z?z:[]).push(d)}}_hasParent(d){const{_parentage:z}=this;return z===d||Array.isArray(z)&&z.includes(d)}_addParent(d){const{_parentage:z}=this;this._parentage=Array.isArray(z)?(z.push(d),z):z?[z,d]:d}_removeParent(d){const{_parentage:z}=this;z===d?this._parentage=null:Array.isArray(z)&&(0,b.P)(z,d)}remove(d){const{_finalizers:z}=this;z&&(0,b.P)(z,d),d instanceof g&&d._removeParent(this)}}function A(G){return G instanceof g||G&&"closed"in G&&(0,U.m)(G.remove)&&(0,U.m)(G.add)&&(0,U.m)(G.unsubscribe)}function Q(G){(0,U.m)(G)?G():G.unsubscribe()}g.EMPTY=(()=>{const G=new g;return G.closed=!0,G})()},3269:(l,x,s)=>{s.d(x,{yG:()=>g});var U=s(3532);function g(A){return(0,U.K)(function M(A){return A[A.length-1]}(A))?A.pop():void 0}},4482:(l,x,s)=>{s.d(x,{e:()=>b});var U=s(576);function b(g){return J=>{if(function M(g){return(0,U.m)(g?.lift)}(J))return J.lift(function(A){try{return g(A,this)}catch(Q){this.error(Q)}});throw new TypeError("Unable to lift unknown Observable type")}}},9635:(l,x,s)=>{s.d(x,{U:()=>b});var U=s(4671);function b(g){return 0===g.length?U.y:1===g.length?g[0]:function(A){return g.reduce((Q,G)=>G(Q),A)}}}},ze={};function h(l){var x=ze[l];if(void 0!==x)return x.exports;var s=ze[l]={exports:{}};return xe[l](s,s.exports,h),s.exports}h.m=xe,h.x=()=>{var l=h.O(void 0,[696],()=>h(4681));return h.O(l)},l=[],h.O=(x,s,U,M)=>{if(!s){var g=1/0;for(b=0;b<l.length;b++){for(var[s,U,M]=l[b],J=!0,A=0;A<s.length;A++)(!1&M||g>=M)&&Object.keys(h.O).every(he=>h.O[he](s[A]))?s.splice(A--,1):(J=!1,M<g&&(g=M));if(J){l.splice(b--,1);var Q=U();void 0!==Q&&(x=Q)}}return x}M=M||0;for(var b=l.length;b>0&&l[b-1][2]>M;b--)l[b]=l[b-1];l[b]=[s,U,M]},h.d=(l,x)=>{for(var s in x)h.o(x,s)&&!h.o(l,s)&&Object.defineProperty(l,s,{enumerable:!0,get:x[s]})},h.f={},h.e=l=>Promise.all(Object.keys(h.f).reduce((x,s)=>(h.f[s](l,x),x),[])),h.u=l=>l+".9359b519a07dd466.js",h.miniCssF=l=>{},h.o=(l,x)=>Object.prototype.hasOwnProperty.call(l,x),(()=>{var l;h.tt=()=>(void 0===l&&(l={createScriptURL:x=>x},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(l=trustedTypes.createPolicy("angular#bundler",l))),l)})(),h.tu=l=>h.tt().createScriptURL(l),h.p="",(()=>{var l={507:1};h.f.i=(M,b)=>{l[M]||importScripts(h.tu(h.p+h.u(M)))};var s=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],U=s.push.bind(s);s.push=M=>{var[b,g,J]=M;for(var A in g)h.o(g,A)&&(h.m[A]=g[A]);for(J&&J(h);b.length;)l[b.pop()]=1;U(M)}})(),(()=>{var l=h.x;h.x=()=>h.e(696).then(l)})(),h.x()})();