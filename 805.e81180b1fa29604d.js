(()=>{"use strict";var c,me={8459:(c,C,d)=>{var j=d(5861),z=d(5500),E=d(7715),P=d(2438),X=d(7398),b=d(2181),te=d(8906),ye=d(6328),fe=d(8857);var Ae=d(5592),Ce=d(2384);let pe;const we=new Map;class ze{examName;db;constructor(e){this.examName=e}error(...e){console.error(...e)}initDb(e){if(void 0===this.db||!this.db.isOpen()){const t=e.oo1;this.db=e.opfs?new t.OpfsDb("/"+this.examName+".sqlite3"):new t.DB("/"+this.examName+".sqlite3","ct")}}close(){this.db.close()}initemptyDb(e){this.initDb(e);try{this.db.exec("CREATE TABLE IF NOT EXISTS template(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS align(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS nonalign(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)")}finally{this.close()}}getFirstNonAlignImage(e,t){this.initDb(e);try{return this.db.selectValue("select imageData from nonalign where page="+t)}finally{this.close()}}}!function ve(V){const e=new V,t=(0,P.R)(self,"message");return function ge(V,e){const t=e.pipe((0,X.U)(r=>r.data),(0,X.U)(r=>new z.P_(r.kind,r.value,r.error)),(0,b.h)(r=>"C"!==r.kind),(0,te.D)());return function Me(V){return!!V.workUnit}(V)?t.pipe((0,ye.b)(r=>(0,E.D)(V.workUnit(r)).pipe((0,fe.i)()))):V.work(t).pipe((0,fe.i)())}(e,t).subscribe(r=>{const s=postMessage;(function be(V){return!!V.selectTransferables})(e)&&r.hasValue?s(r,e.selectTransferables(r.value)):s(r)})}(class Re{opencvready=new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/5/opencv.js",onRuntimeInitialized(){cv.then(r=>{cv=r,cv.ready.then(()=>{e()}).catch(s=>{console.log(s)})})}},t.importScripts(t.Module.scriptUrl)});db;initSqlLite=!1;sqlliteReady=e=>new Promise(e?t=>{const r=self;r.Module={scriptUrl:"content/sqlite/sqlite3.js"},r.importScripts(r.Module.scriptUrl),r.sqlite3InitModule({print:console.log,printErr:console.error}).then(function(s){pe=s,t()}).catch(s=>{console.log(s)})}:t=>{t()});reviver(e,t){return"object"==typeof t&&null!==t&&"Map"===t.dataType?new Map(t.value):t}loadImage(e){var t=this;return(0,j.Z)(function*(){const r=JSON.parse(e.value,t.reviver),l=yield(yield fetch(r.pages)).blob(),u=yield createImageBitmap(l),O=new OffscreenCanvas(u.width,u.height).getContext("2d");return O.drawImage(u,0,0),O.getImageData(0,0,u.width,u.height)})()}getScanImage(e,t,r){var s=this;return(0,j.Z)(function*(){if(r)return void 0===s.db&&(s.db=new Ce.z),yield s.db.getFirstNonAlignImage(t,e);{let l=we.get(t);return void 0===l&&(l=new ze(t),we.set(t,l)),{examId:t,pageNumber:e,value:l.getFirstNonAlignImage(pe,e)}}})()}workUnit(e){var t=this;return new Ae.y(r=>{this.opencvready.then((0,j.Z)(function*(){!e.indexDb&&!t.initSqlLite&&(yield t.sqlliteReady(!e.indexDb),t.initSqlLite=!0);let s=yield t.getScanImage(e.pageNumber,e.examId,e.indexDb);if(void 0!==s){const l=yield t.loadImage(s);if(s=void 0,e.marker){const u=t.alignImageBasedOnCircle(e.imageA,l,e.widthA,e.heightA,e.preference,e.debug);u.pageNumber=e.pageNumber,r.next(u),r.complete()}else try{const u=t.alignImage(e.imageA,l,e.widthA,e.heightA,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.debug);e.imageA=void 0,u.pageNumber=e.pageNumber,r.next(u),r.complete()}catch(u){console.error(u)}}})).catch(s=>{console.log(s)})})}selectTransferables(e){return void 0!==e.imagesDebugTraces?[e.imageAligned,e.imagesDebugTraces]:[e.imageAligned]}imageDataFromMat(e){const t=e,r=e.type()%8,s=r<=cv.CV_8S?1:r<=cv.CV_32S?1/256:255,l=r===cv.CV_8S||r===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,s,l),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const u=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return e.delete(),u}roi(e,t){const r=e.size().width,s=e.size().height;return t.x+t.width>r&&(t.width=r-t.x),t.y+t.height>s&&(t.height=s-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,r,s,l,u,M,O){const W=new ImageData(new Uint8ClampedArray(e),r,s),f=t,n=cv.matFromImageData(W);let Y=cv.matFromImageData(f),K=Y;if(n.size().width!==Y.size().width||n.size().height!==Y.size().height){K=new cv.Mat;let i=new cv.Size(n.size().width,n.size().height);cv.resize(Y,K,i,0,0,cv.INTER_AREA),Y.delete()}let T=new cv.Mat,y=new cv.Mat;cv.cvtColor(K,T,cv.COLOR_BGRA2GRAY),cv.cvtColor(n,y,cv.COLOR_BGRA2GRAY);const q=Math.trunc(n.size().width/10);let x=[],U=[],p={},G=!1,N=!1,o=!1,m=!1;const A=Math.min(T.size().width,y.size().width),H=Math.min(T.size().height,y.size().height);if(l){let i=new cv.Rect(0,0,A,H);G=this.matchSmallImage(T,y,x,U,i,u,M),N=!0,o=!0,m=!0}else{let i=q;for(;!G&&i<3*A/4&&i<2*H/3;){let R=new cv.Rect(0,0,i,i);G=this.matchSmallImage(T,y,x,U,R,u,M),G||(i+=Math.trunc(A/10))}for(i=q;!N&&i<3*A/4&&i<2*H/3;){let R=new cv.Rect(A-i,0,A,i);N=this.matchSmallImage(T,y,x,U,R,u,M),N||(i+=Math.trunc(A/10))}for(i=q;!o&&i<3*A/4&&i<2*H/3;){let R=new cv.Rect(0,H-i,i,H);o=this.matchSmallImage(T,y,x,U,R,u,M),o||(i+=Math.trunc(A/10))}for(i=q;!m&&i<3*A/4&&i<2*H/3;){let R=new cv.Rect(A-i,H-i,A,H);m=this.matchSmallImage(T,y,x,U,R,u,M),m||(i+=Math.trunc(A/10))}}if(G&&N&&o&&m){let i=cv.matFromArray(x.length/2,1,cv.CV_32FC2,x),R=cv.matFromArray(U.length/2,1,cv.CV_32FC2,U),J=cv.findHomography(i,R,cv.RANSAC),S=K;if(cv.warpPerspective(S,S,J,n.size()),O){let D=new cv.MatVector;D.push_back(n),D.push_back(K);let a=new cv.Mat;cv.hconcat(D,a);const k=U.length/2;for(let L=0;L<k;L++){let h={x:U[2*L],y:U[2*L+1]},_={x:n.size().width+x[2*L],y:x[2*L+1]};cv.circle(a,h,5,[0,255,0,255],1),cv.circle(a,_,5,[0,255,0,255],1),cv.line(a,h,_,[0,255,0,255],1)}p.imagesDebugTracesWidth=a.size().width,p.imagesDebugTracesHeight=a.size().height,p.imagesDebugTraces=this.imageDataFromMat(a).data.buffer,D.delete()}p.imageAlignedWidth=S.size().width,p.imageAlignedHeight=S.size().height,p.imageAligned=this.imageDataFromMat(S).data.buffer,i.delete(),R.delete(),J.delete(),t.data.set([])}else{if(O){let i=new cv.MatVector;i.push_back(n),i.push_back(K);let R=new cv.Mat;cv.hconcat(i,R),p.imagesDebugTracesWidth=R.size().width,p.imagesDebugTracesHeight=R.size().height,p.imagesDebugTraces=this.imageDataFromMat(R).data.buffer,i.delete()}p.imageAligned=t.data.buffer,p.imageAlignedWidth=t.width,p.imageAlignedHeight=t.height,K.delete()}return W.data.set([]),n.delete(),T.delete(),y.delete(),p}matchSmallImage(e,t,r,s,l,u,M){let O=new cv.Mat;O=this.roi(e,l);let W=new cv.Mat;W=this.roi(t,l);let f=new cv.KeyPointVector,n=new cv.KeyPointVector,Y=new cv.Mat,K=new cv.Mat,T=new cv.AKAZE,q=W;T.detectAndCompute(O,O,f,Y),T.detectAndCompute(W,q,n,K);const x=O.size().width,U=O.size().height;O.delete(),W.delete(),T.delete();let p=new cv.DMatchVector,G=new cv.BFMatcher,N=new cv.DMatchVectorVector;G.knnMatch(Y,K,N,2),Y.delete(),K.delete();for(let a=0;a<N.size();++a){let k=N.get(a),L=k.get(0),h=k.get(1);void 0!==L&&void 0!==h&&L.distance<=h.distance*parseFloat("0.7")&&p.push_back(L)}if(0===p.size())return f.delete(),n.delete(),N.delete(),p.delete(),G.delete(),!1;let o=[],m=[];for(let a=0;a<p.size();a++)o.push(f.get(p.get(a).queryIdx).pt.x+l.x),o.push(f.get(p.get(a).queryIdx).pt.y+l.y),m.push(n.get(p.get(a).trainIdx).pt.x+l.x),m.push(n.get(p.get(a).trainIdx).pt.y+l.y);let A=0,H=[];const i=[];for(let a=0;a<p.size();a++){let k=(o[2*a]-m[2*a])*(o[2*a]-m[2*a])+(o[2*a+1]-m[2*a+1])*(o[2*a+1]-m[2*a+1]);k<Math.trunc(3*x/20)*Math.trunc(3*U/20)&&(H.push(k),A+=1,i.push(a))}const R=this.numAverage(H);let J=this.dev(H);if(J<1&&(J=1),A<=u)return f.delete(),n.delete(),N.delete(),p.delete(),G.delete(),!1;let S=0,D=[];for(let a=0;a<i.length;a++){let k=(o[2*i[a]]-m[2*i[a]])*(o[2*i[a]]-m[2*i[a]])+(o[2*i[a]+1]-m[2*i[a]+1])*(o[2*i[a]+1]-m[2*i[a]+1]);k<=R+1*J&&k>=R-1*J&&(S+=1,D.push(i[a]))}if(S<=M)return f.delete(),n.delete(),N.delete(),p.delete(),G.delete(),!1;{const a=[],k=[];D.forEach(h=>{k.push((o[2*h]-m[2*h])*(o[2*h]-m[2*h])+(o[2*h+1]-m[2*h+1])*(o[2*h+1]-m[2*h+1]))});const L=this.numAverage(k);return D.sort((h,_)=>Math.abs((o[2*h]-m[2*h])*(o[2*h]-m[2*h])+(o[2*h+1]-m[2*h+1])*(o[2*h+1]-m[2*h+1])-L)-Math.abs((o[2*_]-m[2*_])*(o[2*_]-m[2*_])+(o[2*_+1]-m[2*_+1]*(o[2*_+1]-m[2*_+1]))-L)),a.push(D[0]),a.push(D[1]),a.push(D[2]),a.push(D[3]),a.push(D[4]),a.forEach(h=>{r.push(f.get(p.get(+h).queryIdx).pt.x+l.x),r.push(f.get(p.get(+h).queryIdx).pt.y+l.y),s.push(n.get(p.get(+h).trainIdx).pt.x+l.x),s.push(n.get(p.get(+h).trainIdx).pt.y+l.y)}),f.delete(),n.delete(),N.delete(),p.delete(),G.delete(),!0}}numAverage(e){return e.reduce((t,r)=>t+r,0)/e.length}dev(e){let t=e.reduce((s,l)=>s+l,0)/e.length,r=(e=e.map(s=>(s-t)**2)).reduce((s,l)=>s+l,0);return Math.sqrt(r/e.length)}alignImageBasedOnCircle(e,t,r,s,l,u){const M=new ImageData(new Uint8ClampedArray(e),r,s),O=t;let T,y,q,x,U,p,G,N,o,m,A,H,W=cv.matFromImageData(M),f=new cv.Mat,n=new cv.Mat;cv.cvtColor(W,f,cv.COLOR_RGBA2GRAY),cv.HoughCircles(f,n,cv.HOUGH_GRADIENT,1,45,75,20,f.cols*l.minCircle/1e3,f.cols*l.maxCircle/1e3),n.cols>0&&(T=n.data32F[0],y=n.data32F[1],q=n.data32F[2],x=n.data32F[0],U=n.data32F[1],p=n.data32F[2],G=n.data32F[0],N=n.data32F[1],o=n.data32F[2],m=n.data32F[0],A=n.data32F[1],H=n.data32F[2]);const i=f.size().width,R=f.size().height;if(n.cols>0)for(let F=1;F<n.cols;F++){let v=n.data32F[3*F],w=n.data32F[3*F+1],ee=n.data32F[3*F+2];v*v+w*w<=T*T+y*y&&(T=v,y=w,q=ee),v*v+w*w>=m*m+A*A&&(m=v,A=w,H=ee),(i-v)*(i-v)+w*w<=(i-x)*(i-x)+U*U&&(x=v,U=w,p=ee),v*v+(R-w)*(R-w)<=G*G+(R-N)*(R-N)&&(G=v,N=w,o=ee)}let J=cv.matFromImageData(O),S=J;if(S.size().width!==f.size().width||S.size().height!==f.size().height){S=new cv.Mat;let F=new cv.Size(f.size().width,f.size().height);cv.resize(J,S,F,0,0,cv.INTER_AREA),J.delete()}let D=new cv.Mat,a=new cv.Mat;cv.cvtColor(S,D,cv.COLOR_RGBA2GRAY);const k=D.size().width,L=D.size().height;cv.HoughCircles(D,a,cv.HOUGH_GRADIENT,1,45,75,15,o-3,o+3);let h=[],_=[];const Te=180*(4*o*o-3.14159*o*o)/100;for(let F=0;F<a.cols;F++){let v=a.data32F[3*F],w=a.data32F[3*F+1];const ee=v-o,ie=w-o;let Q=2*o,$=2*o;ee+Q>k&&(Q=k-ee),ie+$>L&&($=L-ie);let he=new cv.Rect(v-o,w-o,Q,$),I=new cv.Mat,B=new cv.Mat;I=this.roi(D,he),cv.threshold(I,B,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(B)<Te&&(h.push(v),_.push(w)),B.delete(),I.delete()}let ae,re,se,ne,le,ce,oe,de;if(h.length>0&&(ae=h[0],re=_[0],se=h[0],ne=_[0],le=h[0],ce=_[0],oe=h[0],de=_[0]),h.length>1)for(let F=0;F<h.length;F++){let v=h[F],w=_[F];v*v+w*w<=ae*ae+re*re&&(ae=v,re=w),v*v+w*w>=oe*oe+de*de&&(oe=v,de=w),(k-v)*(k-v)+w*w<=(k-se)*(k-se)+ne*ne&&(se=v,ne=w),v*v+(L-w)*(L-w)<=le*le+(L-ce)*(L-ce)&&(le=v,ce=w)}if(h.length>=4){let F=cv.matFromArray(4,1,cv.CV_32FC2,[T,y,x,U,G,N,m,A]),v=cv.matFromArray(4,1,cv.CV_32FC2,[ae,re,se,ne,le,ce,oe,de]),w=cv.getPerspectiveTransform(v,F),ee=new cv.Size(f.cols,f.rows);for(let $=0;$<F.rows;++$){let B=15,Z=new cv.Point(v.data32F[2*$],v.data32F[2*$+1]);cv.circle(S,Z,B,[0,0,255,255],1)}let ie=S;cv.warpPerspective(S,ie,w,ee,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let Q={};if(u){let $=new cv.MatVector;$.push_back(W),$.push_back(S);let he=new cv.Size(2*W.size().width,f.size().height),I=new cv.Mat(he,W.type());cv.hconcat($,I);let B={x:T,y},Z={x:f.size().width+ae,y:re};cv.circle(I,B,15,[0,255,0,255],1),cv.circle(I,Z,15,[0,255,0,255],1),cv.line(I,B,Z,[0,255,0,255],1),B={x,y:U},Z={x:f.size().width+se,y:ne},cv.circle(I,B,15,[0,255,0,255],1),cv.circle(I,Z,15,[0,255,0,255],1),cv.line(I,B,Z,[0,255,0,255],1),B={x:G,y:N},Z={x:f.size().width+le,y:ce},cv.circle(I,B,15,[0,255,0,255],1),cv.circle(I,Z,15,[0,255,0,255],1),cv.line(I,B,Z,[0,255,0,255],1),B={x:m,y:A},Z={x:f.size().width+oe,y:de},cv.circle(I,B,15,[0,255,0,255],1),cv.circle(I,Z,15,[0,255,0,255],1),cv.line(I,B,Z,[0,255,0,255],1),Q.imagesDebugTracesWidth=I.size().width,Q.imagesDebugTracesHeight=I.size().height,Q.imagesDebugTraces=this.imageDataFromMat(I).data.buffer,$.delete()}return Q.imageAlignedWidth=ie.size().width,Q.imageAlignedHeight=ie.size().height,Q.imageAligned=this.imageDataFromMat(ie).data.buffer,W.delete(),f.delete(),n.delete(),D.delete(),a.delete(),F.delete(),v.delete(),w.delete(),Q}return W.delete(),f.delete(),n.delete(),D.delete(),S.delete(),a.delete(),this.alignImage(e,t,r,s,!1,l.numberofpointToMatch,l.numberofgoodpointToMatch,u)}})},9940:(c,C,d)=>{d.d(C,{yG:()=>P});var j=d(671);function P(b){return(0,j.K)(function z(b){return b[b.length-1]}(b))?b.pop():void 0}},9360:(c,C,d)=>{d.d(C,{e:()=>E});var j=d(4674);function E(P){return X=>{if(function z(P){return(0,j.m)(P?.lift)}(X))return X.lift(function(b){try{return P(b,this)}catch(te){this.error(te)}});throw new TypeError("Unable to lift unknown Observable type")}}}},ue={};function g(c){var C=ue[c];if(void 0!==C)return C.exports;var d=ue[c]={exports:{}};return me[c](d,d.exports,g),d.exports}g.m=me,g.x=()=>{var c=g.O(void 0,[173,330,592],()=>g(8459));return g.O(c)},c=[],g.O=(C,d,j,z)=>{if(!d){var P=1/0;for(E=0;E<c.length;E++){for(var[d,j,z]=c[E],X=!0,b=0;b<d.length;b++)(!1&z||P>=z)&&Object.keys(g.O).every(ge=>g.O[ge](d[b]))?d.splice(b--,1):(X=!1,z<P&&(P=z));if(X){c.splice(E--,1);var te=j();void 0!==te&&(C=te)}}return C}z=z||0;for(var E=c.length;E>0&&c[E-1][2]>z;E--)c[E]=c[E-1];c[E]=[d,j,z]},g.d=(c,C)=>{for(var d in C)g.o(C,d)&&!g.o(c,d)&&Object.defineProperty(c,d,{enumerable:!0,get:C[d]})},g.f={},g.e=c=>Promise.all(Object.keys(g.f).reduce((C,d)=>(g.f[d](c,C),C),[])),g.u=c=>(592===c?"common":c)+"."+{173:"f9c098383bb6ea61",330:"c23ea5e35e0e42fc",592:"33c6fd3cc93b62c8"}[c]+".js",g.miniCssF=c=>{},g.o=(c,C)=>Object.prototype.hasOwnProperty.call(c,C),g.j=805,(()=>{var c;g.tt=()=>(void 0===c&&(c={createScriptURL:C=>C},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(c=trustedTypes.createPolicy("angular#bundler",c))),c)})(),g.tu=c=>g.tt().createScriptURL(c),g.p="",(()=>{var c={805:1};g.f.i=(z,E)=>{c[z]||importScripts(g.tu(g.p+g.u(z)))};var d=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],j=d.push.bind(d);d.push=z=>{var[E,P,X]=z;for(var b in P)g.o(P,b)&&(g.m[b]=P[b]);for(X&&X(g);E.length;)c[E.pop()]=1;j(z)}})(),(()=>{var c=g.x;g.x=()=>Promise.all([173,330,592].map(g.e,g)).then(c)})(),g.x()})();