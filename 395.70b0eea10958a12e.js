(()=>{"use strict";class ee{constructor(e){e?(this.alphabet="abcdefghijklmnopqrstuvwxyz",this.characters="0123456789"+this.alphabet.toUpperCase()+this.alphabet):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(i=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),i()})})})}loadModel(e){return console.time("Load model"),e?tf.loadLayersModel("content/classifier/letteranddigitclassifier/model.json").then(i=>{this._model=i,console.timeEnd("Load model")}):tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(i=>{this._model=i,console.timeEnd("Load model")})}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const a=e.width>e.height,c=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),o=a?[[c,c],[0,0],[0,0]]:[[0,0],[c,c],[0,0]];return tf.tidy(()=>{let s=tf.browser.fromPixels(e,1).pad(o,255);return s=tf.image.resizeBilinear(s,[24,24]).pad([[2,2],[2,2],[0,0]],255),s=tf.scalar(1).sub(s.toFloat().div(tf.scalar(255))),s.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const i=this.preprocessImage(e),l=this._model.predict(i).as1D(),n=l.argMax().dataSync()[0],a=l.max().dataSync()[0];return[this.characters[n],a]}}function q(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function k(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function te(t,e,i){let l=new cv.Mat;const n=new cv.Rect(e.x,e.y,i.w,i.h);return l=t.roi(n),l}function me(t){const e=.0145*cv.arcLength(t,!0),i=new cv.Mat;let l;cv.approxPolyDP(t,i,e,!0);const n=q(i);if(n.w>=10&&n.h>=10){const a=i.rows;if(1===a)l="LIGNE";else if(3===a)l="TRIANGLE";else if(4===a){const c=n.w/n.h;l=c>=.95&&c<=1.05?"CARRE":"RECTANGLE"}else l=void 0}return{nom:l,forme:i}}function pe(t,e){let i=k(t),l=k(e);return i.y<l.y?-1:i.y>l.y?1:i.x-l.x}function le(t,e){let i=k(t),l=k(e),n=q(t),a=q(e);return(l.x>=i.x&&l.x<=i.x+n.w||l.x+a.w>=i.x&&l.x+a.w<=i.x+n.w)&&(l.y>=i.y&&l.y<=i.y+n.h||l.y+a.h>=i.y&&l.y+a.h<=i.y+n.h)}function ie(t){const e=function we(t,e=[]){const i=new cv.Mat;cv.threshold(t,i,240,255,cv.THRESH_BINARY);let l=new cv.MatVector,n=new cv.Mat;cv.findContours(i,l,n,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const a=[];for(let s=0;s<l.size();++s){const w=me(l.get(s));e.includes(w.nom)&&a.push(w.forme)}a.sort(pe);const c=[],o=[];return a.forEach((s,r)=>{!function Re(t,e){let i=e[t],l=!1;return e.forEach((n,a)=>{t<a&&function ye(t,e){return le(t,e)||le(e,t)}(i,n)&&(l=!0)}),l}(r,a)?c.push(s):o.push(s)}),o.forEach(s=>{s.delete()}),c}(t,["CARRE","RECTANGLE"]),i=[],l=[];return e.forEach(n=>{const a=q(n),c=k(n);i.push(n),l.push(te(t,c,a))}),{cases:i,img_cases:l}}function ne(t,e,i=new cv.Scalar(255,0,0,128),l=2){return e.forEach(n=>{const a=k(n),c=q(n);let o=new cv.Point(a.x,a.y),s=new cv.Point(a.x+c.w,a.y+c.h);cv.rectangle(t,o,s,i,l,0)}),t}let $,J;function ce(t,e){let i=cv.matFromImageData(t.payload.image);const l=function Oe(t){return t?(void 0===$&&($=new ee(t)),$):(void 0===J&&(J=new ee(t)),J)}(e);l.isWarmedUp.then(()=>{const n=function Be(t,e,i,l,n){const a=function Fe(t,e,i){let r=t.clone(),w=new cv.Mat;cv.cvtColor(t,w,cv.COLOR_BGR2GRAY,0);let R=new cv.Mat;cv.threshold(w,R,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let C=new cv.Point(-1,-1);if(e){let g=new cv.Mat,F=new cv.Size(1,15),N=cv.getStructuringElement(cv.MORPH_RECT,F);cv.morphologyEx(R,g,cv.MORPH_OPEN,N,C,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let P=new cv.MatVector,m=new cv.Mat;cv.findContours(g,P,m,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let v=new cv.Scalar(255,255,255);cv.drawContours(r,P,-1,v,4);let f=new cv.Mat,y=new cv.Size(15,1),x=cv.getStructuringElement(cv.MORPH_RECT,y),U=new cv.Point(-1,-1);cv.morphologyEx(R,f,cv.MORPH_OPEN,x,U,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let G=new cv.MatVector,j=new cv.Mat;cv.findContours(f,G,j,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let V=new cv.Scalar(255,255,255);cv.drawContours(r,G,-1,V,4),g.delete(),P.delete(),m.delete(),N.delete(),f.delete(),G.delete(),j.delete(),x.delete()}let A=new cv.Size(3,3),_=cv.getStructuringElement(cv.MORPH_ELLIPSE,A),T=new cv.Mat,h=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);h.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(h,h,cv.COLOR_BGR2GRAY,0);let u=new cv.Mat;cv.cvtColor(r,u,cv.COLOR_BGR2GRAY,0);let M=new cv.Mat;cv.subtract(h,u,M,T,-1);let S=new cv.Mat;cv.dilate(M,S,_,C,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let E=new cv.Mat,H=new cv.Mat;cv.bitwise_and(S,R,E),cv.morphologyEx(E,H,cv.MORPH_CLOSE,_,C,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let L=new cv.Mat;cv.bitwise_and(H,R,L);let B=new cv.Mat;cv.subtract(h,L,B,T,-1);let I=new cv.MatVector,b=new cv.Mat;cv.findContours(L,I,b,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const Y=new Map;let d=[];for(let g=0;g<I.size();g++){let F=I.get(g),N=cv.boundingRect(F);(N.width>12||N.height>12)&&d.push(N)}let O=ae(d),D=0;for(;null!==O&&D<200;)d=d.filter(g=>g!==O.toRemove1&&g!==O.toRemove2),d.push(O.u),O=ae(d),D+=1;d.forEach(g=>{let F=new cv.Scalar(0,0,0),N=new cv.Point(g.x,g.y),P=new cv.Point(g.x+g.width,g.y+g.height),m=new cv.Mat,v=new cv.Mat,f=new cv.Mat,y=new cv.Scalar(255,0,0,255);m=X(B,g),g.width>g.height?cv.copyMakeBorder(m,m,(g.width-g.height)/2,(g.width-g.height)/2,1,1,cv.BORDER_CONSTANT,y):cv.copyMakeBorder(m,m,1,1,(g.height-g.width)/2,(g.height-g.width)/2,cv.BORDER_CONSTANT,y);let x=new cv.Size(26,26);cv.resize(m,v,x,0,0,cv.INTER_AREA),cv.copyMakeBorder(v,f,1,1,1,1,cv.BORDER_CONSTANT,y),Y.set(g,f),m.delete(),v.delete(),cv.rectangle(B,N,P,F,2,cv.LINE_AA,0)}),w.delete(),R.delete(),_.delete(),T.delete(),h.delete(),u.delete(),M.delete(),S.delete(),r.delete(),E.delete(),H.delete(),L.delete(),I.delete(),b.delete();let p=[...Y];if(p.sort((g,F)=>g[0].x<F[0].x?-1:1),i&&p.length>3){const g=(p[p.length-1][0].x-p[0][0].x)/p.length;let F=g,N=0,P=0,m=800;const v=[];for(let y=0;y<p.length-1;y++){let x=p[y+1][0].x-p[y][0].x;x<F&&(F=x),x>1.7*g&&v.push(y),p[y][0].y<m&&(m=p[y][0].y),p[y][0].height>N&&(N=p[y][0].height),p[y][0].width>P&&(P=p[y][0].width)}const f=(p[p.length-1][0].x-p[0][0].x)/(p.length+v.length);v.forEach(y=>{let x=p[y][0].x+f,U=new cv.Scalar(0,0,0),G=new cv.Point(x,m),j=new cv.Point(x+P,m+N),V=new cv.Rect(x,m,P,N),K=new cv.Mat,Q=new cv.Mat,oe=new cv.Mat;K=X(B,V);let Le=new cv.Size(26,26);cv.resize(K,Q,Le,0,0,cv.INTER_AREA);let He=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(Q,oe,1,1,1,1,cv.BORDER_CONSTANT,He),Y.set(V,oe),K.delete(),Q.delete(),cv.rectangle(B,G,j,U,2,cv.LINE_AA,0)}),p=[...Y],p.sort((y,x)=>y[0].x<x[0].x?-1:1)}return{letter:p,invert_final:B}}(t,!1,l);let c=[];e.forEach(s=>{c.push([s.padEnd(13," "),0])});const o=[];for(let s=0;s<a.letter.length;s++){let r=i.predict(W(a.letter[s][1]));n&&("1"===r[0]&&(r[0]="i"),"0"===r[0]&&(r[0]="o"),"5"===r[0]&&(r[0]="s"),"3"===r[0]&&(r[0]="b"),"9"===r[0]&&(r[0]="g")),o.push(r)}for(let s=0;s<c.length;s++){for(let r=0;r<13;r++)r<o.length&&(c[s][1]=c[s][0].substring(r,r+1).toLowerCase()===o[r][0].toLowerCase()?c[s][1]+o[r][1]:n?c[s][1]+(1-o[r][1])/35:c[s][1]+(1-o[r][1])/9);c[s][1]=c[s][1]/o.length}for(let s=0;s<c.length;s++)c[s][0]=c[s][0].trim(),c[s][1]=c[s][1]-Math.abs(c[s][0].length-o.length)/c[s][0].length;return c.sort((s,r)=>s[1]<r[1]?1:-1),{debug:a.invert_final,solution:c[0]}}(i,t.payload.match,l,!0,e);postMessage({msg:t.msg,payload:{debug:W(n.debug),solution:n.solution},uid:t.uid}),n.debug.delete(),i.delete()})}function W(t){const e=new cv.Mat,i=t.type()%8,l=i<=cv.CV_8S?1:i<=cv.CV_32S?1/256:255,n=i===cv.CV_8S||i===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,l,n),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}function se(t,e,i,l,n){let a=cv.matFromImageData(t),c=cv.matFromImageData(e),o=new cv.Mat,s=new cv.Mat;cv.cvtColor(c,o,cv.COLOR_BGRA2GRAY),cv.cvtColor(a,s,cv.COLOR_BGRA2GRAY);const r=Math.trunc(a.size().width/20);let w=[],R=[],C={};if(i){let h=new cv.Rect(0,0,o.size().width,o.size().height);Z(o,s,w,R,h,1,l,n)}else{let h=!1,u=r;for(;!h&&u<o.size().width&&u<o.size().height;)h=Z(o,s,w,R,new cv.Rect(0,0,u,u),1,l,n),h||(u+=Math.trunc(a.size().width/20));for(h=!1,u=r;!h&&u<o.size().width&&u<o.size().height;){let M=new cv.Rect(o.size().width-u,0,o.size().width,u);h=Z(o,s,w,R,M,2,l,n),h||(u+=Math.trunc(a.size().width/20))}for(h=!1,u=r;!h&&u<o.size().width&&u<o.size().height;){let M=new cv.Rect(0,o.size().height-u,u,o.size().height);h=Z(o,s,w,R,M,3,l,n),h||(u+=Math.trunc(a.size().width/20))}for(h=!1,u=r;!h&&u<o.size().width&&u<o.size().height;){let M=new cv.Rect(o.size().width-u,o.size().height-u,o.size().width,o.size().height);h=Z(o,s,w,R,M,4,l,n),h||(u+=Math.trunc(a.size().width/20))}}let A=cv.matFromArray(4,1,cv.CV_32FC2,w),_=cv.matFromArray(4,1,cv.CV_32FC2,R),T=cv.getPerspectiveTransform(A,_),z=new cv.Mat;return cv.warpPerspective(c,z,T,a.size(),cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),C.imageAligned=W(z),C.imageAlignedWidth=z.size().width,C.imageAlignedHeight=z.size().height,A.delete(),_.delete(),c.delete(),a.delete(),o.delete(),s.delete(),C}function Z(t,e,i,l,n,a,c,o){let s=new cv.Mat;s=X(t,n);let r=new cv.Mat;r=X(e,n);let w=new cv.KeyPointVector,R=new cv.KeyPointVector,C=new cv.Mat,A=new cv.Mat,_=new cv.AKAZE,T=new cv.Mat,z=new cv.Mat;_.detectAndCompute(s,T,w,C),_.detectAndCompute(r,z,R,A);let h=new cv.DMatchVector,u=new cv.BFMatcher,M=new cv.DMatchVectorVector;u.knnMatch(C,A,M,2);for(let d=0;d<M.size();++d){let O=M.get(d),D=O.get(0),p=O.get(1),g="0.7";void 0!==D&&void 0!==p&&D.distance<=p.distance*parseFloat(g)&&h.push_back(D)}let S=[],E=[];for(let d=0;d<h.size();d++)S.push(w.get(h.get(d).queryIdx).pt.x+n.x),S.push(w.get(h.get(d).queryIdx).pt.y+n.y),E.push(R.get(h.get(d).trainIdx).pt.x+n.x),E.push(R.get(h.get(d).trainIdx).pt.y+n.y);let H=0,L=[];if(0===h.size())return!1;for(let d=0;d<h.size();d++){let O=(S[2*d]-E[2*d])*(S[2*d]-E[2*d])+(S[2*d+1]-E[2*d+1])*(S[2*d+1]-E[2*d+1]);O<Math.trunc(3*s.size().width/20)*Math.trunc(3*s.size().width/20)&&(L.push(O),H+=1)}const B=function Te(t){return t.reduce((e,i)=>e+i,0)/t.length}(L),I=function Ie(t){let e=t.reduce((l,n)=>l+n,0)/t.length;t=t.map(l=>(l-e)**2);let i=t.reduce((l,n)=>l+n,0);return Math.sqrt(i/t.length)}(L);if(H<=c)return _.delete(),w.delete(),R.delete(),C.delete(),A.delete(),T.delete(),z.delete(),r.delete(),M.delete(),h.delete(),u.delete(),!1;let b=0,Y=[];for(let d=0;d<h.size();d++){let O=(S[2*d]-E[2*d])*(S[2*d]-E[2*d])+(S[2*d+1]-E[2*d+1])*(S[2*d+1]-E[2*d+1]);if(O<B+1*I&&O>B-1*I){b+=1,Y.push(d);break}}return b<=o?(_.delete(),w.delete(),R.delete(),C.delete(),A.delete(),T.delete(),z.delete(),r.delete(),M.delete(),h.delete(),u.delete(),!1):(Y.forEach(d=>{i.push(w.get(h.get(+d).queryIdx).pt.x+n.x),i.push(w.get(h.get(+d).queryIdx).pt.y+n.y),l.push(R.get(h.get(+d).trainIdx).pt.x+n.x),l.push(R.get(h.get(+d).trainIdx).pt.y+n.y)}),_.delete(),w.delete(),R.delete(),C.delete(),A.delete(),T.delete(),z.delete(),r.delete(),M.delete(),h.delete(),u.delete(),console.log("good match for zone "+a+" = "+b),!0)}function X(t,e,i){const l=t.size().width,n=t.size().height;return e.x+e.width>l&&(e.width=l-e.x),e.y+e.height>n&&(e.height=n-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function Pe(t,e){let i=e,l=t,n=t,a=e;t.x>e.x&&(i=t,l=e),t.y>e.y&&(n=e,a=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let c=e,o=t,s=e,r=t;return t.right>e.right&&(c=t,o=e),t.bottom>e.bottom&&(s=t,r=e),i.x<l.right&&a.y>n.y+n.height?new cv.Rect(l.x,r.y,c.right-l.x,s.bottom-n.y):i.x>l.x+l.width+5||a.y>n.y+n.height?null:new cv.Rect(l.x,r.y,c.right-l.x,s.bottom-n.y)}function ae(t){for(let e=0;e<t.length-1;e++){const i=t[e];for(let l=e+1;l<t.length;l++){const n=t[l],a=Pe(i,n);if(null!==a)return{u:a,toRemove1:i,toRemove2:n}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(i=>{cv=i,i.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageProcessing":return function Ae(t){const e=cv.matFromImageData(t.payload);let i=new cv.Mat;cv.cvtColor(e,i,cv.COLOR_BGR2GRAY),postMessage({msg:t.msg,payload:W(i),uid:t.uid}),e.delete(),i.delete()}(t.data);case"imageAlignement":return function ze(t){if(t.payload.marker){const e=function Ne(t){let c,o,s,r,w,R,C,A,_,T,z,h,e=cv.matFromImageData(t.imageA),i=new cv.Mat,l=new cv.Mat;cv.cvtColor(e,e,cv.COLOR_RGBA2GRAY),cv.HoughCircles(e,l,cv.HOUGH_GRADIENT,1,45,75,20,6*e.cols/1e3,20*e.cols/1e3),l.cols>0&&(c=l.data32F[0],o=l.data32F[1],s=l.data32F[2],r=l.data32F[0],w=l.data32F[1],R=l.data32F[2],C=l.data32F[0],A=l.data32F[1],_=l.data32F[2],T=l.data32F[0],z=l.data32F[1],h=l.data32F[2]);const u=e.size().width,M=e.size().height;if(l.cols>0)for(let m=1;m<l.cols;m++){let v=l.data32F[3*m],f=l.data32F[3*m+1],y=l.data32F[3*m+2];v*v+f*f<=c*c+o*o&&(c=v,o=f,s=y),v*v+f*f>=T*T+z*z&&(T=v,z=f,h=y),(u-v)*(u-v)+f*f<=(u-r)*(u-r)+w*w&&(r=v,w=f,R=y),v*v+(M-f)*(M-f)<=C*C+(M-A)*(M-A)&&(C=v,A=f,_=y)}let S=cv.matFromImageData(t.imageB),E=new cv.Mat,H=new cv.Mat;cv.cvtColor(S,E,cv.COLOR_RGBA2GRAY);const L=E.size().width,B=E.size().height;cv.HoughCircles(E,H,cv.HOUGH_GRADIENT,1,45,75,15,_-3,_+3);let I=[],b=[];const Y=180*(4*_*_-3.14159*_*_)/100;for(let m=0;m<H.cols;m++){let v=H.data32F[3*m],f=H.data32F[3*m+1];const y=v-_,x=f-_;let U=2*_,G=2*_;y+U>L&&(U=L-y),x+G>B&&(G=B-x);let j=new cv.Rect(v-_,f-_,U,G),V=new cv.Mat;V=X(E,j),cv.threshold(V,V,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(V)<Y&&(I.push(v),b.push(f)),V.delete()}let d,O,D,p,g,F,N,P;if(I.length>0&&(d=I[0],O=b[1],D=I[0],p=b[1],g=I[0],F=b[1],N=I[0],P=b[1]),I.length>1)for(let m=0;m<I.length;m++){let v=I[m],f=b[m];v*v+f*f<=d*d+O*O&&(d=v,O=f),v*v+f*f>=N*N+P*P&&(N=v,P=f),(L-v)*(L-v)+f*f<=(L-D)*(L-D)+p*p&&(D=v,p=f),v*v+(B-f)*(B-f)<=g*g+(B-F)*(B-F)&&(g=v,F=f)}if(I.length>=4){let m=cv.matFromArray(4,1,cv.CV_32FC2,[c,o,r,w,C,A,T,z]),v=cv.matFromArray(4,1,cv.CV_32FC2,[d,O,D,p,g,F,N,P]),f=cv.getPerspectiveTransform(v,m),y=new cv.Size(e.cols,e.rows);for(let G=0;G<m.rows;++G){let K=15,Q=new cv.Point(v.data32F[2*G],v.data32F[2*G+1]);cv.circle(S,Q,K,[0,0,255,255],1)}cv.warpPerspective(S,i,f,y,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let x=i.clone(),U={};return U.imageAligned=W(x),U.imageAlignedWidth=x.size().width,U.imageAlignedHeight=x.size().height,e.delete(),i.delete(),l.delete(),E.delete(),S.delete(),H.delete(),m.delete(),v.delete(),x.delete(),U}e.delete(),i.delete(),l.delete(),E.delete(),S.delete(),H.delete(),se(t.imageB,t.imageB,!1,5,0)}(t.payload);postMessage({msg:t.msg,payload:e,uid:t.uid})}else{const e=se(t.payload.imageA,t.payload.imageB,!1,5,0);postMessage({msg:t.msg,payload:e,uid:t.uid})}}(t.data);case"imageCrop":return function Se(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),i=new cv.Mat,l=cv.matFromImageData(t.payload.image);i=X(l,e),postMessage({msg:t.msg,payload:W(i),uid:t.uid}),i.delete(),l.delete()}(t.data);case"nameprediction":return ce(t.data,!0);case"ineprediction":return ce(t.data,!1);case"qcmresolution":return function de(t){var e;const i={solutions:[]};let l=cv.matFromImageData(t.payload.imageTemplate),n=new cv.Mat;cv.cvtColor(l,n,cv.COLOR_RGBA2GRAY,0);const a=ie(n);null===(e=t.payload.pages)||void 0===e||e.forEach((c,o)=>{var s;let r=new cv.Mat,w=cv.matFromImageData(c.imageInput);cv.cvtColor(w,r,cv.COLOR_RGBA2GRAY,0);const R=ie(r),C=function Me(t,e){const i=[];return t.cases.forEach(l=>{let a,n=500;if(e.cases.forEach(c=>{const o=function Ee(t,e){const i=cv.boundingRect(t),l=cv.boundingRect(e);let n=i.x+i.width/2,a=i.y+i.height/2,c=l.x+l.width/2,o=l.y+l.height/2;return Math.sqrt((n-c)*(n-c)+(a-o)*(a-o))}(l,c);n>o&&o<25&&(n=o,a=c)}),void 0!==a){let c=k(l),o=k(a);i.push({x:c.x-o.x,y:c.y-o.y})}}),function fe(t){if(t.length>0){let e=0,i=0;return t.forEach(l=>{e+=l.x,i+=l.y}),{x:e/t.length,y:i/t.length}}return{x:0,y:0}}(i)}(R,a),A=function Ce(t,e){let i=new cv.Mat;if(0!==e.x||0!==e.y){let l=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),n=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,i,l,n,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),i}return t}(w,C);let _=function _e(t,e,i){const l=[],n=[];let a=new Map;return t.cases.forEach((c,o)=>{const s=te(i,k(c),q(c)),r=function xe(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let i=new cv.Mat;return cv.threshold(e,i,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(i)/(t.rows*t.cols)}(s);r>.25?(a.set(o,{verdict:!0,prediction:r}),l.push(c)):(a.set(o,{verdict:!1,prediction:r}),n.push(c)),r>.16&&r<.25?cv.putText(i,""+r.toFixed(2),{x:k(c).x,y:k(c).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(i,""+r.toFixed(2),{x:k(c).x,y:k(c).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),s.delete()}),ne(i,l,new cv.Scalar(0,255,0,128)),ne(i,n,new cv.Scalar(0,0,255,128)),a}(a,0,A),T=function re(t){const e=new cv.Mat,i=t.type()%8,l=i<=cv.CV_8S?1:i<=cv.CV_32S?1/256:255,n=i===cv.CV_8S||i===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,l,n),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}(A),z=[];_.forEach((h,u)=>{h.verdict&&z.push(String.fromCharCode(97+u))}),null===(s=i.solutions)||void 0===s||s.push({imageSolution:T,numero:o,solution:z.join("&")}),r.delete(),w.delete(),A!==w&&A.delete(),R.cases.forEach(h=>h.delete()),R.img_cases.forEach(h=>h.delete())}),l.delete(),n.delete(),a.cases.forEach(c=>c.delete()),a.img_cases.forEach(c=>c.delete()),postMessage({msg:t.msg,payload:i,uid:t.uid})}(t.data)}})})();