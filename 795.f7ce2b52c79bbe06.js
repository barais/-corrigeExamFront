(()=>{"use strict";function F(t){return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function X(t,e,n){return(e=function ge(t){var e=function fe(t,e){if("object"!==F(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e||"default");if("object"!==F(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===F(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class re{constructor(e){X(this,"alphabet",void 0),X(this,"characters",void 0),X(this,"isWarmedUp",void 0),X(this,"_model",void 0),e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(n=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),n()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const i=e.width>e.height,l=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),c=i?[[l,l],[0,0],[0,0]]:[[0,0],[l,l],[0,0]];return tf.tidy(()=>{let d=tf.browser.fromPixels(e,1).pad(c,255);return d=tf.image.resizeBilinear(d,[24,24]).pad([[2,2],[2,2],[0,0]],255),d=tf.scalar(1).sub(d.toFloat().div(tf.scalar(255))),d.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const n=this.preprocessImage(e),o=this._model.predict(n).as1D(),r=o.argMax().dataSync()[0],i=o.max().dataSync()[0];return[this.characters[r],i]}}function D(t){const e=cv.boundingRect(t);return{w:e.width+8,h:e.height+8}}function ce(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function C(t){const e=cv.boundingRect(t);return{x:e.x-4,y:e.y-4}}function _e(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function ye(t,e){const n=e.qcm_epsilon*cv.arcLength(t,!0),o=new cv.Mat;let r;cv.approxPolyDP(t,o,n,!0);const i=ce(o);if(i.w>=e.qcm_min_width_shape&&i.h>=e.qcm_min_height_shape){const l=o.rows;if(1===l)r="LIGNE";else if(3===l)r="TRIANGLE";else if(4===l){const c=i.w/i.h;r=c>=.95&&c<=1.05?"CARRE":"RECTANGLE"}else r=void 0}return{nom:r,forme:o}}function Ce(t,e){let n=C(t),o=C(e);return n.y<o.y?-1:n.y>o.y?1:n.x-o.x}function Me(t,e){let n=C(t),o=C(e);return n.x-o.x}function ie(t,e){let n=C(t),o=C(e),r=D(t),i=D(e);return(o.x>=n.x&&o.x<=n.x+r.w||o.x+i.w>=n.x&&o.x+i.w<=n.x+r.w)&&(o.y>=n.y&&o.y<=n.y+r.h||o.y+i.h>=n.y&&o.y+i.h<=n.y+r.h)}function Q(t,e){const n=function Re(t,e=[],n){const o=new cv.Mat;cv.threshold(t,o,245,255,cv.THRESH_BINARY);let r=new cv.MatVector,i=new cv.Mat;cv.findContours(o,r,i,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const l=[];for(let s=0;s<r.size();++s){const p=ye(r.get(s),n);e.includes(p.nom)&&l.push(p.forme)}l.sort(Ce);const c=[],d=[];return l.forEach((s,h)=>{!function Se(t,e){let n=e[t],o=!1;return e.forEach((r,i)=>{t<i&&function Ee(t,e){return ie(t,e)||ie(e,t)}(n,r)&&(o=!0)}),o}(h,l)?c.push(s):d.push(s)}),d.forEach(s=>{s.delete()}),c}(t,["CARRE","RECTANGLE"],e),o=[],r=[];return n.forEach(i=>{const l=D(i),c=C(i);o.push(i),r.push(j(t,c,l))}),{cases:o,img_cases:r}}function j(t,e,n){let o=new cv.Mat,r=e.x,i=e.y,l=n.w,c=n.h;r<0&&(r=0),i<0&&(i=0),r+l>t.size().width&&(l=t.size().width-r),c+i>t.size().height&&(c=t.size().height-i);const d=new cv.Rect(r,i,l,c);return l<=0||c<=0?t:(o=t.roi(d),o)}function le(t,e,n=new cv.Scalar(255,0,0,128),o=2){return e.forEach(r=>{const i=C(r),l=D(r);let c=new cv.Point(i.x,i.y),d=new cv.Point(i.x+l.w,i.y+l.h);cv.rectangle(t,c,d,n,o,0)}),t}function se(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let n=new cv.Mat;return cv.threshold(e,n,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(n)/(t.rows*t.cols)}function Te(t){let e=new cv.Mat;cv.adaptiveThreshold(t,e,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY_INV,3,2);let r,n=new cv.MatVector,o=new cv.Mat;cv.findContours(e,n,o,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE);for(let i=0;i<n.size();++i){let l=n.get(i),c=cv.boundingRect(l);c.width>1&&c.height>1&&(void 0!==r&&(r.width>c.width||r.height>c.height)||(r=c))}if(void 0!==r){let i=new cv.Mat;i=e.roi(r);let l=cv.countNonZero(i)/(r.width*r.height);return i.delete(),e.delete(),l}return e.delete(),0}let $,J;function ae(t){return t?(void 0===$&&($=new re(t)),$):(void 0===J&&(J=new re(t)),J)}function de(t,e){let n=cv.matFromImageData(t.payload.image);const o=ae(e);o.isWarmedUp.then(()=>{const r=function Le(t,e,n,o,r,i){const l=function Ie(t,e,n,o){const r=o.linelength,i=o.repairsize,l=o.dilatesize,c=o.morphsize,d=o.drawcontoursizeh,s=o.drawcontoursizev;let h=t.clone(),p=new cv.Mat;cv.cvtColor(t,p,cv.COLOR_BGR2GRAY,0);let m=new cv.Mat;cv.threshold(p,m,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let u=new cv.Point(-1,-1);if(e){let v=new cv.Mat,T=new cv.Size(1,r),S=cv.getStructuringElement(cv.MORPH_RECT,T);cv.morphologyEx(m,v,cv.MORPH_OPEN,S,u,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let N=new cv.MatVector,R=new cv.Mat;cv.findContours(v,N,R,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let P=new cv.Scalar(255,255,255);cv.drawContours(h,N,-1,P,s);let I=new cv.Mat,_=new cv.Size(r,1),M=cv.getStructuringElement(cv.MORPH_RECT,_),ne=new cv.Point(-1,-1);cv.morphologyEx(m,I,cv.MORPH_OPEN,M,ne,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let Y=new cv.MatVector,W=new cv.Mat;cv.findContours(I,Y,W,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let K=new cv.Scalar(255,255,255);cv.drawContours(h,Y,-1,K,d),v.delete(),N.delete(),R.delete(),S.delete(),I.delete(),Y.delete(),W.delete(),M.delete()}let y=new cv.Size(i,i),a=cv.getStructuringElement(cv.MORPH_ELLIPSE,y),f=new cv.Mat,E=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);E.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(E,E,cv.COLOR_BGR2GRAY,0);let x=new cv.Mat;cv.cvtColor(h,x,cv.COLOR_BGR2GRAY,0);let b=new cv.Mat;cv.subtract(E,x,b,f,-1);let z=new cv.Mat;cv.dilate(b,z,a,u,l,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let L=new cv.Mat,B=new cv.Mat;cv.bitwise_and(z,m,L),cv.morphologyEx(L,B,cv.MORPH_CLOSE,a,u,c,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let V=new cv.Mat;cv.bitwise_and(B,m,V);let A=new cv.Mat;cv.subtract(E,V,A,f,-1);let k=new cv.MatVector,H=new cv.Mat;cv.findContours(V,k,H,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const G=new Map;let O=[];for(let v=0;v<k.size();v++){let T=k.get(v),S=cv.boundingRect(T);(S.width>12||S.height>12)&&O.push(S)}let U=ve(O),te=0;for(;null!==U&&te<200;)O=O.filter(v=>v!==U.toRemove1&&v!==U.toRemove2),O.push(U.u),U=ve(O),te+=1;O.forEach(v=>{let T=new cv.Scalar(0,0,0),S=new cv.Point(v.x,v.y),N=new cv.Point(v.x+v.width,v.y+v.height),R=new cv.Mat,P=new cv.Mat,I=new cv.Mat,_=new cv.Scalar(255,0,0,255);R=ee(A,v),v.width>v.height?cv.copyMakeBorder(R,R,(v.width-v.height)/2,(v.width-v.height)/2,1,1,cv.BORDER_CONSTANT,_):cv.copyMakeBorder(R,R,1,1,(v.height-v.width)/2,(v.height-v.width)/2,cv.BORDER_CONSTANT,_);let M=new cv.Size(26,26);cv.resize(R,P,M,0,0,cv.INTER_AREA),cv.copyMakeBorder(P,I,1,1,1,1,cv.BORDER_CONSTANT,_),G.set(v,I),R.delete(),P.delete(),cv.rectangle(A,S,N,T,2,cv.LINE_AA,0)}),p.delete(),m.delete(),a.delete(),f.delete(),E.delete(),x.delete(),b.delete(),z.delete(),h.delete(),L.delete(),B.delete(),V.delete(),k.delete(),H.delete();let w=[...G];if(w.sort((v,T)=>v[0].x<T[0].x?-1:1),n&&w.length>3){const v=(w[w.length-1][0].x-w[0][0].x)/w.length;let T=v,S=0,N=0,R=800;const P=[];for(let _=0;_<w.length-1;_++){let M=w[_+1][0].x-w[_][0].x;M<T&&(T=M),M>1.7*v&&P.push(_),w[_][0].y<R&&(R=w[_][0].y),w[_][0].height>S&&(S=w[_][0].height),w[_][0].width>N&&(N=w[_][0].width)}const I=(w[w.length-1][0].x-w[0][0].x)/(w.length+P.length);P.forEach(_=>{let M=w[_][0].x+I,ne=new cv.Scalar(0,0,0),Y=new cv.Point(M,R),W=new cv.Point(M+N,R+S),K=new cv.Rect(M,R,N,S),Z=new cv.Mat,oe=new cv.Mat,ue=new cv.Mat;Z=ee(A,K);let ke=new cv.Size(26,26);cv.resize(Z,oe,ke,0,0,cv.INTER_AREA);let De=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(oe,ue,1,1,1,1,cv.BORDER_CONSTANT,De),G.set(K,ue),Z.delete(),oe.delete(),cv.rectangle(A,Y,W,ne,2,cv.LINE_AA,0)}),w=[...G],w.sort((_,M)=>_[0].x<M[0].x?-1:1)}return{letter:w,invert_final:A}}(t,!1,o,i);let c=[];e.forEach(s=>{c.push([s.padEnd(22," "),0])});const d=[];for(let s=0;s<l.letter.length;s++){let h=n.predict(q(l.letter[s][1]));r&&("1"===h[0]&&(h[0]="i"),"0"===h[0]&&(h[0]="o"),"5"===h[0]&&(h[0]="s"),"3"===h[0]&&(h[0]="b"),"9"===h[0]&&(h[0]="g")),d.push(h)}for(let s=0;s<c.length;s++){for(let h=0;h<13;h++)h<d.length&&(c[s][1]=c[s][0].substring(h,h+1).toLowerCase()===d[h][0].toLowerCase()?c[s][1]+d[h][1]:r?c[s][1]+(1-d[h][1])/35:c[s][1]+(1-d[h][1])/9);c[s][1]=c[s][1]/d.length}for(let s=0;s<c.length;s++)c[s][0]=c[s][0].trim(),c[s][1]=c[s][1]-Math.abs(c[s][0].length-d.length)/c[s][0].length;return c.sort((s,h)=>s[1]<h[1]?1:-1),{debug:l.invert_final,solution:c[0]}}(n,t.payload.match,o,!0,e,t.payload.preference);postMessage({msg:t.msg,payload:{debug:q(r.debug),solution:r.solution},uid:t.uid}),r.debug.delete(),n.delete()})}function he(t,e){let n=cv.matFromImageData(t.payload.image),o=cv.matFromImageData(t.payload.template);const r=ae(e);r.isWarmedUp.then(()=>{const i=function Pe(t,e,n,o,r,i,l){let c=[];n.forEach(a=>{c.push([a.padEnd(22," "),0])});let d=new cv.Mat;cv.cvtColor(t,d,cv.COLOR_RGBA2GRAY,0);let s=new cv.Mat;cv.cvtColor(e,s,cv.COLOR_RGBA2GRAY,0);const h=Q(d,l);console.error(h);const p=new Map;for(let a=0;a<h.cases.length;a++){const f=h.cases.sort(Me)[a],g=ce(f),E=_e(f);let x=new cv.Mat,b=new cv.Mat,z=new cv.Size(26,26);const L=j(s,E,g);cv.resize(L,x,z,0,0,cv.INTER_AREA);let B=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(x,b,1,1,1,1,cv.BORDER_CONSTANT,B),p.set(E,b),x.delete(),L.delete()}const m=[];for(let a=0;a<[...p].length;a++)if(Te([...p][a][1])>.15){let g=o.predict(q([...p][a][1]));i&&("1"===g[0]&&(g[0]="i"),"0"===g[0]&&(g[0]="o"),"5"===g[0]&&(g[0]="s"),"3"===g[0]&&(g[0]="b"),"9"===g[0]&&(g[0]="g")),m.push(g)}else m.push(["",1]);let u=0;m.forEach((a,f)=>{""!==a[0]&&(u=f)});let y=m.slice(0,u+1);for(let a=0;a<c.length;a++){for(let f=0;f<13;f++)f<y.length&&(c[a][1]=c[a][0].substring(f,f+1).toLowerCase()===y[f][0].toLowerCase()?c[a][1]+y[f][1]:i?c[a][1]+(1-y[f][1])/35:c[a][1]+(1-y[f][1])/9);c[a][1]=c[a][1]/y.length}for(let a=0;a<c.length;a++)c[a][0]=c[a][0].trim(),c[a][1]=c[a][1]-Math.abs(c[a][0].length-y.length)/c[a][0].length;c.sort((a,f)=>a[1]<f[1]?1:-1),d.delete(),s.delete();for(let a=0;a<[...p].length;a++)[...p][a][1].delete();for(let a=0;a<h.cases.length;a++)h.cases[a].delete();for(let a=0;a<h.img_cases.length;a++)h.img_cases[a].delete();return{solution:c[0]}}(o,n,t.payload.match,r,0,e,t.payload.preference);postMessage({msg:t.msg,payload:{solution:i.solution},uid:t.uid}),i.debug.delete(),n.delete(),o.delete()})}function q(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,r=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,r),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}function ee(t,e,n){const o=t.size().width,r=t.size().height;return e.x+e.width>o&&(e.width=o-e.x),e.y+e.height>r&&(e.height=r-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function Be(t,e){let n=e,o=t,r=t,i=e;t.x>e.x&&(n=t,o=e),t.y>e.y&&(r=e,i=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let l=e,c=t,d=e,s=t;return t.right>e.right&&(l=t,c=e),t.bottom>e.bottom&&(d=t,s=e),n.x<o.right&&i.y>r.y+r.height?new cv.Rect(o.x,s.y,l.right-o.x,d.bottom-r.y):n.x>o.x+o.width+5||i.y>r.y+r.height?null:new cv.Rect(o.x,s.y,l.right-o.x,d.bottom-r.y)}function ve(t){for(let e=0;e<t.length-1;e++){const n=t[e];for(let o=e+1;o<t.length;o++){const r=t[o],i=Be(n,r);if(null!==i)return{u:i,toRemove1:n,toRemove2:r}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(n=>{cv=n,n.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function ze(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),n=new cv.Mat;const o=new ImageData(new Uint8ClampedArray(t.payload.image),t.payload.imageWidth,t.payload.imageHeight);let r=cv.matFromImageData(o);n=ee(r,e),postMessage({msg:t.msg,payload:q(n),uid:t.uid}),n.delete(),r.delete()}(t.data);case"nameprediction":return de(t.data,!0);case"ineprediction":return de(t.data,!1);case"namepredictionTemplate":return he(t.data,!0);case"inepredictionTemplate":return he(t.data,!1);case"groupImagePerContoursLength":return function Ne(t){0===t.payload.images.length&&postMessage({msg:t.msg,payload:[],uid:t.uid});const e=t.payload.images[t.payload.images.length-1].studentIndex+1,o=t.payload.nbrCluster,i=new cv.TermCriteria(cv.TermCriteria_EPS+cv.TermCriteria_MAX_ITER,1e3,.001),l=[];for(let u=0;u<e;u++){let y=0,a=0;const f=t.payload.images.length/e;for(let g=0;g<f;g++){const E=new ImageData(new Uint8ClampedArray(t.payload.images[u*f+g].image),t.payload.images[u*f+g].width,t.payload.images[u*f+g].height);let x=cv.matFromImageData(E);const b=new cv.Mat;cv.cvtColor(x,b,cv.COLOR_RGBA2GRAY);const z=new cv.Mat;cv.Canny(b,z,100,200,3);const A=new cv.MatVector,k=new cv.Mat;cv.findContours(z,A,k,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);for(let H=0;H<A.size();H++){const G=A.get(H),O=cv.arcLength(G,!0);O>3&&(y+=O,a+=1)}x.delete(),b.delete(),z.delete(),A.delete(),k.delete()}l.push(y),l.push(a)}const c=new cv.Mat,d=new cv.Mat,s=cv.matFromArray(l.length/2,2,cv.CV_32F,l);cv.kmeans(s,o,c,i,5,cv.KMEANS_PP_CENTERS,d);let h=[];for(let u=0;u<o;u++)h.push(d.data32F[2*u+1]);h.sort(function(u,y){return u-y});let p=new Map;for(let u=0;u<o;u++)p.set((d.data32F.indexOf(h[u])-1)/2,u);let m=[];for(let u=0;u<e;u++)m.push(p.get(c.data32S[u]));postMessage({msg:t.msg,payload:m,uid:t.uid}),c.delete(),d.delete(),s.delete()}(t.data);case"qcmresolution":return function we(t){const e={solutions:[]};let n=cv.matFromImageData(t.payload.imageTemplate),o=new cv.Mat;cv.cvtColor(n,o,cv.COLOR_RGBA2GRAY,0);const r=Q(o,t.payload.preference);t.payload.pages?.forEach((i,l)=>{let c=new cv.Mat,d=cv.matFromImageData(i.imageInput),s=new cv.Mat,h=new cv.Size(n.size().width,n.size().height);cv.resize(d,s,h,0,0,cv.INTER_AREA),cv.cvtColor(s,c,cv.COLOR_RGBA2GRAY,0);{const p=Q(c,t.payload.preference),m=function xe(t,e){const n=[];return t.cases.forEach(o=>{let i,r=500;if(e.cases.forEach(l=>{const c=function Oe(t,e){const n=cv.boundingRect(t),o=cv.boundingRect(e);let r=n.x+n.width/2,i=n.y+n.height/2,l=o.x+o.width/2,c=o.y+o.height/2;return Math.sqrt((r-l)*(r-l)+(i-c)*(i-c))}(o,l);r>c&&c<25&&(r=c,i=l)}),void 0!==i){let l=C(o),c=C(i);n.push({x:l.x-c.x,y:l.y-c.y})}}),function pe(t){if(t.length>0){let e=0,n=0;return t.forEach(o=>{e+=o.x,n+=o.y}),{x:e/t.length,y:n/t.length}}return{x:0,y:0}}(n)}(p,r),u=function be(t,e){let n=new cv.Mat;if(0!==e.x||0!==e.y){let o=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),r=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,n,o,r,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),n}return t}(s,m);let y=function Ae(t,e,n,o){const r=[],i=[];let l=new Map;const c=new Map;return t.cases.forEach((d,s)=>{const h=se(j(e,C(d),D(d)));c.set(s,h)}),t.cases.forEach((d,s)=>{const h=j(n,C(d),D(d)),m=se(h)-c.get(s);m>o.qcm_differences_avec_case_blanche?(l.set(s,{verdict:!0,prediction:m}),r.push(d)):(l.set(s,{verdict:!1,prediction:m}),i.push(d)),m>o.qcm_differences_avec_case_blanche&&m<1.15*o.qcm_differences_avec_case_blanche?cv.putText(n,""+m.toFixed(2),{x:C(d).x,y:C(d).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(n,""+m.toFixed(2),{x:C(d).x,y:C(d).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),h.delete()}),le(n,r,new cv.Scalar(0,255,0,128),2),le(n,i,new cv.Scalar(0,0,255,128),2),l}(r,n,u,t.payload.preference),a=function me(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,r=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,r),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}(u),f=[];y.forEach((g,E)=>{g.verdict&&f.push(String.fromCharCode(97+E))}),e.solutions?.push({imageSolution:a,numero:l,solution:f.join("&")}),c.delete(),s.delete(),d.delete(),u!==s&&u.delete(),p.cases.forEach(g=>g.delete()),p.img_cases.forEach(g=>g.delete())}}),n.delete(),o.delete(),r.img_cases.forEach(i=>i.delete()),postMessage({msg:t.msg,payload:e,uid:t.uid})}(t.data)}})})();