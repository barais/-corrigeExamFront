(()=>{"use strict";var n,pe={5299:(n,M,s)=>{var E=s(75e3),_=s(32076),x=s(54968),y=s(54004),K=s(39300),C=s(971),$=s(24351),S=s(54469);var ye=s(68306);!function ae(T){const e=new T,t=(0,x.R)(self,"message");return function ve(T,e){const t=e.pipe((0,y.U)(a=>a.data),(0,y.U)(a=>new E.P_(a.kind,a.value,a.error)),(0,K.h)(a=>"C"!==a.kind),(0,C.D)());return function w(T){return!!T.workUnit}(T)?t.pipe((0,$.b)(a=>(0,_.D)(T.workUnit(a)).pipe((0,S.i)()))):T.work(t).pipe((0,S.i)())}(e,t).subscribe(a=>{const f=postMessage;(function l(T){return!!T.selectTransferables})(e)&&a.hasValue?f(a,e.selectTransferables(a.value)):f(a)})}(class we{constructor(){this.opencvready=new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(a=>{cv=a,cv.ready.then(()=>{e()}).catch(f=>{console.log(f)})})}},t.importScripts(t.Module.scriptUrl)})}workUnit(e){return new ye.y(t=>{this.opencvready.then(()=>{if(e.marker){const a=this.alignImageBasedOnCircle(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,e.pageNumber);a.pageNumber=e.pageNumber,t.next(a),t.complete()}else try{const a=this.alignImage(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,!1,5,0,e.pageNumber);a.pageNumber=e.pageNumber,t.next(a),t.complete()}catch(a){console.error(a)}}).catch(a=>{console.log(a)})})}selectTransferables(e){return[e.imageAligned]}imageDataFromMat(e){const t=new cv.Mat,a=e.type()%8,f=a<=cv.CV_8S?1:a<=cv.CV_32S?1/256:255,c=a===cv.CV_8S||a===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,f,c),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const U=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),U}roi(e,t,a){const f=e.size().width,c=e.size().height;return t.x+t.width>f&&(t.width=f-t.x),t.y+t.height>c&&(t.height=c-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,a,f,c,U,I,B,j,m){const z=new ImageData(new Uint8ClampedArray(e),a,f),o=new ImageData(new Uint8ClampedArray(t),c,U),G=cv.matFromImageData(z);let H=cv.matFromImageData(o),u=new cv.Mat,A=new cv.Mat;cv.cvtColor(H,u,cv.COLOR_BGRA2GRAY),cv.cvtColor(G,A,cv.COLOR_BGRA2GRAY);const P=Math.trunc(G.size().width/20);let D=[],p=[],W={},k=!1,O=!1,v=!1,V=!1;const R=Math.min(u.size().width,A.size().width),L=Math.min(u.size().height,A.size().height);if(I){let i=new cv.Rect(0,0,R,L);k=this.matchSmallImage(u,A,D,p,i,1,B,j,m),O=!0,v=!0,V=!0}else{let i=P;for(;!k&&i<3*R/4&&i<2*L/3;){let b=new cv.Rect(0,0,i,i);k=this.matchSmallImage(u,A,D,p,b,1,B,j,m),k||(i+=Math.trunc(R/10))}for(i=P;!O&&i<3*R/4&&i<2*L/3;){let b=new cv.Rect(R-i,0,R,i);O=this.matchSmallImage(u,A,D,p,b,2,B,j,m),O||(i+=Math.trunc(R/10))}for(i=P;!v&&i<3*R/4&&i<2*L/3;){let b=new cv.Rect(0,L-i,i,L);v=this.matchSmallImage(u,A,D,p,b,3,B,j,m),v||(i+=Math.trunc(R/10))}for(i=P;!V&&i<3*R/4&&i<2*L/3;){let b=new cv.Rect(R-i,L-i,R,L);V=this.matchSmallImage(u,A,D,p,b,4,B,j,m),V||(i+=Math.trunc(R/10))}}if(k&&O&&v&&V){let i=cv.matFromArray(4,1,cv.CV_32FC2,D),b=cv.matFromArray(4,1,cv.CV_32FC2,p),Z=cv.getPerspectiveTransform(i,b),r=new cv.Mat;cv.warpPerspective(H,r,Z,G.size(),cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),W.imageAligned=this.imageDataFromMat(r).data.buffer,W.imageAlignedWidth=r.size().width,W.imageAlignedHeight=r.size().height,i.delete(),b.delete(),r.delete(),console.log("Good match for page "+m)}else W.imageAligned=t.slice(0),W.imageAlignedWidth=c,W.imageAlignedHeight=U,console.log("no match for page "+m);return H.delete(),G.delete(),u.delete(),A.delete(),W}matchSmallImage(e,t,a,f,c,U,I,B,j){let m=new cv.Mat;m=this.roi(e,c,m);let z=new cv.Mat;z=this.roi(t,c,z);let o=new cv.KeyPointVector,G=new cv.KeyPointVector,H=new cv.Mat,u=new cv.Mat,A=new cv.AKAZE,P=new cv.Mat,D=new cv.Mat;A.detectAndCompute(m,P,o,H),A.detectAndCompute(z,D,G,u);let p=new cv.DMatchVector,W=new cv.BFMatcher,k=new cv.DMatchVectorVector;W.knnMatch(H,u,k,2);for(let r=0;r<k.size();++r){let N=k.get(r),J=N.get(0),Q=N.get(1),Y="0.7";void 0!==J&&void 0!==Q&&J.distance<=Q.distance*parseFloat(Y)&&p.push_back(J)}let O=[],v=[];for(let r=0;r<p.size();r++)O.push(o.get(p.get(r).queryIdx).pt.x+c.x),O.push(o.get(p.get(r).queryIdx).pt.y+c.y),v.push(G.get(p.get(r).trainIdx).pt.x+c.x),v.push(G.get(p.get(r).trainIdx).pt.y+c.y);let V=0,R=[];if(0===p.size())return!1;for(let r=0;r<p.size();r++){let N=(O[2*r]-v[2*r])*(O[2*r]-v[2*r])+(O[2*r+1]-v[2*r+1])*(O[2*r+1]-v[2*r+1]);N<Math.trunc(3*m.size().width/20)*Math.trunc(3*m.size().width/20)&&(R.push(N),V+=1)}const L=this.numAverage(R),i=this.dev(R);if(V<=I)return A.delete(),o.delete(),G.delete(),H.delete(),u.delete(),P.delete(),D.delete(),m.delete(),z.delete(),k.delete(),p.delete(),W.delete(),!1;let b=0,Z=[];for(let r=0;r<p.size();r++){let N=(O[2*r]-v[2*r])*(O[2*r]-v[2*r])+(O[2*r+1]-v[2*r+1])*(O[2*r+1]-v[2*r+1]);if(N<L+1*i&&N>L-1*i){b+=1,Z.push(r);break}}return b<=B?(A.delete(),o.delete(),G.delete(),H.delete(),u.delete(),P.delete(),D.delete(),m.delete(),z.delete(),k.delete(),p.delete(),W.delete(),!1):(Z.forEach(r=>{a.push(o.get(p.get(+r).queryIdx).pt.x+c.x),a.push(o.get(p.get(+r).queryIdx).pt.y+c.y),f.push(G.get(p.get(+r).trainIdx).pt.x+c.x),f.push(G.get(p.get(+r).trainIdx).pt.y+c.y)}),A.delete(),o.delete(),G.delete(),H.delete(),u.delete(),P.delete(),D.delete(),m.delete(),z.delete(),k.delete(),p.delete(),W.delete(),!0)}numAverage(e){return e.reduce((t,a)=>t+a,0)/e.length}dev(e){let t=e.reduce((f,c)=>f+c,0)/e.length,a=(e=e.map(f=>(f-t)**2)).reduce((f,c)=>f+c,0);return Math.sqrt(a/e.length)}alignImageBasedOnCircle(e,t,a,f,c,U,I){const B=new ImageData(new Uint8ClampedArray(e),a,f),j=new ImageData(new Uint8ClampedArray(t),c,U);let u,A,P,D,p,W,k,O,v,V,R,L,m=cv.matFromImageData(B),z=new cv.Mat,o=new cv.Mat;cv.cvtColor(m,m,cv.COLOR_RGBA2GRAY),cv.HoughCircles(m,o,cv.HOUGH_GRADIENT,1,45,75,20,6*m.cols/1e3,20*m.cols/1e3),o.cols>0&&(u=o.data32F[0],A=o.data32F[1],P=o.data32F[2],D=o.data32F[0],p=o.data32F[1],W=o.data32F[2],k=o.data32F[0],O=o.data32F[1],v=o.data32F[2],V=o.data32F[0],R=o.data32F[1],L=o.data32F[2]);const i=m.size().width,b=m.size().height;if(o.cols>0)for(let F=1;F<o.cols;F++){let h=o.data32F[3*F],g=o.data32F[3*F+1],X=o.data32F[3*F+2];h*h+g*g<=u*u+A*A&&(u=h,A=g,P=X),h*h+g*g>=V*V+R*R&&(V=h,R=g,L=X),(i-h)*(i-h)+g*g<=(i-D)*(i-D)+p*p&&(D=h,p=g,W=X),h*h+(b-g)*(b-g)<=k*k+(b-O)*(b-O)&&(k=h,O=g,v=X)}let Z=cv.matFromImageData(j),r=new cv.Mat,N=new cv.Mat;cv.cvtColor(Z,r,cv.COLOR_RGBA2GRAY);const J=r.size().width,Q=r.size().height;cv.HoughCircles(r,N,cv.HOUGH_GRADIENT,1,45,75,15,v-3,v+3);let Y=[],se=[];const Ce=180*(4*v*v-3.14159*v*v)/100;for(let F=0;F<N.cols;F++){let h=N.data32F[3*F],g=N.data32F[3*F+1];const X=h-v,ne=g-v;let ee=2*v,te=2*v;X+ee>J&&(ee=J-X),ne+te>Q&&(te=Q-ne);let ge=new cv.Rect(h-v,g-v,ee,te),re=new cv.Mat;re=this.roi(r,ge,re),cv.threshold(re,re,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(re)<Ce&&(Y.push(h),se.push(g)),re.delete()}let le,ce,oe,de,he,ue,fe,me;if(Y.length>0&&(le=Y[0],ce=se[1],oe=Y[0],de=se[1],he=Y[0],ue=se[1],fe=Y[0],me=se[1]),Y.length>1)for(let F=0;F<Y.length;F++){let h=Y[F],g=se[F];h*h+g*g<=le*le+ce*ce&&(le=h,ce=g),h*h+g*g>=fe*fe+me*me&&(fe=h,me=g),(J-h)*(J-h)+g*g<=(J-oe)*(J-oe)+de*de&&(oe=h,de=g),h*h+(Q-g)*(Q-g)<=he*he+(Q-ue)*(Q-ue)&&(he=h,ue=g)}if(Y.length>=4){let F=cv.matFromArray(4,1,cv.CV_32FC2,[u,A,D,p,k,O,V,R]),h=cv.matFromArray(4,1,cv.CV_32FC2,[le,ce,oe,de,he,ue,fe,me]),g=cv.getPerspectiveTransform(h,F),X=new cv.Size(m.cols,m.rows);for(let te=0;te<F.rows;++te){let Ae=15,Me=new cv.Point(h.data32F[2*te],h.data32F[2*te+1]);cv.circle(Z,Me,Ae,[0,0,255,255],1)}cv.warpPerspective(Z,z,g,X,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let ne=z.clone(),ee={};return ee.imageAligned=this.imageDataFromMat(ne).data.buffer,ee.imageAlignedWidth=ne.size().width,ee.imageAlignedHeight=ne.size().height,m.delete(),z.delete(),o.delete(),r.delete(),Z.delete(),N.delete(),F.delete(),h.delete(),ne.delete(),ee}return m.delete(),z.delete(),o.delete(),r.delete(),Z.delete(),N.delete(),this.alignImage(e,t,a,f,c,U,!1,5,0,I)}})},96921:(n,M,s)=>{s.d(M,{w0:()=>y,Nn:()=>C});var E=s(30576),_=s(87896),x=s(38737);class y{constructor(l){this.initialTeardown=l,this.closed=!1,this._parentage=null,this._teardowns=null}unsubscribe(){let l;if(!this.closed){this.closed=!0;const{_parentage:w}=this;if(w)if(this._parentage=null,Array.isArray(w))for(const q of w)q.remove(this);else w.remove(this);const{initialTeardown:ve}=this;if((0,E.m)(ve))try{ve()}catch(q){l=q instanceof _.B?q.errors:[q]}const{_teardowns:ae}=this;if(ae){this._teardowns=null;for(const q of ae)try{$(q)}catch(ie){l=null!=l?l:[],ie instanceof _.B?l=[...l,...ie.errors]:l.push(ie)}}if(l)throw new _.B(l)}}add(l){var w;if(l&&l!==this)if(this.closed)$(l);else{if(l instanceof y){if(l.closed||l._hasParent(this))return;l._addParent(this)}(this._teardowns=null!==(w=this._teardowns)&&void 0!==w?w:[]).push(l)}}_hasParent(l){const{_parentage:w}=this;return w===l||Array.isArray(w)&&w.includes(l)}_addParent(l){const{_parentage:w}=this;this._parentage=Array.isArray(w)?(w.push(l),w):w?[w,l]:l}_removeParent(l){const{_parentage:w}=this;w===l?this._parentage=null:Array.isArray(w)&&(0,x.P)(w,l)}remove(l){const{_teardowns:w}=this;w&&(0,x.P)(w,l),l instanceof y&&l._removeParent(this)}}function C(S){return S instanceof y||S&&"closed"in S&&(0,E.m)(S.remove)&&(0,E.m)(S.add)&&(0,E.m)(S.unsubscribe)}function $(S){(0,E.m)(S)?S():S.unsubscribe()}y.EMPTY=(()=>{const S=new y;return S.closed=!0,S})()},63269:(n,M,s)=>{s.d(M,{yG:()=>y});var E=s(93532);function y(C){return(0,E.K)(function _(C){return C[C.length-1]}(C))?C.pop():void 0}},54482:(n,M,s)=>{s.d(M,{e:()=>x});var E=s(30576);function x(y){return K=>{if(function _(y){return(0,E.m)(null==y?void 0:y.lift)}(K))return K.lift(function(C){try{return y(C,this)}catch($){this.error($)}});throw new TypeError("Unable to lift unknown Observable type")}}}},_e={};function d(n){var M=_e[n];if(void 0!==M)return M.exports;var s=_e[n]={exports:{}};return pe[n](s,s.exports,d),s.exports}d.m=pe,d.x=()=>{var n=d.O(void 0,[579],()=>d(5299));return d.O(n)},n=[],d.O=(M,s,E,_)=>{if(!s){var y=1/0;for(x=0;x<n.length;x++){for(var[s,E,_]=n[x],K=!0,C=0;C<s.length;C++)(!1&_||y>=_)&&Object.keys(d.O).every(ae=>d.O[ae](s[C]))?s.splice(C--,1):(K=!1,_<y&&(y=_));if(K){n.splice(x--,1);var $=E();void 0!==$&&(M=$)}}return M}_=_||0;for(var x=n.length;x>0&&n[x-1][2]>_;x--)n[x]=n[x-1];n[x]=[s,E,_]},d.d=(n,M)=>{for(var s in M)d.o(M,s)&&!d.o(n,s)&&Object.defineProperty(n,s,{enumerable:!0,get:M[s]})},d.f={},d.e=n=>Promise.all(Object.keys(d.f).reduce((M,s)=>(d.f[s](n,M),M),[])),d.u=n=>n+".cc6d8e69d39a1e39.js",d.miniCssF=n=>{},d.o=(n,M)=>Object.prototype.hasOwnProperty.call(n,M),(()=>{var n;d.tt=()=>(void 0===n&&(n={createScriptURL:M=>M},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(n=trustedTypes.createPolicy("angular#bundler",n))),n)})(),d.tu=n=>d.tt().createScriptURL(n),d.p="",(()=>{var n={13:1};d.f.i=(_,x)=>{n[_]||importScripts(d.tu(d.p+d.u(_)))};var s=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],E=s.push.bind(s);s.push=_=>{var[x,y,K]=_;for(var C in y)d.o(y,C)&&(d.m[C]=y[C]);for(K&&K(d);x.length;)n[x.pop()]=1;E(_)}})(),(()=>{var n=d.x;d.x=()=>d.e(579).then(n)})(),d.x()})();