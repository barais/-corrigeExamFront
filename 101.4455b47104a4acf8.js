(()=>{"use strict";function F(e){return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function j(e,t,o){return(t=function me(e){var t=function ge(e,t){if("object"!==F(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var n=o.call(e,t||"default");if("object"!==F(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===F(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class ae{constructor(t){j(this,"alphabet",void 0),j(this,"characters",void 0),j(this,"isWarmedUp",void 0),j(this,"_model",void 0),t?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(t)}initModel(t){return new Promise(o=>{tf.setBackend("wasm").then(()=>{this.loadModel(t).then().then(()=>{console.info("Backend running on:",tf.getBackend()),o()})})})}loadModel(t){return console.time("Load model"),t?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(o=>{this._model=o,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(o=>{this._model=o,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(t){const a=t.width>t.height,i=Math.round((Math.max(t.width,t.height)-Math.min(t.width,t.height))/2),r=a?[[i,i],[0,0],[0,0]]:[[0,0],[i,i],[0,0]];return tf.tidy(()=>{let h=tf.browser.fromPixels(t,1).pad(r,255);return h=tf.image.resizeBilinear(h,[24,24]).pad([[2,2],[2,2],[0,0]],255),h=tf.scalar(1).sub(h.toFloat().div(tf.scalar(255))),h.expandDims(0)})}predict(t){if(!this._model)return console.warn("Model not loaded yet!");const o=this.preprocessImage(t),n=this._model.predict(o).as1D(),c=n.argMax().dataSync()[0],a=n.max().dataSync()[0];return[this.characters[c],a]}}function $(e){const t=cv.boundingRect(e);return{w:t.width,h:t.height}}function S(e){const t=cv.boundingRect(e);return{w:t.width,h:t.height}}function k(e){const t=cv.boundingRect(e);return{x:t.x,y:t.y}}function E(e){const t=cv.boundingRect(e);return{x:t.x,y:t.y}}function ye(e,t){const o=t.qcm_epsilon*cv.arcLength(e,!0),n=new cv.Mat;let c;cv.approxPolyDP(e,n,o,!0);const a=S(n);if(a.w>=t.qcm_min_width_shape&&a.h>=t.qcm_min_height_shape){const i=n.rows;if(1===i)c="LIGNE";else if(3===i)c="TRIANGLE";else if(4===i){const r=a.w/a.h;c=r>=.95&&r<=1.05?"CARRE":"RECTANGLE"}else c=void 0}return{nom:c,forme:n}}function Me(e,t){let o=E(e),n=E(t);return o.y<n.y?-1:o.y>n.y?1:o.x-n.x}function Ce(e,t){let o=E(e),n=E(t);return o.x-n.x}function se(e,t){let o=E(e),n=E(t),c=S(e),a=S(t);return(n.x>=o.x&&n.x<=o.x+c.w||n.x+a.w>=o.x&&n.x+a.w<=o.x+c.w)&&(n.y>=o.y&&n.y<=o.y+c.h||n.y+a.h>=o.y&&n.y+a.h<=o.y+c.h)}function J(e,t){const o=function Re(e,t=[],o){const n=new cv.Mat;cv.threshold(e,n,245,255,cv.THRESH_BINARY);let c=new cv.MatVector,a=new cv.Mat;cv.findContours(n,c,a,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const i=[];for(let s=0;s<c.size();++s){const u=ye(c.get(s),o);t.includes(u.nom)&&i.push(u.forme)}i.sort(Me);const r=[],h=[],l=[];return i.forEach(s=>{0===E(s).x&&0===E(s).y||(100*S(s).w/S(e).w+100*S(s).h/S(e).h)/2>80?h.push(s):l.push(s)}),l.forEach((s,m)=>{!function Se(e,t){let o=t[e],n=!1;return t.forEach((c,a)=>{e<a&&function Ee(e,t){return se(e,t)||se(t,e)}(o,c)&&(n=!0)}),n}(m,l)?r.push(s):h.push(s)}),h.forEach(s=>{s.delete()}),r}(e,["CARRE","RECTANGLE"],t),n=[],c=[];return o.forEach(a=>{const i=$(a),r=k(a);n.push(a),c.push(q(e,r,i))}),{cases:n,img_cases:c}}function q(e,t,o){let n=new cv.Mat,c=t.x,a=t.y,i=o.w,r=o.h;c<0&&(c=0),a<0&&(a=0),c+i>e.size().width&&(i=e.size().width-c),r+a>e.size().height&&(r=e.size().height-a);const h=new cv.Rect(c,a,i,r);return i<=0||r<=0?e:(n=e.roi(h),n)}function ie(e,t,o=new cv.Scalar(255,0,0,128),n=2){return t.forEach(c=>{const a=E(c),i=S(c);let r=new cv.Point(a.x,a.y),h=new cv.Point(a.x+i.w,a.y+i.h);cv.rectangle(e,r,h,o,n,0)}),e}function le(e){return 1-cv.countNonZero(e)/(e.rows*e.cols)}function Te(e){let t=new cv.Mat;cv.adaptiveThreshold(e,t,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY_INV,3,2);let c,o=new cv.MatVector,n=new cv.Mat;cv.findContours(t,o,n,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE);for(let a=0;a<o.size();++a){let i=o.get(a),r=cv.boundingRect(i);r.width>1&&r.height>1&&(void 0!==c&&(c.width>r.width||c.height>r.height)||(c=r))}if(void 0!==c){let a=new cv.Mat;a=t.roi(c);let i=cv.countNonZero(a)/(c.width*c.height);return a.delete(),t.delete(),i}return t.delete(),0}let ee,te;function de(e){return e?(void 0===ee&&(ee=new ae(e)),ee):(void 0===te&&(te=new ae(e)),te)}function he(e,t){let o=cv.matFromImageData(e.payload.image);const n=de(t);n.isWarmedUp.then(()=>{const c=function Le(e,t,o,n,c,a){const i=function Be(e,t,o,n){const c=n.linelength,a=n.repairsize,i=n.dilatesize,r=n.morphsize,h=n.drawcontoursizeh,l=n.drawcontoursizev;let s=e.clone(),m=new cv.Mat;cv.cvtColor(e,m,cv.COLOR_BGR2GRAY,0);let u=new cv.Mat;cv.threshold(m,u,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let f=new cv.Point(-1,-1);if(t){let g=new cv.Mat,N=new cv.Size(1,c),C=cv.getStructuringElement(cv.MORPH_RECT,N);cv.morphologyEx(u,g,cv.MORPH_OPEN,C,f,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let z=new cv.MatVector,R=new cv.Mat;cv.findContours(g,z,R,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let L=new cv.Scalar(255,255,255);cv.drawContours(s,z,-1,L,l);let I=new cv.Mat,y=new cv.Size(c,1),M=cv.getStructuringElement(cv.MORPH_RECT,y),ce=new cv.Point(-1,-1);cv.morphologyEx(u,I,cv.MORPH_OPEN,M,ce,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let X=new cv.MatVector,K=new cv.Mat;cv.findContours(I,X,K,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let Z=new cv.Scalar(255,255,255);cv.drawContours(s,X,-1,Z,h),g.delete(),z.delete(),R.delete(),C.delete(),I.delete(),X.delete(),K.delete(),M.delete()}let _=new cv.Size(a,a),d=cv.getStructuringElement(cv.MORPH_ELLIPSE,_),v=new cv.Mat,b=cv.Mat.ones(e.rows,e.cols,cv.CV_8UC3);b.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(b,b,cv.COLOR_BGR2GRAY,0);let x=new cv.Mat;cv.cvtColor(s,x,cv.COLOR_BGR2GRAY,0);let O=new cv.Mat;cv.subtract(b,x,O,v,-1);let P=new cv.Mat;cv.dilate(O,P,d,f,i,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let B=new cv.Mat,H=new cv.Mat;cv.bitwise_and(P,u,B),cv.morphologyEx(B,H,cv.MORPH_CLOSE,d,f,r,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let G=new cv.Mat;cv.bitwise_and(H,u,G);let A=new cv.Mat;cv.subtract(b,G,A,v,-1);let D=new cv.MatVector,V=new cv.Mat;cv.findContours(G,D,V,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const U=new Map;let T=[];for(let g=0;g<D.size();g++){let N=D.get(g),C=cv.boundingRect(N);(C.width>12||C.height>12)&&T.push(C)}let Y=ue(T),oe=0;for(;null!==Y&&oe<200;)T=T.filter(g=>g!==Y.toRemove1&&g!==Y.toRemove2),T.push(Y.u),Y=ue(T),oe+=1;T.forEach(g=>{let N=new cv.Scalar(0,0,0),C=new cv.Point(g.x,g.y),z=new cv.Point(g.x+g.width,g.y+g.height),R=new cv.Mat,L=new cv.Mat,I=new cv.Mat,y=new cv.Scalar(255,0,0,255);R=ne(A,g),g.width>g.height?cv.copyMakeBorder(R,R,(g.width-g.height)/2,(g.width-g.height)/2,1,1,cv.BORDER_CONSTANT,y):cv.copyMakeBorder(R,R,1,1,(g.height-g.width)/2,(g.height-g.width)/2,cv.BORDER_CONSTANT,y);let M=new cv.Size(26,26);cv.resize(R,L,M,0,0,cv.INTER_AREA),cv.copyMakeBorder(L,I,1,1,1,1,cv.BORDER_CONSTANT,y),U.set(g,I),R.delete(),L.delete(),cv.rectangle(A,C,z,N,2,cv.LINE_AA,0)}),m.delete(),u.delete(),d.delete(),v.delete(),b.delete(),x.delete(),O.delete(),P.delete(),s.delete(),B.delete(),H.delete(),G.delete(),D.delete(),V.delete();let p=[...U];if(p.sort((g,N)=>g[0].x<N[0].x?-1:1),o&&p.length>3){const g=(p[p.length-1][0].x-p[0][0].x)/p.length;let N=g,C=0,z=0,R=800;const L=[];for(let y=0;y<p.length-1;y++){let M=p[y+1][0].x-p[y][0].x;M<N&&(N=M),M>1.7*g&&L.push(y),p[y][0].y<R&&(R=p[y][0].y),p[y][0].height>C&&(C=p[y][0].height),p[y][0].width>z&&(z=p[y][0].width)}const I=(p[p.length-1][0].x-p[0][0].x)/(p.length+L.length);L.forEach(y=>{let M=p[y][0].x+I,ce=new cv.Scalar(0,0,0),X=new cv.Point(M,R),K=new cv.Point(M+z,R+C),Z=new cv.Rect(M,R,z,C),Q=new cv.Mat,re=new cv.Mat,fe=new cv.Mat;Q=ne(A,Z);let ke=new cv.Size(26,26);cv.resize(Q,re,ke,0,0,cv.INTER_AREA);let He=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(re,fe,1,1,1,1,cv.BORDER_CONSTANT,He),U.set(Z,fe),Q.delete(),re.delete(),cv.rectangle(A,X,K,ce,2,cv.LINE_AA,0)}),p=[...U],p.sort((y,M)=>y[0].x<M[0].x?-1:1)}return{letter:p,invert_final:A}}(e,!1,n,a);let r=[];t.forEach(l=>{r.push([l.padEnd(22," "),0])});const h=[];for(let l=0;l<i.letter.length;l++){let s=o.predict(W(i.letter[l][1]));c&&("1"===s[0]&&(s[0]="i"),"0"===s[0]&&(s[0]="o"),"5"===s[0]&&(s[0]="s"),"3"===s[0]&&(s[0]="b"),"9"===s[0]&&(s[0]="g")),h.push(s)}for(let l=0;l<r.length;l++){for(let s=0;s<13;s++)s<h.length&&(r[l][1]=r[l][0].substring(s,s+1).toLowerCase()===h[s][0].toLowerCase()?r[l][1]+h[s][1]:c?r[l][1]+(1-h[s][1])/35:r[l][1]+(1-h[s][1])/9);r[l][1]=r[l][1]/h.length}for(let l=0;l<r.length;l++)r[l][0]=r[l][0].trim(),r[l][1]=r[l][1]-Math.abs(r[l][0].length-h.length)/r[l][0].length;return r.sort((l,s)=>l[1]<s[1]?1:-1),{debug:i.invert_final,solution:r[0]}}(o,e.payload.match,n,!0,t,e.payload.preference);postMessage({msg:e.msg,payload:{debug:W(c.debug),solution:c.solution},uid:e.uid}),c.debug.delete(),o.delete()})}function ve(e,t){let o=cv.matFromImageData(e.payload.image),n=cv.matFromImageData(e.payload.template);const c=de(t);c.isWarmedUp.then(()=>{const a=function Pe(e,t,o,n,c,a,i){let r=[];o.forEach(d=>{r.push([d.padEnd(22," "),0])});let h=new cv.Mat;cv.cvtColor(e,h,cv.COLOR_RGBA2GRAY,0);let l=new cv.Mat;cv.cvtColor(t,l,cv.COLOR_RGBA2GRAY,0);const s=J(h,i);console.error(s);const m=new Map;for(let d=0;d<s.cases.length;d++){const v=s.cases.sort(Ce)[d],w=S(v),b=E(v);let x=new cv.Mat,O=new cv.Mat,P=new cv.Size(26,26);const B=q(l,b,w);cv.resize(B,x,P,0,0,cv.INTER_AREA);let H=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(x,O,1,1,1,1,cv.BORDER_CONSTANT,H),m.set(b,O),x.delete(),B.delete()}const u=[];for(let d=0;d<[...m].length;d++)if(Te([...m][d][1])>.15){let w=n.predict(W([...m][d][1]));a&&("1"===w[0]&&(w[0]="i"),"0"===w[0]&&(w[0]="o"),"5"===w[0]&&(w[0]="s"),"3"===w[0]&&(w[0]="b"),"9"===w[0]&&(w[0]="g")),u.push(w)}else u.push(["",1]);let f=0;u.forEach((d,v)=>{""!==d[0]&&(f=v)});let _=u.slice(0,f+1);for(let d=0;d<r.length;d++){for(let v=0;v<13;v++)v<_.length&&(r[d][1]=r[d][0].substring(v,v+1).toLowerCase()===_[v][0].toLowerCase()?r[d][1]+_[v][1]:a?r[d][1]+(1-_[v][1])/35:r[d][1]+(1-_[v][1])/9);r[d][1]=r[d][1]/_.length}for(let d=0;d<r.length;d++)r[d][0]=r[d][0].trim(),r[d][1]=r[d][1]-Math.abs(r[d][0].length-_.length)/r[d][0].length;r.sort((d,v)=>d[1]<v[1]?1:-1),h.delete(),l.delete();for(let d=0;d<[...m].length;d++)[...m][d][1].delete();for(let d=0;d<s.cases.length;d++)s.cases[d].delete();for(let d=0;d<s.img_cases.length;d++)s.img_cases[d].delete();return{solution:r[0]}}(n,o,e.payload.match,c,0,t,e.payload.preference);postMessage({msg:e.msg,payload:{solution:a.solution},uid:e.uid}),a.debug.delete(),o.delete(),n.delete()})}function W(e){const t=new cv.Mat,o=e.type()%8,n=o<=cv.CV_8S?1:o<=cv.CV_32S?1/256:255,c=o===cv.CV_8S||o===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,n,c),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),a}function ne(e,t,o){const n=e.size().width,c=e.size().height;return t.x+t.width>n&&(t.width=n-t.x),t.y+t.height>c&&(t.height=c-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}function Ie(e,t){let o=t,n=e,c=e,a=t;e.x>t.x&&(o=e,n=t),e.y>t.y&&(c=t,a=e),e.right=e.x+e.width,t.right=t.x+t.width,e.bottom=e.y+e.height,t.bottom=t.y+t.height;let i=t,r=e,h=t,l=e;return e.right>t.right&&(i=e,r=t),e.bottom>t.bottom&&(h=e,l=t),o.x<n.right&&a.y>c.y+c.height?new cv.Rect(n.x,l.y,i.right-n.x,h.bottom-c.y):o.x>n.x+n.width+5||a.y>c.y+c.height?null:new cv.Rect(n.x,l.y,i.right-n.x,h.bottom-c.y)}function ue(e){for(let t=0;t<e.length-1;t++){const o=e[t];for(let n=t+1;n<e.length;n++){const c=e[n],a=Ie(o,c);if(null!==a)return{u:a,toRemove1:o,toRemove2:c}}}return null}addEventListener("message",e=>{switch(e.data.msg){case"hello":postMessage({msg:`worker response to ${e.data.msg}`,uid:e.data.uid});break;case"load":{const t=self;t.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(o=>{cv=o,o.ready.then(()=>postMessage({msg:"opencvready",uid:e.data.uid}))})}},t.importScripts(t.Module.scriptUrl),t.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),t.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function ze(e){let t=new cv.Rect(e.payload.x,e.payload.y,e.payload.width,e.payload.height),o=new cv.Mat;const n=new ImageData(new Uint8ClampedArray(e.payload.image),e.payload.imageWidth,e.payload.imageHeight);let c=cv.matFromImageData(n);o=ne(c,t);const a=W(o).data.buffer;postMessage({msg:e.msg,payload:a,uid:e.uid},[a]),o.delete(),c.delete()}(e.data);case"nameprediction":return he(e.data,!0);case"ineprediction":return he(e.data,!1);case"namepredictionTemplate":return ve(e.data,!0);case"inepredictionTemplate":return ve(e.data,!1);case"groupImagePerContoursLength":return function Ne(e){0===e.payload.images.length&&postMessage({msg:e.msg,payload:[],uid:e.uid});const t=e.payload.images[e.payload.images.length-1].studentIndex+1,n=e.payload.nbrCluster,a=new cv.TermCriteria(cv.TermCriteria_EPS+cv.TermCriteria_MAX_ITER,1e3,.001),i=[];for(let f=0;f<t;f++){let _=0,d=0;const v=e.payload.images.length/t;for(let w=0;w<v;w++){const b=new ImageData(new Uint8ClampedArray(e.payload.images[f*v+w].image),e.payload.images[f*v+w].width,e.payload.images[f*v+w].height);let x=cv.matFromImageData(b);const O=new cv.Mat;cv.cvtColor(x,O,cv.COLOR_RGBA2GRAY);const P=new cv.Mat;cv.Canny(O,P,100,200,3);const A=new cv.MatVector,D=new cv.Mat;cv.findContours(P,A,D,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);for(let V=0;V<A.size();V++){const U=A.get(V),T=cv.arcLength(U,!0);T>3&&(_+=T,d+=1)}x.delete(),O.delete(),P.delete(),A.delete(),D.delete()}i.push(_),i.push(d)}const r=new cv.Mat,h=new cv.Mat,l=cv.matFromArray(i.length/2,2,cv.CV_32F,i);cv.kmeans(l,n,r,a,5,cv.KMEANS_PP_CENTERS,h);let s=[];for(let f=0;f<n;f++)s.push(h.data32F[2*f+1]);s.sort(function(f,_){return f-_});let m=new Map;for(let f=0;f<n;f++)m.set((h.data32F.indexOf(s[f])-1)/2,f);let u=[];for(let f=0;f<t;f++)u.push(m.get(r.data32S[f]));postMessage({msg:e.msg,payload:u,uid:e.uid}),r.delete(),h.delete(),l.delete()}(e.data);case"qcmresolution":return function pe(e){const t={solutions:[]};let o=cv.matFromImageData(e.payload.imageTemplate),n=new cv.Mat;cv.cvtColor(o,n,cv.COLOR_RGBA2GRAY,0);const c=J(n,e.payload.preference);e.payload.pages?.forEach((a,i)=>{let r=new cv.Mat,h=cv.matFromImageData(a.imageInput),l=new cv.Mat,s=new cv.Size(o.size().width,o.size().height);cv.resize(h,l,s,0,0,cv.INTER_AREA),cv.cvtColor(l,r,cv.COLOR_RGBA2GRAY,0);{const m=J(r,e.payload.preference);let u;if(void 0!==m&&void 0!==m.cases&&m.cases.length>0){const v=function Ae(e,t){const o=[];return e.cases.forEach(n=>{let a,c=500;if(t.cases.forEach(i=>{const r=function Oe(e,t){const o=cv.boundingRect(e),n=cv.boundingRect(t);let c=o.x+o.width/2,a=o.y+o.height/2,i=n.x+n.width/2,r=n.y+n.height/2;return Math.sqrt((c-i)*(c-i)+(a-r)*(a-r))}(n,i);c>r&&r<25&&(c=r,a=i)}),void 0!==a){const i=E(n),r=E(a),h=S(n),l=S(a);o.push({x:i.x-r.x,y:i.y-r.y,deltaw:h.w-l.w,deltah:h.h-l.h})}}),function _e(e){if(e.length>0){const t=Math.min(...e.map(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y))),o=e.filter(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y)===t)[0];return{x:o.x,y:o.y}}return{x:0,y:0}}(o)}(m,c);u=function xe(e,t){let o=new cv.Mat;if(0!==t.x||0!==t.y){let n=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-t.x,0,1,-t.y]),c=new cv.Size(e.cols,e.rows);return cv.warpAffine(e,o,n,c,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),o}return e}(l,v)}else u=l;let f=function be(e,t,o,n){const c=[],a=[];let i=new Map;const r=new Map,h=new cv.Mat;cv.cvtColor(t,h,cv.COLOR_RGBA2GRAY,0);let l=new cv.Mat;cv.threshold(h,l,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);const s=new cv.Mat;cv.cvtColor(o,s,cv.COLOR_RGBA2GRAY,0);let m=new cv.Mat;return cv.threshold(s,m,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU),e.cases.forEach((u,f)=>{const _=le(q(l,k(u),$(u)));r.set(f,_)}),h.delete(),l.delete(),e.cases.forEach((u,f)=>{const _=q(m,k(u),$(u)),v=le(_)-r.get(f);v>n.qcm_differences_avec_case_blanche?(i.set(f,{verdict:!0,prediction:v}),c.push(u)):(i.set(f,{verdict:!1,prediction:v}),a.push(u)),v>n.qcm_differences_avec_case_blanche&&v<1.15*n.qcm_differences_avec_case_blanche?cv.putText(o,""+v.toFixed(2),{x:k(u).x,y:k(u).y+10},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(o,""+v.toFixed(2),{x:k(u).x,y:k(u).y+10},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),_.delete()}),s.delete(),m.delete(),ie(o,c,new cv.Scalar(0,255,0,128),2),ie(o,a,new cv.Scalar(0,0,255,128),2),i}(c,o,u,e.payload.preference),_=function we(e){const t=new cv.Mat,o=e.type()%8,n=o<=cv.CV_8S?1:o<=cv.CV_32S?1/256:255,c=o===cv.CV_8S||o===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,n,c),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),a}(u),d=[];f.forEach((v,w)=>{v.verdict&&d.push(String.fromCharCode(97+w))}),t.solutions?.push({imageSolution:_,numero:i,solution:d.join("&")}),r.delete(),l.delete(),h.delete(),u!==l&&u.delete(),m.cases.forEach(v=>v.delete()),m.img_cases.forEach(v=>v.delete())}}),o.delete(),n.delete(),c.img_cases.forEach(a=>a.delete()),postMessage({msg:e.msg,payload:t,uid:e.uid})}(e.data)}})})();