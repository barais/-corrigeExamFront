(()=>{"use strict";class K{constructor(e){e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(o=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),o()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(o=>{this._model=o,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(o=>{this._model=o,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const i=e.width>e.height,s=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),l=i?[[s,s],[0,0],[0,0]]:[[0,0],[s,s],[0,0]];return tf.tidy(()=>{let d=tf.browser.fromPixels(e,1).pad(l,255);return d=tf.image.resizeBilinear(d,[24,24]).pad([[2,2],[2,2],[0,0]],255),d=tf.scalar(1).sub(d.toFloat().div(tf.scalar(255))),d.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const o=this.preprocessImage(e),n=this._model.predict(o).as1D(),c=n.argMax().dataSync()[0],i=n.max().dataSync()[0];return[this.characters[c],i]}}function O(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function g(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function ee(t,e,o){let n=new cv.Mat;const c=new cv.Rect(e.x,e.y,o.w-2,o.h-2);return n=t.roi(c),n}function ve(t,e){const o=e.qcm_epsilon*cv.arcLength(t,!0),n=new cv.Mat;let c;cv.approxPolyDP(t,n,o,!0);const i=O(n);if(i.w>=e.qcm_min_width_shape&&i.h>=e.qcm_min_height_shape){const s=n.rows;if(1===s)c="LIGNE";else if(3===s)c="TRIANGLE";else if(4===s){const l=i.w/i.h;c=l>=.95&&l<=1.05?"CARRE":"RECTANGLE"}else c=void 0}return{nom:c,forme:n}}function ue(t,e){let o=g(t),n=g(e);return o.y<n.y?-1:o.y>n.y?1:o.x-n.x}function te(t,e){let o=g(t),n=g(e),c=O(t),i=O(e);return(n.x>=o.x&&n.x<=o.x+c.w||n.x+i.w>=o.x&&n.x+i.w<=o.x+c.w)&&(n.y>=o.y&&n.y<=o.y+c.h||n.y+i.h>=o.y&&n.y+i.h<=o.y+c.h)}function oe(t,e){const o=function he(t,e=[],o){const n=new cv.Mat;cv.threshold(t,n,240,255,cv.THRESH_BINARY);let c=new cv.MatVector,i=new cv.Mat;cv.findContours(n,c,i,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const s=[];for(let r=0;r<c.size();++r){const p=ve(c.get(r),o);e.includes(p.nom)&&s.push(p.forme)}s.sort(ue);const l=[],d=[];return s.forEach((r,a)=>{!function me(t,e){let o=e[t],n=!1;return e.forEach((c,i)=>{t<i&&function fe(t,e){return te(t,e)||te(e,t)}(o,c)&&(n=!0)}),n}(a,s)?l.push(r):d.push(r)}),d.forEach(r=>{r.delete()}),l}(t,["CARRE","RECTANGLE"],e),n=[],c=[];return o.forEach(i=>{const s=O(i),l=g(i);n.push(i),c.push(ee(t,l,s))}),{cases:n,img_cases:c}}function ne(t,e,o=new cv.Scalar(255,0,0,128),n=2){return e.forEach(c=>{const i=g(c),s=O(c);s.h=s.h-2,s.w=s.w-2;let l=new cv.Point(i.x,i.y),d=new cv.Point(i.x+s.w,i.y+s.h);cv.rectangle(t,l,d,o,n,0)}),t}let H,G;function ce(t,e){let o=cv.matFromImageData(t.payload.image);const n=function Ee(t){return t?(void 0===H&&(H=new K(t)),H):(void 0===G&&(G=new K(t)),G)}(e);n.isWarmedUp.then(()=>{const c=function Ce(t,e,o,n,c,i){const s=function Me(t,e,o,n){const c=n.linelength,i=n.repairsize,s=n.dilatesize,l=n.morphsize,d=n.drawcontoursizeh,r=n.drawcontoursizev;let a=t.clone(),p=new cv.Mat;cv.cvtColor(t,p,cv.COLOR_BGR2GRAY,0);let E=new cv.Mat;cv.threshold(p,E,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let C=new cv.Point(-1,-1);if(e){let v=new cv.Mat,_=new cv.Size(1,c),w=cv.getStructuringElement(cv.MORPH_RECT,_);cv.morphologyEx(E,v,cv.MORPH_OPEN,w,C,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let R=new cv.MatVector,f=new cv.Mat;cv.findContours(v,R,f,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let y=new cv.Scalar(255,255,255);cv.drawContours(a,R,-1,y,r);let S=new cv.Mat,u=new cv.Size(c,1),m=cv.getStructuringElement(cv.MORPH_RECT,u),$=new cv.Point(-1,-1);cv.morphologyEx(E,S,cv.MORPH_OPEN,m,$,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let B=new cv.MatVector,I=new cv.Mat;cv.findContours(S,B,I,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let V=new cv.Scalar(255,255,255);cv.drawContours(a,B,-1,V,d),v.delete(),R.delete(),f.delete(),w.delete(),S.delete(),B.delete(),I.delete(),m.delete()}let j=new cv.Size(i,i),N=cv.getStructuringElement(cv.MORPH_ELLIPSE,j),T=new cv.Mat,x=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);x.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(x,x,cv.COLOR_BGR2GRAY,0);let Y=new cv.Mat;cv.cvtColor(a,Y,cv.COLOR_BGR2GRAY,0);let X=new cv.Mat;cv.subtract(x,Y,X,T,-1);let q=new cv.Mat;cv.dilate(X,q,N,C,s,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let W=new cv.Mat,Q=new cv.Mat;cv.bitwise_and(q,E,W),cv.morphologyEx(W,Q,cv.MORPH_CLOSE,N,C,l,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let L=new cv.Mat;cv.bitwise_and(Q,E,L);let b=new cv.Mat;cv.subtract(x,L,b,T,-1);let P=new cv.MatVector,ie=new cv.Mat;cv.findContours(L,P,ie,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const k=new Map;let A=[];for(let v=0;v<P.size();v++){let _=P.get(v),w=cv.boundingRect(_);(w.width>12||w.height>12)&&A.push(w)}let z=le(A),Z=0;for(;null!==z&&Z<200;)A=A.filter(v=>v!==z.toRemove1&&v!==z.toRemove2),A.push(z.u),z=le(A),Z+=1;A.forEach(v=>{let _=new cv.Scalar(0,0,0),w=new cv.Point(v.x,v.y),R=new cv.Point(v.x+v.width,v.y+v.height),f=new cv.Mat,y=new cv.Mat,S=new cv.Mat,u=new cv.Scalar(255,0,0,255);f=F(b,v),v.width>v.height?cv.copyMakeBorder(f,f,(v.width-v.height)/2,(v.width-v.height)/2,1,1,cv.BORDER_CONSTANT,u):cv.copyMakeBorder(f,f,1,1,(v.height-v.width)/2,(v.height-v.width)/2,cv.BORDER_CONSTANT,u);let m=new cv.Size(26,26);cv.resize(f,y,m,0,0,cv.INTER_AREA),cv.copyMakeBorder(y,S,1,1,1,1,cv.BORDER_CONSTANT,u),k.set(v,S),f.delete(),y.delete(),cv.rectangle(b,w,R,_,2,cv.LINE_AA,0)}),p.delete(),E.delete(),N.delete(),T.delete(),x.delete(),Y.delete(),X.delete(),q.delete(),a.delete(),W.delete(),Q.delete(),L.delete(),P.delete(),ie.delete();let h=[...k];if(h.sort((v,_)=>v[0].x<_[0].x?-1:1),o&&h.length>3){const v=(h[h.length-1][0].x-h[0][0].x)/h.length;let _=v,w=0,R=0,f=800;const y=[];for(let u=0;u<h.length-1;u++){let m=h[u+1][0].x-h[u][0].x;m<_&&(_=m),m>1.7*v&&y.push(u),h[u][0].y<f&&(f=h[u][0].y),h[u][0].height>w&&(w=h[u][0].height),h[u][0].width>R&&(R=h[u][0].width)}const S=(h[h.length-1][0].x-h[0][0].x)/(h.length+y.length);y.forEach(u=>{let m=h[u][0].x+S,$=new cv.Scalar(0,0,0),B=new cv.Point(m,f),I=new cv.Point(m+R,f+w),V=new cv.Rect(m,f,R,w),D=new cv.Mat,J=new cv.Mat,se=new cv.Mat;D=F(b,V);let Se=new cv.Size(26,26);cv.resize(D,J,Se,0,0,cv.INTER_AREA);let Ae=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(J,se,1,1,1,1,cv.BORDER_CONSTANT,Ae),k.set(V,se),D.delete(),J.delete(),cv.rectangle(b,B,I,$,2,cv.LINE_AA,0)}),h=[...k],h.sort((u,m)=>u[0].x<m[0].x?-1:1)}return{letter:h,invert_final:b}}(t,!1,n,i);let l=[];e.forEach(r=>{l.push([r.padEnd(13," "),0])});const d=[];for(let r=0;r<s.letter.length;r++){let a=o.predict(U(s.letter[r][1]));c&&("1"===a[0]&&(a[0]="i"),"0"===a[0]&&(a[0]="o"),"5"===a[0]&&(a[0]="s"),"3"===a[0]&&(a[0]="b"),"9"===a[0]&&(a[0]="g")),d.push(a)}for(let r=0;r<l.length;r++){for(let a=0;a<13;a++)a<d.length&&(l[r][1]=l[r][0].substring(a,a+1).toLowerCase()===d[a][0].toLowerCase()?l[r][1]+d[a][1]:c?l[r][1]+(1-d[a][1])/35:l[r][1]+(1-d[a][1])/9);l[r][1]=l[r][1]/d.length}for(let r=0;r<l.length;r++)l[r][0]=l[r][0].trim(),l[r][1]=l[r][1]-Math.abs(l[r][0].length-d.length)/l[r][0].length;return l.sort((r,a)=>r[1]<a[1]?1:-1),{debug:s.invert_final,solution:l[0]}}(o,t.payload.match,n,!0,e,t.payload.preference);postMessage({msg:t.msg,payload:{debug:U(c.debug),solution:c.solution},uid:t.uid}),c.debug.delete(),o.delete()})}function U(t){const e=new cv.Mat,o=t.type()%8,n=o<=cv.CV_8S?1:o<=cv.CV_32S?1/256:255,c=o===cv.CV_8S||o===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,c),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}function F(t,e,o){const n=t.size().width,c=t.size().height;return e.x+e.width>n&&(e.width=n-e.x),e.y+e.height>c&&(e.height=c-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function xe(t,e){let o=e,n=t,c=t,i=e;t.x>e.x&&(o=t,n=e),t.y>e.y&&(c=e,i=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let s=e,l=t,d=e,r=t;return t.right>e.right&&(s=t,l=e),t.bottom>e.bottom&&(d=t,r=e),o.x<n.right&&i.y>c.y+c.height?new cv.Rect(n.x,r.y,s.right-n.x,d.bottom-c.y):o.x>n.x+n.width+5||i.y>c.y+c.height?null:new cv.Rect(n.x,r.y,s.right-n.x,d.bottom-c.y)}function le(t){for(let e=0;e<t.length-1;e++){const o=t[e];for(let n=e+1;n<t.length;n++){const c=t[n],i=xe(o,c);if(null!==i)return{u:i,toRemove1:o,toRemove2:c}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(o=>{cv=o,o.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function ye(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),o=new cv.Mat,n=cv.matFromImageData(t.payload.image);o=F(n,e),postMessage({msg:t.msg,payload:U(o),uid:t.uid}),o.delete(),n.delete()}(t.data);case"nameprediction":return ce(t.data,!0);case"ineprediction":return ce(t.data,!1);case"qcmresolution":return function ae(t){var e;const o={solutions:[]};let n=cv.matFromImageData(t.payload.imageTemplate),c=new cv.Mat;cv.cvtColor(n,c,cv.COLOR_RGBA2GRAY,0);const i=oe(c,t.payload.preference);null===(e=t.payload.pages)||void 0===e||e.forEach((s,l)=>{var d;let r=new cv.Mat,a=cv.matFromImageData(s.imageInput);cv.cvtColor(a,r,cv.COLOR_RGBA2GRAY,0);const p=oe(r,t.payload.preference),E=function we(t,e){const o=[];return t.cases.forEach(n=>{let i,c=500;if(e.cases.forEach(s=>{const l=function _e(t,e){const o=cv.boundingRect(t),n=cv.boundingRect(e);let c=o.x+o.width/2,i=o.y+o.height/2,s=n.x+n.width/2,l=n.y+n.height/2;return Math.sqrt((c-s)*(c-s)+(i-l)*(i-l))}(n,s);c>l&&l<25&&(c=l,i=s)}),void 0!==i){let s=g(n),l=g(i);o.push({x:s.x-l.x,y:s.y-l.y})}}),function de(t){if(t.length>0){let e=0,o=0;return t.forEach(n=>{e+=n.x,o+=n.y}),{x:e/t.length,y:o/t.length}}return{x:0,y:0}}(o)}(p,i),C=function pe(t,e){let o=new cv.Mat;if(0!==e.x||0!==e.y){let n=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),c=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,o,n,c,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),o}return t}(a,E);let j=function ge(t,e,o,n){const c=[],i=[];let s=new Map;return t.cases.forEach((l,d)=>{const r=ee(o,g(l),O(l)),a=function Re(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let o=new cv.Mat;return cv.threshold(e,o,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(o)/(t.rows*t.cols)}(r);a>n.qcm_differences_avec_case_blanche?(s.set(d,{verdict:!0,prediction:a}),c.push(l)):(s.set(d,{verdict:!1,prediction:a}),i.push(l)),a>.16&&a<.25?cv.putText(o,""+a.toFixed(2),{x:g(l).x,y:g(l).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(o,""+a.toFixed(2),{x:g(l).x,y:g(l).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),r.delete()}),ne(o,c,new cv.Scalar(0,255,0,128)),ne(o,i,new cv.Scalar(0,0,255,128)),s}(i,0,C,t.payload.preference),N=function re(t){const e=new cv.Mat,o=t.type()%8,n=o<=cv.CV_8S?1:o<=cv.CV_32S?1/256:255,c=o===cv.CV_8S||o===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,c),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}(C),T=[];j.forEach((M,x)=>{M.verdict&&T.push(String.fromCharCode(97+x))}),null===(d=o.solutions)||void 0===d||d.push({imageSolution:N,numero:l,solution:T.join("&")}),r.delete(),a.delete(),C!==a&&C.delete(),p.cases.forEach(M=>M.delete()),p.img_cases.forEach(M=>M.delete())}),n.delete(),c.delete(),i.cases.forEach(s=>s.delete()),i.img_cases.forEach(s=>s.delete()),postMessage({msg:t.msg,payload:o,uid:t.uid})}(t.data)}})})();