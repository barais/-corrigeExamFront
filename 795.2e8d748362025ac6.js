(()=>{"use strict";function I(t){return(I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function G(t,e,n){return(e=function me(t){var e=function fe(t,e){if("object"!==I(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e||"default");if("object"!==I(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===I(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class oe{constructor(e){G(this,"alphabet",void 0),G(this,"characters",void 0),G(this,"isWarmedUp",void 0),G(this,"_model",void 0),e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(n=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),n()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const r=e.width>e.height,s=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),c=r?[[s,s],[0,0],[0,0]]:[[0,0],[s,s],[0,0]];return tf.tidy(()=>{let d=tf.browser.fromPixels(e,1).pad(c,255);return d=tf.image.resizeBilinear(d,[24,24]).pad([[2,2],[2,2],[0,0]],255),d=tf.scalar(1).sub(d.toFloat().div(tf.scalar(255))),d.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const n=this.preprocessImage(e),o=this._model.predict(n).as1D(),i=o.argMax().dataSync()[0],r=o.max().dataSync()[0];return[this.characters[i],r]}}function N(t){const e=cv.boundingRect(t);return{w:e.width+8,h:e.height+8}}function ie(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function y(t){const e=cv.boundingRect(t);return{x:e.x-4,y:e.y-4}}function _e(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function ye(t,e){const n=e.qcm_epsilon*cv.arcLength(t,!0),o=new cv.Mat;let i;cv.approxPolyDP(t,o,n,!0);const r=ie(o);if(r.w>=e.qcm_min_width_shape&&r.h>=e.qcm_min_height_shape){const s=o.rows;if(1===s)i="LIGNE";else if(3===s)i="TRIANGLE";else if(4===s){const c=r.w/r.h;i=c>=.95&&c<=1.05?"CARRE":"RECTANGLE"}else i=void 0}return{nom:i,forme:o}}function Me(t,e){let n=y(t),o=y(e);return n.y<o.y?-1:n.y>o.y?1:n.x-o.x}function Ee(t,e){let n=y(t),o=y(e);return n.x-o.x}function ce(t,e){let n=y(t),o=y(e),i=N(t),r=N(e);return(o.x>=n.x&&o.x<=n.x+i.w||o.x+r.w>=n.x&&o.x+r.w<=n.x+i.w)&&(o.y>=n.y&&o.y<=n.y+i.h||o.y+r.h>=n.y&&o.y+r.h<=n.y+i.h)}function K(t,e){const n=function Re(t,e=[],n){const o=new cv.Mat;cv.threshold(t,o,245,255,cv.THRESH_BINARY);let i=new cv.MatVector,r=new cv.Mat;cv.findContours(o,i,r,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const s=[];for(let l=0;l<i.size();++l){const p=ye(i.get(l),n);e.includes(p.nom)&&s.push(p.forme)}s.sort(Me);const c=[],d=[];return s.forEach((l,h)=>{!function Se(t,e){let n=e[t],o=!1;return e.forEach((i,r)=>{t<r&&function Ce(t,e){return ce(t,e)||ce(e,t)}(n,i)&&(o=!0)}),o}(h,s)?c.push(l):d.push(l)}),d.forEach(l=>{l.delete()}),c}(t,["CARRE","RECTANGLE"],e),o=[],i=[];return n.forEach(r=>{const s=N(r),c=y(r);o.push(r),i.push(U(t,c,s))}),{cases:o,img_cases:i}}function U(t,e,n){let o=new cv.Mat,i=e.x,r=e.y,s=n.w,c=n.h;i<0&&(i=0),r<0&&(r=0),i+s>t.size().width&&(s=t.size().width-i),c+r>t.size().height&&(c=t.size().height-r);const d=new cv.Rect(i,r,s,c);return s<=0||c<=0?t:(o=t.roi(d),o)}function re(t,e,n=new cv.Scalar(255,0,0,128),o=2){return e.forEach(i=>{const r=y(i),s=N(i);let c=new cv.Point(r.x,r.y),d=new cv.Point(r.x+s.w,r.y+s.h);cv.rectangle(t,c,d,n,o,0)}),t}function le(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let n=new cv.Mat;return cv.threshold(e,n,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(n)/(t.rows*t.cols)}function Te(t){let e=new cv.Mat;cv.adaptiveThreshold(t,e,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY_INV,3,2);let i,n=new cv.MatVector,o=new cv.Mat;cv.findContours(e,n,o,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE);for(let r=0;r<n.size();++r){let s=n.get(r),c=cv.boundingRect(s);c.width>1&&c.height>1&&(void 0!==i&&(i.width>c.width||i.height>c.height)||(i=c))}if(void 0!==i){let r=new cv.Mat;r=e.roi(i);let s=cv.countNonZero(r)/(i.width*i.height);return r.delete(),e.delete(),s}return e.delete(),0}let Q,$;function se(t){return t?(void 0===Q&&(Q=new oe(t)),Q):(void 0===$&&($=new oe(t)),$)}function ae(t,e){let n=cv.matFromImageData(t.payload.image);const o=se(e);o.isWarmedUp.then(()=>{const i=function Pe(t,e,n,o,i,r){const s=function Be(t,e,n,o){const i=o.linelength,r=o.repairsize,s=o.dilatesize,c=o.morphsize,d=o.drawcontoursizeh,l=o.drawcontoursizev;let h=t.clone(),p=new cv.Mat;cv.cvtColor(t,p,cv.COLOR_BGR2GRAY,0);let g=new cv.Mat;cv.threshold(p,g,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let E=new cv.Point(-1,-1);if(e){let v=new cv.Mat,x=new cv.Size(1,i),M=cv.getStructuringElement(cv.MORPH_RECT,x);cv.morphologyEx(g,v,cv.MORPH_OPEN,M,E,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let A=new cv.MatVector,_=new cv.Mat;cv.findContours(v,A,_,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let b=new cv.Scalar(255,255,255);cv.drawContours(h,A,-1,b,l);let O=new cv.Mat,w=new cv.Size(i,1),R=cv.getStructuringElement(cv.MORPH_RECT,w),te=new cv.Point(-1,-1);cv.morphologyEx(g,O,cv.MORPH_OPEN,R,te,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let H=new cv.MatVector,q=new cv.Mat;cv.findContours(O,H,q,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let W=new cv.Scalar(255,255,255);cv.drawContours(h,H,-1,W,d),v.delete(),A.delete(),_.delete(),M.delete(),O.delete(),H.delete(),q.delete(),R.delete()}let C=new cv.Size(r,r),a=cv.getStructuringElement(cv.MORPH_ELLIPSE,C),u=new cv.Mat,S=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);S.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(S,S,cv.COLOR_BGR2GRAY,0);let T=new cv.Mat;cv.cvtColor(h,T,cv.COLOR_BGR2GRAY,0);let P=new cv.Mat;cv.subtract(S,T,P,u,-1);let k=new cv.Mat;cv.dilate(P,k,a,E,s,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let B=new cv.Mat,D=new cv.Mat;cv.bitwise_and(k,g,B),cv.morphologyEx(B,D,cv.MORPH_CLOSE,a,E,c,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let Y=new cv.Mat;cv.bitwise_and(D,g,Y);let L=new cv.Mat;cv.subtract(S,Y,L,u,-1);let X=new cv.MatVector,ve=new cv.Mat;cv.findContours(Y,X,ve,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const j=new Map;let z=[];for(let v=0;v<X.size();v++){let x=X.get(v),M=cv.boundingRect(x);(M.width>12||M.height>12)&&z.push(M)}let V=he(z),ee=0;for(;null!==V&&ee<200;)z=z.filter(v=>v!==V.toRemove1&&v!==V.toRemove2),z.push(V.u),V=he(z),ee+=1;z.forEach(v=>{let x=new cv.Scalar(0,0,0),M=new cv.Point(v.x,v.y),A=new cv.Point(v.x+v.width,v.y+v.height),_=new cv.Mat,b=new cv.Mat,O=new cv.Mat,w=new cv.Scalar(255,0,0,255);_=J(L,v),v.width>v.height?cv.copyMakeBorder(_,_,(v.width-v.height)/2,(v.width-v.height)/2,1,1,cv.BORDER_CONSTANT,w):cv.copyMakeBorder(_,_,1,1,(v.height-v.width)/2,(v.height-v.width)/2,cv.BORDER_CONSTANT,w);let R=new cv.Size(26,26);cv.resize(_,b,R,0,0,cv.INTER_AREA),cv.copyMakeBorder(b,O,1,1,1,1,cv.BORDER_CONSTANT,w),j.set(v,O),_.delete(),b.delete(),cv.rectangle(L,M,A,x,2,cv.LINE_AA,0)}),p.delete(),g.delete(),a.delete(),u.delete(),S.delete(),T.delete(),P.delete(),k.delete(),h.delete(),B.delete(),D.delete(),Y.delete(),X.delete(),ve.delete();let m=[...j];if(m.sort((v,x)=>v[0].x<x[0].x?-1:1),n&&m.length>3){const v=(m[m.length-1][0].x-m[0][0].x)/m.length;let x=v,M=0,A=0,_=800;const b=[];for(let w=0;w<m.length-1;w++){let R=m[w+1][0].x-m[w][0].x;R<x&&(x=R),R>1.7*v&&b.push(w),m[w][0].y<_&&(_=m[w][0].y),m[w][0].height>M&&(M=m[w][0].height),m[w][0].width>A&&(A=m[w][0].width)}const O=(m[m.length-1][0].x-m[0][0].x)/(m.length+b.length);b.forEach(w=>{let R=m[w][0].x+O,te=new cv.Scalar(0,0,0),H=new cv.Point(R,_),q=new cv.Point(R+A,_+M),W=new cv.Rect(R,_,A,M),Z=new cv.Mat,ne=new cv.Mat,ue=new cv.Mat;Z=J(L,W);let Ie=new cv.Size(26,26);cv.resize(Z,ne,Ie,0,0,cv.INTER_AREA);let ke=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(ne,ue,1,1,1,1,cv.BORDER_CONSTANT,ke),j.set(W,ue),Z.delete(),ne.delete(),cv.rectangle(L,H,q,te,2,cv.LINE_AA,0)}),m=[...j],m.sort((w,R)=>w[0].x<R[0].x?-1:1)}return{letter:m,invert_final:L}}(t,!1,o,r);let c=[];e.forEach(l=>{c.push([l.padEnd(22," "),0])});const d=[];for(let l=0;l<s.letter.length;l++){let h=n.predict(F(s.letter[l][1]));i&&("1"===h[0]&&(h[0]="i"),"0"===h[0]&&(h[0]="o"),"5"===h[0]&&(h[0]="s"),"3"===h[0]&&(h[0]="b"),"9"===h[0]&&(h[0]="g")),d.push(h)}for(let l=0;l<c.length;l++){for(let h=0;h<13;h++)h<d.length&&(c[l][1]=c[l][0].substring(h,h+1).toLowerCase()===d[h][0].toLowerCase()?c[l][1]+d[h][1]:i?c[l][1]+(1-d[h][1])/35:c[l][1]+(1-d[h][1])/9);c[l][1]=c[l][1]/d.length}for(let l=0;l<c.length;l++)c[l][0]=c[l][0].trim(),c[l][1]=c[l][1]-Math.abs(c[l][0].length-d.length)/c[l][0].length;return c.sort((l,h)=>l[1]<h[1]?1:-1),{debug:s.invert_final,solution:c[0]}}(n,t.payload.match,o,!0,e,t.payload.preference);postMessage({msg:t.msg,payload:{debug:F(i.debug),solution:i.solution},uid:t.uid}),i.debug.delete(),n.delete()})}function de(t,e){let n=cv.matFromImageData(t.payload.image),o=cv.matFromImageData(t.payload.template);const i=se(e);i.isWarmedUp.then(()=>{const r=function Ne(t,e,n,o,i,r,s){let c=[];n.forEach(a=>{c.push([a.padEnd(22," "),0])});let d=new cv.Mat;cv.cvtColor(t,d,cv.COLOR_RGBA2GRAY,0);let l=new cv.Mat;cv.cvtColor(e,l,cv.COLOR_RGBA2GRAY,0);const h=K(d,s);console.error(h);const p=new Map;for(let a=0;a<h.cases.length;a++){const u=h.cases.sort(Ee)[a],f=ie(u),S=_e(u);let T=new cv.Mat,P=new cv.Mat,k=new cv.Size(26,26);const B=U(l,S,f);cv.resize(B,T,k,0,0,cv.INTER_AREA);let D=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(T,P,1,1,1,1,cv.BORDER_CONSTANT,D),p.set(S,P),T.delete(),B.delete()}const g=[];for(let a=0;a<[...p].length;a++)if(Te([...p][a][1])>.15){let f=o.predict(F([...p][a][1]));r&&("1"===f[0]&&(f[0]="i"),"0"===f[0]&&(f[0]="o"),"5"===f[0]&&(f[0]="s"),"3"===f[0]&&(f[0]="b"),"9"===f[0]&&(f[0]="g")),g.push(f)}else g.push(["",1]);let E=0;g.forEach((a,u)=>{""!==a[0]&&(E=u)});let C=g.slice(0,E+1);for(let a=0;a<c.length;a++){for(let u=0;u<13;u++)u<C.length&&(c[a][1]=c[a][0].substring(u,u+1).toLowerCase()===C[u][0].toLowerCase()?c[a][1]+C[u][1]:r?c[a][1]+(1-C[u][1])/35:c[a][1]+(1-C[u][1])/9);c[a][1]=c[a][1]/C.length}for(let a=0;a<c.length;a++)c[a][0]=c[a][0].trim(),c[a][1]=c[a][1]-Math.abs(c[a][0].length-C.length)/c[a][0].length;c.sort((a,u)=>a[1]<u[1]?1:-1),d.delete(),l.delete();for(let a=0;a<[...p].length;a++)[...p][a][1].delete();for(let a=0;a<h.cases.length;a++)h.cases[a].delete();for(let a=0;a<h.img_cases.length;a++)h.img_cases[a].delete();return{solution:c[0]}}(o,n,t.payload.match,i,0,e,t.payload.preference);postMessage({msg:t.msg,payload:{solution:r.solution},uid:t.uid}),r.debug.delete(),n.delete(),o.delete()})}function F(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,i=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,i),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const r=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),r}function J(t,e,n){const o=t.size().width,i=t.size().height;return e.x+e.width>o&&(e.width=o-e.x),e.y+e.height>i&&(e.height=i-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function Le(t,e){let n=e,o=t,i=t,r=e;t.x>e.x&&(n=t,o=e),t.y>e.y&&(i=e,r=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let s=e,c=t,d=e,l=t;return t.right>e.right&&(s=t,c=e),t.bottom>e.bottom&&(d=t,l=e),n.x<o.right&&r.y>i.y+i.height?new cv.Rect(o.x,l.y,s.right-o.x,d.bottom-i.y):n.x>o.x+o.width+5||r.y>i.y+i.height?null:new cv.Rect(o.x,l.y,s.right-o.x,d.bottom-i.y)}function he(t){for(let e=0;e<t.length-1;e++){const n=t[e];for(let o=e+1;o<t.length;o++){const i=t[o],r=Le(n,i);if(null!==r)return{u:r,toRemove1:n,toRemove2:i}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(n=>{cv=n,n.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function ze(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),n=new cv.Mat,o=cv.matFromImageData(t.payload.image);n=J(o,e),postMessage({msg:t.msg,payload:F(n),uid:t.uid}),n.delete(),o.delete()}(t.data);case"nameprediction":return ae(t.data,!0);case"ineprediction":return ae(t.data,!1);case"namepredictionTemplate":return de(t.data,!0);case"inepredictionTemplate":return de(t.data,!1);case"qcmresolution":return function we(t){const e={solutions:[]};let n=cv.matFromImageData(t.payload.imageTemplate),o=new cv.Mat;cv.cvtColor(n,o,cv.COLOR_RGBA2GRAY,0);const i=K(o,t.payload.preference);t.payload.pages?.forEach((r,s)=>{let c=new cv.Mat,d=cv.matFromImageData(r.imageInput),l=new cv.Mat,h=new cv.Size(n.size().width,n.size().height);cv.resize(d,l,h,0,0,cv.INTER_AREA),cv.cvtColor(l,c,cv.COLOR_RGBA2GRAY,0);{const p=K(c,t.payload.preference),g=function Ae(t,e){const n=[];return t.cases.forEach(o=>{let r,i=500;if(e.cases.forEach(s=>{const c=function Oe(t,e){const n=cv.boundingRect(t),o=cv.boundingRect(e);let i=n.x+n.width/2,r=n.y+n.height/2,s=o.x+o.width/2,c=o.y+o.height/2;return Math.sqrt((i-s)*(i-s)+(r-c)*(r-c))}(o,s);i>c&&c<25&&(i=c,r=s)}),void 0!==r){let s=y(o),c=y(r);n.push({x:s.x-c.x,y:s.y-c.y})}}),function pe(t){if(t.length>0){let e=0,n=0;return t.forEach(o=>{e+=o.x,n+=o.y}),{x:e/t.length,y:n/t.length}}return{x:0,y:0}}(n)}(p,i),E=function be(t,e){let n=new cv.Mat;if(0!==e.x||0!==e.y){let o=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),i=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,n,o,i,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),n}return t}(l,g);let C=function xe(t,e,n,o){const i=[],r=[];let s=new Map;const c=new Map;return t.cases.forEach((d,l)=>{const h=le(U(e,y(d),N(d)));c.set(l,h)}),t.cases.forEach((d,l)=>{const h=U(n,y(d),N(d)),g=le(h)-c.get(l);g>o.qcm_differences_avec_case_blanche?(s.set(l,{verdict:!0,prediction:g}),i.push(d)):(s.set(l,{verdict:!1,prediction:g}),r.push(d)),g>o.qcm_differences_avec_case_blanche&&g<1.15*o.qcm_differences_avec_case_blanche?cv.putText(n,""+g.toFixed(2),{x:y(d).x,y:y(d).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(n,""+g.toFixed(2),{x:y(d).x,y:y(d).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),h.delete()}),re(n,i,new cv.Scalar(0,255,0,128),2),re(n,r,new cv.Scalar(0,0,255,128),2),s}(i,n,E,t.payload.preference),a=function ge(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,i=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,i),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const r=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),r}(E),u=[];C.forEach((f,S)=>{f.verdict&&u.push(String.fromCharCode(97+S))}),e.solutions?.push({imageSolution:a,numero:s,solution:u.join("&")}),c.delete(),l.delete(),d.delete(),E!==l&&E.delete(),p.cases.forEach(f=>f.delete()),p.img_cases.forEach(f=>f.delete())}}),n.delete(),o.delete(),i.img_cases.forEach(r=>r.delete()),postMessage({msg:t.msg,payload:e,uid:t.uid})}(t.data)}})})();