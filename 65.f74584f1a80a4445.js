(()=>{"use strict";var m,Ae={1065:(m,P,y)=>{var D=y(5861),M=y(4942);class A{constructor(e){(0,M.Z)(this,"alphabet",void 0),(0,M.Z)(this,"characters",void 0),(0,M.Z)(this,"isWarmedUp",void 0),(0,M.Z)(this,"_model",void 0),e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(s=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),s()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(s=>{this._model=s,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(s=>{this._model=s,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const a=e.width>e.height,i=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),r=a?[[i,i],[0,0],[0,0]]:[[0,0],[i,i],[0,0]];return tf.tidy(()=>{let c=tf.browser.fromPixels(e,1).pad(r,255);return c=tf.image.resizeBilinear(c,[24,24]).pad([[2,2],[2,2],[0,0]],255),c=tf.scalar(1).sub(c.toFloat().div(tf.scalar(255))),c.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const s=this.preprocessImage(e),n=this._model.predict(s).as1D(),o=n.argMax().dataSync()[0],a=n.max().dataSync()[0];return[this.characters[o],a]}}function ne(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function Y(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function K(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function H(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function ue(t,e){const s=e.qcm_epsilon*cv.arcLength(t,!0),n=new cv.Mat;let o;cv.approxPolyDP(t,n,s,!0);const a=Y(n);if(a.w>=e.qcm_min_width_shape&&a.h>=e.qcm_min_height_shape){const i=n.rows;if(1===i)o="LIGNE";else if(3===i)o="TRIANGLE";else if(4===i){const r=a.w/a.h;o=r>=.95&&r<=1.05?"CARRE":"RECTANGLE"}else o=void 0}return{nom:o,forme:n}}function Ye(t,e){let s=H(t),n=H(e);return s.y<n.y?-1:s.y>n.y?1:s.x-n.x}function We(t,e){let s=H(t),n=H(e);return s.x-n.x}function Oe(t,e){let s=H(t),n=H(e),o=Y(t),a=Y(e);return(n.x>=s.x&&n.x<=s.x+o.w||n.x+a.w>=s.x&&n.x+a.w<=s.x+o.w)&&(n.y>=s.y&&n.y<=s.y+o.h||n.y+a.h>=s.y&&n.y+a.h<=s.y+o.h)}function fe(t,e){const s=function Ue(t,e=[],s){const n=new cv.Mat;cv.threshold(t,n,248,255,cv.THRESH_BINARY);let o=new cv.MatVector,a=new cv.Mat;cv.findContours(n,o,a,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const i=[];for(let f=0;f<o.size();++f){const l=ue(o.get(f),s);e.includes(l.nom)&&i.push(l.forme)}i.sort(Ye);const r=[],c=[],u=[];return i.forEach(f=>{0===H(f).x&&0===H(f).y||(100*Y(f).w/Y(t).w+100*Y(f).h/Y(t).h)/2>80?c.push(f):u.push(f)}),u.forEach((f,p)=>{!function qe(t,e){let s=e[t],n=!1;return e.forEach((o,a)=>{t<a&&function Xe(t,e){return Oe(t,e)||Oe(e,t)}(s,o)&&(n=!0)}),n}(p,u)?r.push(f):c.push(f)}),c.forEach(f=>{f.delete()}),r}(t,["CARRE","RECTANGLE"],e),n=[],o=[];return s.forEach(a=>{const i=ne(a),r=K(a);n.push(a),o.push(ge(t,r,i))}),{cases:n,img_cases:o}}function ge(t,e,s){let n=new cv.Mat,o=e.x,a=e.y,i=s.w,r=s.h;o<0&&(o=0),a<0&&(a=0),o+i>t.size().width&&(i=t.size().width-o),r+a>t.size().height&&(r=t.size().height-a);const c=new cv.Rect(o,a,i,r);return i<=0||r<=0?t:(n=t.roi(c),n)}function Ie(t,e,s=new cv.Scalar(255,0,0,128),n=2){return e.forEach(o=>{const a=H(o),i=Y(o);let r=new cv.Point(a.x,a.y),c=new cv.Point(a.x+i.w,a.y+i.h);cv.rectangle(t,r,c,s,n,0)}),t}function Le(t){return 1-cv.countNonZero(t)/(t.rows*t.cols)}var Ne=y(2384),ke=y(8645),me=y(4036),et=y(4004);let le,oe,Q,xe,Ce;class tt{constructor(e){(0,M.Z)(this,"sqliteWorkerport",void 0),(0,M.Z)(this,"ready",void 0),(0,M.Z)(this,"subjects",new Map),(0,M.Z)(this,"onmessage",n=>{const o=n.data;switch(o.msg){case"getFirstNonAlignImage":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}case"getFirstAlignImage":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}case"getFirstTemplate":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}default:this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete()}}),(0,M.Z)(this,"onerror",n=>{this.subjects.has(n.uid)&&(console.log("get error uid"),this.subjects.get(n.uid)?.error(n)),console.log(`error on service work: ${JSON.stringify(n)}`)}),this.sqliteWorkerport=e;const s=new ke.x;this.subjects.set("0",s),this.ready=new Promise((n,o)=>{this.subjects.get("0")?.asObservable().subscribe(()=>{n()},()=>o())})}_dispatch(e,s,n){const o=(0,et.Z)();this.ready.then(()=>{n?this.sqliteWorkerport.postMessage({msg:e,uid:o,payload:s},n):this.sqliteWorkerport.postMessage({msg:e,uid:o,payload:s})});const a=new ke.x;return this.subjects.set(o,a),this.ready=new Promise((i,r)=>{this.subjects.get(o)?.asObservable().subscribe(()=>{i()},()=>r())}),a.asObservable()}getFirstNonAlignImage(e,s){return(0,me.z)(this._dispatch("getFirstNonAlignImage",{examId:e,pageInscan:s}))}getFirstAlignImage(e,s){return(0,me.z)(this._dispatch("getFirstAlignImage",{examId:e,pageInscan:s}))}getFirstTemplate(e,s){return(0,me.z)(this._dispatch("getFirstTemplate",{examId:e,pageInscan:s}))}}function Ze(t,e,s){return pe.apply(this,arguments)}function pe(){return(pe=(0,D.Z)(function*(t,e,s){return s?(void 0===Q&&(Q=new Ne.z),yield Q.getFirstTemplate(e,t)):yield oe.getFirstTemplate(e,t)})).apply(this,arguments)}function Be(t,e,s,n){return ve.apply(this,arguments)}function ve(){return(ve=(0,D.Z)(function*(t,e,s,n){return n?(void 0===Q&&(Q=new Ne.z),t?yield Q.getFirstAlignImage(s,e):yield Q.getFirstNonAlignImage(s,e)):t?yield oe.getFirstAlignImage(s,e):yield oe.getFirstNonAlignImage(s,e)})).apply(this,arguments)}function nt(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.value):e}function we(t){return ye.apply(this,arguments)}function ye(){return(ye=(0,D.Z)(function*(t){const e=JSON.parse(t.value,nt),n=yield(yield fetch(e.pages)).blob(),o=yield createImageBitmap(n),i=new OffscreenCanvas(o.width,o.height).getContext("2d");return i.drawImage(o,0,0),i.getImageData(0,0,o.width,o.height)})).apply(this,arguments)}function ee(t,e,s){let n=e.width*t.width*s/1e5,o=e.height*t.height*s/1e5,a=e.xInit*t.width/1e5-(e.width*t.width*s/1e5-e.width*t.width/1e5)/2;a<0&&(n+=a,a=0);let i=e.yInit*t.height/1e5-(e.height*t.height*s/1e5-e.height*t.height/1e5)/2;i<0&&(o+=i,i=0);let r=new cv.Rect(a,i,n,o),c=new cv.Mat,u=cv.matFromImageData(t);return c=Pe(u,r),u.delete(),c}function _e(){return(_e=(0,D.Z)(function*(t){const e=t.payload;let s;if(s=e.template?yield Ze(e.page,e.examId,e.indexDb):yield Be(e.align,e.page,e.examId,e.indexDb),void 0!==s){const o=ee(yield we(s),e.z,e.factor),i={image:q(o).data.buffer,page:e.page,width:o.size().width,height:o.size().height};le.currentTarget.postMessage({msg:t.msg,payload:i,uid:t.uid},[i.image]),o.delete()}})).apply(this,arguments)}function be(){return(be=(0,D.Z)(function*(t){const e=t.payload;if(function at(t){return"pagesToAnalyze"in t}(e)){const s=[],n=[],o=new Map;for(let a of e.pagesToAnalyze){console.time("analysePage"),console.timeLog("analysePage","before getScan");const i=yield Be(e.align,a,e.examId,e.indexDb);if(console.timeLog("analysePage","after getScan"),void 0!==i){console.timeLog("analysePage","before loadImage");const r=yield we(i);console.timeLog("analysePage","after loadImage");let c,u,f,p=0;console.timeLog("analysePage","before cropZone"),e.nameZone&&(c=ee(r,e.nameZone,e.factor),p=e.nameZone.pageNumber),e.firstnameZone&&(u=ee(r,e.firstnameZone,e.factor),p=e.firstnameZone.pageNumber),e.ineZone&&(f=ee(r,e.ineZone,e.factor),p=e.ineZone.pageNumber),console.timeLog("analysePage","after cropZone");const l={page:a-p,resultPrediction:[]};let g,_,E;if(c&&(g=q(c).data.buffer,l.nameZoneW=c.size().width,l.nameZoneH=c.size().height,g&&s.push(g)),u&&(_=q(u).data.buffer,l.firstnameZoneW=u.size().width,l.firstnameZoneH=u.size().height,_&&s.push(_)),f&&(E=q(f).data.buffer,l.ineZoneW=f.size().width,l.ineZoneH=f.size().height,E&&s.push(E)),l.nameZone=g,l.firstnameZone=_,l.ineZone=E,e.assist){console.timeLog("analysePage","before template load");const h=yield Ze(e.pageTemplate,e.examId,e.indexDb);if(console.timeLog("analysePage","after template load"),void 0!==h){console.timeLog("analysePage","before template image load");const b=yield we(h);let F,j,L,T,N,V;if(console.timeLog("analysePage","after template image load"),console.timeLog("analysePage","before cropZone template"),e.nameZone&&(F=ee(b,e.nameZone,e.factor)),e.firstnameZone&&(j=ee(b,e.firstnameZone,e.factor)),e.ineZone&&(L=ee(b,e.ineZone,e.factor)),console.timeLog("analysePage","after cropZone template"),console.timeLog("analysePage","before doPredidction4zone name"),void 0!==c&&void 0!==F&&(T=yield Re(!0,c,F,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),F.delete(),T.debug)){const x=q(T.debug).data.buffer;x&&(s.push(x),l.nameZoneDebug=x),T.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone name"),console.timeLog("analysePage","before doPredidction4zone firstname"),void 0!==u&&void 0!==j&&(N=yield Re(!0,u,j,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),j.delete(),N.debug)){const x=q(N.debug).data.buffer;x&&(s.push(x),l.firstnameZoneDebug=x),N.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone firstname"),console.timeLog("analysePage","before doPredidction4zone ine"),void 0!==f&&void 0!==L&&(V=yield Re(!1,f,L,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),L.delete(),V.debug)){const x=q(V.debug).data.buffer;x&&(s.push(x),l.ineZoneDebug=x),V.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone ine"),console.timeLog("analysePage","before computescore"),T?.solution?.length>0&&N?.solution?.length>0){const x=T.solution.length,B=N.solution.length,k=e.candidates.filter(R=>Math.abs(x-R.name.length)<=2&&Math.abs(B-R.firstname.length)<=2);o.set(l.page,new Map),k.forEach(R=>{const Z={...R},de=Math.abs(x-R.name.length)+Math.abs(B-R.firstname.length);Z.score=1e3/Math.pow(2,de),Z.proba=De(Z,T,N,V),o.get(l.page)?.set(Z.id,Z)});const S=Array.from(o.get(l.page).values()).sort((R,Z)=>Z.proba*Z.score-R.proba*R.score);let O=[];O=S.length>2?[S[0],S[1],S[2]]:S,l.resultPrediction=O}else if(T?.solution?.length>0){const x=T.solution.length,B=e.candidates.filter(O=>Math.abs(x-O.name.length)<=2);o.set(l.page,new Map),B.forEach(O=>{const R={...O},Z=Math.abs(x-O.name.length);R.score=1e3/Math.pow(2,Z),R.proba=De(R,T,N,V),o.get(l.page)?.set(R.id,R)});const k=Array.from(o.get(l.page).values()).sort((O,R)=>R.proba*R.score-O.proba*O.score);let S=[];S=k.length>2?[k[0],k[1],k[2]]:k,l.resultPrediction=S}console.timeLog("analysePage","after computescore")}}n.push(l),c?.delete(),u?.delete(),f?.delete()}console.timeEnd("analysePage")}le.currentTarget.postMessage({msg:t.msg,payload:n,uid:t.uid},s)}})).apply(this,arguments)}function Me(t,e,s){let n=0;for(let r=0;r<e.length;r++)t.substring(r,r+1).toLowerCase()===e[r][0].toLowerCase()?n+=e[r][1]:n+=s?(1-e[r][1])/35:(1-e[r][1])/9;e>0&&(n/=e.length);const o=t.trim(),a=function ut(t,e){let s=new Array(t.length+1);for(let n=0;n<=t.length;n++)s[n]=new Array(e.length+1);for(let n=0;n<=t.length;n++)s[n][0]=n;for(let n=0;n<=e.length;n++)s[0][n]=n;for(let n=1;n<=t.length;n++)for(let o=1;o<=e.length;o++)s[n][o]=t[n-1]===e[o-1]?s[n-1][o-1]:Math.min(s[n-1][o],s[n][o-1],s[n-1][o-1])+1;return s[t.length][e.length]}(o,e.map(r=>r[0]).join(""));return n-=n*a/Math.max(e.map(r=>r[0]).join("").length,o.length),n}function De(t,e,s,n){let o=0,a=0,i=0,r=0,c=0;return e?.solution?.length>0&&(o=Me(t.name,e.solution,!0),r+=1,c+=o),s?.solution?.length>0&&(a=Me(t.firstname,s.solution,!0),r+=1,c+=a),n?.solution?.length>0&&(i=Me(t.ine,n.solution,!1),r+=1,c+=i),r>0?c/r:0}function Re(t,e,s,n,o,a,i){let r=new cv.Mat;cv.cvtColor(s,r,cv.COLOR_RGBA2GRAY,0);const c=fe(r,n),u=c.cases.sort(We),f=[],p=[];for(let h=0;h<u.length;h++){const b=u[h],F=Y(b);p.push(F);const j=H(b);f.push(j)}for(let h=0;h<c.cases.length;h++)c.cases[h].delete();for(let h=0;h<c.img_cases.length;h++)c.img_cases[h].delete();const l=f.map(h=>h.x);let g=[];for(let h=0;h<f.length-1;h++)g.push(l[h+1]-l[h]);let _=g.reduce((h,b)=>h+b,0)/g.length;g=g.filter(h=>h<1.1*_),_=g.reduce((h,b)=>h+b,0)/g.length;const E={w:p.map(h=>h.w).reduce((h,b)=>h+b,0)/p.length,h:p.map(h=>h.h).reduce((h,b)=>h+b,0)/p.length};return r.delete(),function ht(t,e,s,n,o,a,i,r){return Ee.apply(this,arguments)}(e,o,a,t,n,E,_,i)}function q(t){const e=new cv.Mat,s=t.type()%8,n=s<=cv.CV_8S?1:s<=cv.CV_32S?1/256:255,o=s===cv.CV_8S||s===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,o),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}function Ee(){return(Ee=(0,D.Z)(function*(t,e,s,n,o,a,i,r){const c=function dt(t){return t?(void 0===xe&&(xe=new A(t)),xe):(void 0===Ce&&(Ce=new A(t)),Ce)}(n);yield c.isWarmedUp;const u=function ft(t,e,s,n,o,a){const i=n.linelength,r=n.repairsize,c=n.dilatesize,u=n.morphsize,f=n.drawcontoursizeh,p=n.drawcontoursizev;let l=t.clone(),g=new cv.Mat;cv.cvtColor(t,g,cv.COLOR_BGR2GRAY,0);let _=new cv.Mat;cv.threshold(g,_,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);const E=new cv.Point(-1,-1);if(e){let d=new cv.Mat,C=new cv.Size(1,i),I=cv.getStructuringElement(cv.MORPH_RECT,C,E);cv.morphologyEx(_,d,cv.MORPH_OPEN,I,E,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let G=new cv.MatVector,U=new cv.Mat;cv.findContours(d,G,U,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let z=new cv.Scalar(255,255,255);cv.drawContours(l,G,-1,z,p);let J=new cv.Mat,ie=new cv.Size(i,1),se=cv.getStructuringElement(cv.MORPH_RECT,ie,E),re=new cv.Point(-1,-1);cv.morphologyEx(_,J,cv.MORPH_OPEN,se,re,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let $=new cv.MatVector,ce=new cv.Mat;cv.findContours(J,$,ce,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let he=new cv.Scalar(255,255,255);cv.drawContours(l,$,-1,he,f),d.delete(),G.delete(),U.delete(),I.delete(),J.delete(),$.delete(),ce.delete(),se.delete()}let h=new cv.Size(r,r),b=cv.getStructuringElement(cv.MORPH_ELLIPSE,h,E),F=new cv.Mat,L=new cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);L.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(L,L,cv.COLOR_BGR2GRAY,0);let T=new cv.Mat;cv.cvtColor(l,T,cv.COLOR_BGR2GRAY,0);let N=new cv.Mat;cv.subtract(L,T,N,F,-1);let V=new cv.Mat;cv.dilate(N,V,b,E,c,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let x=new cv.Mat,B=new cv.Mat;cv.bitwise_and(V,_,x),cv.morphologyEx(x,B,cv.MORPH_CLOSE,b,E,u,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let k=new cv.Mat;cv.bitwise_and(B,_,k);let S=new cv.Mat;cv.subtract(L,k,S,F,-1);let O=new cv.MatVector,R=new cv.Mat,Z=new cv.Mat;cv.adaptiveThreshold(S,Z,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,3,2),cv.findContours(Z,O,R,cv.RETR_TREE,cv.CHAIN_APPROX_SIMPLE);const de=new Map;let w=[];for(let d=0;d<O.size();d++){let C=O.get(d),I=cv.boundingRect(C);(I.width>12||I.height>12)&&w.push(I)}w=w.filter(d=>Math.abs(d.width-o.w)/o.w<.8&&Math.abs(d.height-o.h)/o.h<.7),w.forEach(d=>{const C=d.width-o.w;C>0&&(d.x=d.x+C/2,d.width=o.w);const I=d.height-o.h;I>0&&(d.y=d.y+I/2,d.height=o.h)});let ae=He(w),Se=0;for(;null!==ae&&Se<200;){w=w.filter(G=>G!==ae.toRemove1&&G!==ae.toRemove2);const d=ae.u,C=d.width-o.w;C>0&&(d.x=d.x+C/2,d.width=o.w);const I=d.height-o.h;I>0&&(d.y=d.y+I/2,d.height=o.h),w.push(d),ae=He(w),Se+=1}w.forEach(d=>{d.x=d.x-2,d.width=d.width+4,d.y=d.y-2,d.height=d.height+4}),w.sort((d,C)=>d.x<C.x?-1:1);const Fe=[];if(w.length>2)for(let d=0;d<w.length-1;d++)w[d+1].x-w[d].x<1.5*a||w[d+1].x-w[d].x<2.5*a||Fe.push(d+1);w=w.filter((d,C)=>!Fe.includes(C));const je=[];if(s&&w.length>1){const d=o.w;let C=0,I=0,G=800;const U=[];for(let z=0;z<w.length-1;z++)w[z+1].x-w[z].x>2*d&&U.push(z),w[z].y<G&&(G=w[z].y),w[z].height>C&&(C=w[z].height),w[z].width>I&&(I=w[z].width);U.forEach(z=>{let ie=new cv.Rect(w[z].x+a,G,I,C);je.push(ie)})}w=w.concat(je),w.sort((d,C)=>d.x<C.x?-1:1),w.forEach(d=>{let C=new cv.Scalar(0,0,0),I=new cv.Point(d.x,d.y),G=new cv.Point(d.x+d.width,d.y+d.height),U=new cv.Mat,z=new cv.Mat,J=new cv.Mat,ie=new cv.Scalar(255,255,255,255);U=Pe(S,d);const se=o.w/o.h,re=U.size().width/U.size().height;let $=new cv.Size(28,28);if(se<re){let ze=Math.floor(26*se/re);$=new cv.Size(26,ze+1)}else{let ze=Math.floor(26*re/se);$=new cv.Size(ze+1,26)}const ce=(28-$.height)/2,he=(28-$.width)/2;cv.resize(U,z,$,0,0,cv.INTER_AREA),cv.copyMakeBorder(z,J,ce,ce,he,he,cv.BORDER_CONSTANT,ie),de.set(d,J),U.delete(),z.delete(),cv.rectangle(S,I,G,C,2,cv.LINE_AA,0)}),g.delete(),_.delete(),Z.delete(),b.delete(),F.delete(),L.delete(),T.delete(),N.delete(),V.delete(),l.delete(),x.delete(),B.delete(),k.delete(),O.delete(),R.delete();let Ve=[...de];return Ve.sort((d,C)=>d[0].x<C[0].x?-1:1),{letter:Ve,invert_final:S}}(t,s,e,o,a,i),f=[];for(let p=0;p<u.letter.length;p++){let l=c.predict(q(u.letter[p][1]));n&&("1"===l[0]&&(l[0]="i"),"0"===l[0]&&(l[0]="o"),"5"===l[0]&&(l[0]="s"),"3"===l[0]&&(l[0]="b"),"9"===l[0]&&(l[0]="g")),f.push(l)}for(let p=0;p<u.letter.length;p++)u.letter[p][1].delete();return r?{debug:u.invert_final,solution:f}:(u.invert_final.delete(),{solution:f})})).apply(this,arguments)}function Pe(t,e,s){const n=t.size().width,o=t.size().height;return e.x<0&&(e.x=0),e.y<0&&(e.y=0),e.x+e.width>n&&(e.width=n-e.x),e.y+e.height>o&&(e.height=o-e.y),t.roi(e)}function gt(t,e){const s=Math.min(t.x,e.x),n=Math.min(t.y,e.y),o=Math.max(t.x+t.width,e.x+e.width),a=Math.max(t.y+t.height,e.y+e.height);return new cv.Rect(s,n,o-s,a-n)}function mt(t,e){let s=e,n=t,o=t,a=e;t.x>e.x&&(s=t,n=e),t.y>e.y&&(o=e,a=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let i=e,r=t,c=e,u=t;return t.right>e.right&&(i=t,r=e),t.bottom>e.bottom&&(c=t,u=e),s.x<n.right&&a.y>o.y+o.height?new cv.Rect(n.x,u.y,i.right-n.x,c.bottom-o.y):s.x>n.x+n.width+5||a.y>o.y+o.height?null:new cv.Rect(n.x,u.y,i.right-n.x,c.bottom-o.y)}function He(t){for(let e=0;e<t.length-1;e++){const s=t[e];for(let n=e+1;n<t.length;n++){const o=t[n];if(null!==mt(s,o))return{u:gt(s,o),toRemove1:s,toRemove2:o}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"shareWorker":{const e=t.data.port;oe=new tt(e),e.onmessage=oe.onmessage,e.onerror=oe.onerror;break}case"load":{le=t;const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(s=>{cv=s,s.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function lt(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),s=new cv.Mat;const n=new ImageData(new Uint8ClampedArray(t.payload.image),t.payload.imageWidth,t.payload.imageHeight);let o=cv.matFromImageData(n);s=Pe(o,e);const a=q(s).data.buffer;le.currentTarget.postMessage({msg:t.msg,payload:a,uid:t.uid},[a]),s.delete(),o.delete()}(t.data);case"doPredictions":return function it(t){(function rt(t){return be.apply(this,arguments)})(t).then(()=>{}).catch(e=>{console.error(e)})}(t.data);case"imageCropFromZone":return function ot(t){!function st(t){_e.apply(this,arguments)}(t)}(t.data);case"groupImagePerContoursLength":return function ct(t){0===t.payload.images.length&&postMessage({msg:t.msg,payload:[],uid:t.uid});const e=t.payload.images[t.payload.images.length-1].studentIndex+1,n=t.payload.nbrCluster,a=new cv.TermCriteria(cv.TermCriteria_EPS+cv.TermCriteria_MAX_ITER,1e3,.001),i=[];for(let g=0;g<e;g++){let _=0,E=0;const h=t.payload.images.length/e;for(let b=0;b<h;b++){const F=new ImageData(new Uint8ClampedArray(t.payload.images[g*h+b].image),t.payload.images[g*h+b].width,t.payload.images[g*h+b].height);let j=cv.matFromImageData(F);const L=new cv.Mat;cv.cvtColor(j,L,cv.COLOR_RGBA2GRAY);const T=new cv.Mat;cv.Canny(L,T,100,200,3);const B=new cv.MatVector,k=new cv.Mat;cv.findContours(T,B,k,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);for(let S=0;S<B.size();S++){const O=B.get(S),R=cv.arcLength(O,!0);R>3&&(_+=R,E+=1)}j.delete(),L.delete(),T.delete(),B.delete(),k.delete()}i.push(_),i.push(E)}const r=new cv.Mat,c=new cv.Mat,u=cv.matFromArray(i.length/2,2,cv.CV_32F,i);cv.kmeans(u,n,r,a,5,cv.KMEANS_PP_CENTERS,c);let f=[];for(let g=0;g<n;g++)f.push(c.data32F[2*g+1]);f.sort(function(g,_){return g-_});let p=new Map;for(let g=0;g<n;g++)p.set((c.data32F.indexOf(f[g])-1)/2,g);let l=[];for(let g=0;g<e;g++)l.push(p.get(r.data32S[g]));postMessage({msg:t.msg,payload:l,uid:t.uid}),r.delete(),c.delete(),u.delete()}(t.data);case"qcmresolution":return function W(t){const e={solutions:[]};let s=cv.matFromImageData(t.payload.imageTemplate),n=new cv.Mat;cv.cvtColor(s,n,cv.COLOR_RGBA2GRAY,0);const o=fe(n,t.payload.preference);t.payload.pages?.forEach((a,i)=>{let r=new cv.Mat,c=cv.matFromImageData(a.imageInput),u=new cv.Mat,f=new cv.Size(s.size().width,s.size().height);cv.resize(c,u,f,0,0,cv.INTER_AREA),cv.cvtColor(u,r,cv.COLOR_RGBA2GRAY,0);{const p=fe(r,t.payload.preference);let l;if(void 0!==p&&void 0!==p.cases&&p.cases.length>0){const h=function $e(t,e){const s=[];return t.cases.forEach(n=>{let a,o=500;if(e.cases.forEach(i=>{const r=function Qe(t,e){const s=cv.boundingRect(t),n=cv.boundingRect(e);let o=s.x+s.width/2,a=s.y+s.height/2,i=n.x+n.width/2,r=n.y+n.height/2;return Math.sqrt((o-i)*(o-i)+(a-r)*(a-r))}(n,i);o>r&&r<25&&(o=r,a=i)}),void 0!==a){const i=H(n),r=H(a),c=Y(n),u=Y(a);s.push({x:i.x-r.x,y:i.y-r.y,deltaw:c.w-u.w,deltah:c.h-u.h})}}),function Ge(t){if(t.length>0){const e=Math.min(...t.map(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y))),s=t.filter(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y)===e)[0];return{x:s.x,y:s.y}}return{x:0,y:0}}(s)}(p,o);l=function Ke(t,e){let s=new cv.Mat;if(0!==e.x||0!==e.y){let n=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),o=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,s,n,o,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),s}return t}(u,h)}else l=u;let g=function Je(t,e,s,n){const o=[],a=[];let i=new Map;const r=new Map,c=new cv.Mat;cv.cvtColor(e,c,cv.COLOR_RGBA2GRAY,0);let u=new cv.Mat;cv.threshold(c,u,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);const f=new cv.Mat;cv.cvtColor(s,f,cv.COLOR_RGBA2GRAY,0);let p=new cv.Mat;return cv.threshold(f,p,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU),t.cases.forEach((l,g)=>{const _=Le(ge(u,K(l),ne(l)));r.set(g,_)}),c.delete(),u.delete(),t.cases.forEach((l,g)=>{const _=ge(p,K(l),ne(l)),h=Le(_)-r.get(g);h>n.qcm_differences_avec_case_blanche?(i.set(g,{verdict:!0,prediction:h}),o.push(l)):(i.set(g,{verdict:!1,prediction:h}),a.push(l)),h>n.qcm_differences_avec_case_blanche&&h<1.15*n.qcm_differences_avec_case_blanche?cv.putText(s,""+h.toFixed(2),{x:K(l).x,y:K(l).y+10},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(s,""+h.toFixed(2),{x:K(l).x,y:K(l).y+10},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),_.delete()}),f.delete(),p.delete(),Ie(s,o,new cv.Scalar(0,255,0,128),2),Ie(s,a,new cv.Scalar(0,0,255,128),2),i}(o,s,l,t.payload.preference),_=function X(t){const e=new cv.Mat,s=t.type()%8,n=s<=cv.CV_8S?1:s<=cv.CV_32S?1/256:255,o=s===cv.CV_8S||s===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,o),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}(l),E=[];g.forEach((h,b)=>{h.verdict&&E.push(String.fromCharCode(97+b))}),e.solutions?.push({imageSolution:_,numero:i,solution:E.join("&")}),r.delete(),u.delete(),c.delete(),l!==u&&l.delete(),p.cases.forEach(h=>h.delete()),p.img_cases.forEach(h=>h.delete())}}),s.delete(),n.delete(),o.img_cases.forEach(a=>a.delete()),postMessage({msg:t.msg,payload:e,uid:t.uid})}(t.data)}})}},Te={};function v(m){var P=Te[m];if(void 0!==P)return P.exports;var y=Te[m]={exports:{}};return Ae[m](y,y.exports,v),y.exports}v.m=Ae,v.x=()=>{var m=v.O(void 0,[166,592],()=>v(1065));return v.O(m)},m=[],v.O=(P,y,D,M)=>{if(!y){var X=1/0;for(A=0;A<m.length;A++){for(var[y,D,M]=m[A],te=!0,W=0;W<y.length;W++)(!1&M||X>=M)&&Object.keys(v.O).every(ue=>v.O[ue](y[W]))?y.splice(W--,1):(te=!1,M<X&&(X=M));if(te){m.splice(A--,1);var ne=D();void 0!==ne&&(P=ne)}}return P}M=M||0;for(var A=m.length;A>0&&m[A-1][2]>M;A--)m[A]=m[A-1];m[A]=[y,D,M]},v.d=(m,P)=>{for(var y in P)v.o(P,y)&&!v.o(m,y)&&Object.defineProperty(m,y,{enumerable:!0,get:P[y]})},v.f={},v.e=m=>Promise.all(Object.keys(v.f).reduce((P,y)=>(v.f[y](m,P),P),[])),v.u=m=>(592===m?"common":m)+"."+{166:"eae8c3b8f450e31b",592:"c7953d2bd00bf388"}[m]+".js",v.miniCssF=m=>{},v.o=(m,P)=>Object.prototype.hasOwnProperty.call(m,P),v.j=65,(()=>{var m;v.tt=()=>(void 0===m&&(m={createScriptURL:P=>P},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(m=trustedTypes.createPolicy("angular#bundler",m))),m)})(),v.tu=m=>v.tt().createScriptURL(m),v.p="",(()=>{var m={65:1};v.f.i=(M,A)=>{m[M]||importScripts(v.tu(v.p+v.u(M)))};var y=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],D=y.push.bind(y);y.push=M=>{var[A,X,te]=M;for(var W in X)v.o(X,W)&&(v.m[W]=X[W]);for(te&&te(v);A.length;)m[A.pop()]=1;D(M)}})(),(()=>{var m=v.x;v.x=()=>Promise.all([v.e(166),v.e(592)]).then(m)})(),v.x()})();