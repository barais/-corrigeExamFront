(()=>{"use strict";var m,Pe={1065:(m,A,y)=>{var F=y(5861),R=y(4942);class O{constructor(e){(0,R.Z)(this,"alphabet",void 0),(0,R.Z)(this,"characters",void 0),(0,R.Z)(this,"isWarmedUp",void 0),(0,R.Z)(this,"_model",void 0),e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(s=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),s()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(s=>{this._model=s,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(s=>{this._model=s,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const a=e.width>e.height,i=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),r=a?[[i,i],[0,0],[0,0]]:[[0,0],[i,i],[0,0]];return tf.tidy(()=>{let c=tf.browser.fromPixels(e,1).pad(r,255);return c=tf.image.resizeBilinear(c,[24,24]).pad([[2,2],[2,2],[0,0]],255),c=tf.scalar(1).sub(c.toFloat().div(tf.scalar(255))),c.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const s=this.preprocessImage(e),n=this._model.predict(s).as1D(),o=n.argMax().dataSync()[0],a=n.max().dataSync()[0];return[this.characters[o],a]}}function E(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function P(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function Ae(t,e){const s=e.qcm_epsilon*cv.arcLength(t,!0),n=new cv.Mat;let o;cv.approxPolyDP(t,n,s,!0);const a=E(n);if(a.w>=e.qcm_min_width_shape&&a.h>=e.qcm_min_height_shape){const i=n.rows;if(1===i)o="LIGNE";else if(3===i)o="TRIANGLE";else if(4===i){const r=a.w/a.h;o=r>=.95&&r<=1.05?"CARRE":"RECTANGLE"}else o=void 0}return{nom:o,forme:n}}function ze(t,e){let s=P(t),n=P(e);return s.y<n.y?-1:s.y>n.y?1:s.x-n.x}function Xe(t,e){let s=P(t),n=P(e);return s.x-n.x}function Te(t,e){let s=P(t),n=P(e),o=E(t),a=E(e);return(n.x>=s.x&&n.x<=s.x+o.w||n.x+a.w>=s.x&&n.x+a.w<=s.x+o.w)&&(n.y>=s.y&&n.y<=s.y+o.h||n.y+a.h>=s.y&&n.y+a.h<=s.y+o.h)}function Oe(t,e){let s=e[t],n=!1;return e.forEach((o,a)=>{t<a&&function We(t,e){return Te(t,e)||Te(e,t)}(s,o)&&(n=!0)}),n}function Ie(t,e){const s=function he(t,e=[],s){const n=new cv.Mat;cv.threshold(t,n,245,255,cv.THRESH_BINARY);let o=new cv.MatVector,a=new cv.Mat;cv.findContours(n,o,a,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const i=[];for(let d=0;d<o.size();++d){const l=Ae(o.get(d),s);e.includes(l.nom)&&i.push(l.forme)}i.sort(ze);const r=[],c=[],f=[];return i.forEach(d=>{0===P(d).x&&0===P(d).y||(100*E(d).w/E(t).w+100*E(d).h/E(t).h)/2>80?c.push(d):f.push(d)}),f.forEach((d,p)=>{Oe(p,f)?c.push(d):r.push(d)}),c.forEach(d=>{d.delete()}),r}(t,["CARRE","RECTANGLE"],e),n=[],o=[];return s.forEach(a=>{const i=E(a),r=P(a);n.push(a),o.push(re(t,r,i))}),{cases:n,img_cases:o}}function re(t,e,s){let n=new cv.Mat,o=e.x,a=e.y,i=s.w,r=s.h;o<0&&(o=0),a<0&&(a=0),o+i>t.size().width&&(i=t.size().width-o),r+a>t.size().height&&(r=t.size().height-a);const c=new cv.Rect(o,a,i,r);return i<=0||r<=0?t:(n=t.roi(c),n)}function Le(t,e,s=new cv.Scalar(255,0,0,128),n=2){return e.forEach(o=>{const a=P(o),i=E(o);let r=new cv.Point(a.x,a.y),c=new cv.Point(a.x+i.w,a.y+i.h);cv.rectangle(t,r,c,s,n,0)}),t}function Ne(t){return 1-cv.countNonZero(t)/(t.rows*t.cols)}var ke=y(2384),Ze=y(8645),ue=y(4036),Ke=y(4004);let ce,te,$,be,Re;class et{constructor(e){(0,R.Z)(this,"sqliteWorkerport",void 0),(0,R.Z)(this,"ready",void 0),(0,R.Z)(this,"subjects",new Map),(0,R.Z)(this,"onmessage",n=>{const o=n.data;switch(o.msg){case"getFirstNonAlignImage":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}case"getFirstAlignImage":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}case"getFirstTemplate":{const a=new TextDecoder("utf-8"),i=new Uint8Array(o.payload.value);o.payload.value=a.decode(i),this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete();break}default:this.subjects.get(o.uid)?.next(o.payload),this.subjects.get(o.uid)?.complete()}}),(0,R.Z)(this,"onerror",n=>{this.subjects.has(n.uid)&&(console.log("get error uid"),this.subjects.get(n.uid)?.error(n)),console.log(`error on service work: ${JSON.stringify(n)}`)}),this.sqliteWorkerport=e;const s=new Ze.x;this.subjects.set("0",s),this.ready=new Promise((n,o)=>{this.subjects.get("0")?.asObservable().subscribe(()=>{n()},()=>o())})}_dispatch(e,s,n){const o=(0,Ke.Z)();this.ready.then(()=>{n?this.sqliteWorkerport.postMessage({msg:e,uid:o,payload:s},n):this.sqliteWorkerport.postMessage({msg:e,uid:o,payload:s})});const a=new Ze.x;return this.subjects.set(o,a),this.ready=new Promise((i,r)=>{this.subjects.get(o)?.asObservable().subscribe(()=>{i()},()=>r())}),a.asObservable()}getFirstNonAlignImage(e,s){return(0,ue.z)(this._dispatch("getFirstNonAlignImage",{examId:e,pageInscan:s}))}getFirstAlignImage(e,s){return(0,ue.z)(this._dispatch("getFirstAlignImage",{examId:e,pageInscan:s}))}getFirstTemplate(e,s){return(0,ue.z)(this._dispatch("getFirstTemplate",{examId:e,pageInscan:s}))}}function Be(t,e,s){return fe.apply(this,arguments)}function fe(){return(fe=(0,F.Z)(function*(t,e,s){return s?(void 0===$&&($=new ke.z),yield $.getFirstTemplate(e,t)):yield te.getFirstTemplate(e,t)})).apply(this,arguments)}function He(t,e,s,n){return ge.apply(this,arguments)}function ge(){return(ge=(0,F.Z)(function*(t,e,s,n){return n?(void 0===$&&($=new ke.z),t?yield $.getFirstAlignImage(s,e):yield $.getFirstNonAlignImage(s,e)):t?yield te.getFirstAlignImage(s,e):yield te.getFirstNonAlignImage(s,e)})).apply(this,arguments)}function tt(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.value):e}function me(t){return pe.apply(this,arguments)}function pe(){return(pe=(0,F.Z)(function*(t){const e=JSON.parse(t.value,tt),n=yield(yield fetch(e.pages)).blob(),o=yield createImageBitmap(n),i=new OffscreenCanvas(o.width,o.height).getContext("2d");return i.drawImage(o,0,0),i.getImageData(0,0,o.width,o.height)})).apply(this,arguments)}function K(t,e,s){let n=e.width*t.width*s/1e5,o=e.height*t.height*s/1e5,a=e.xInit*t.width/1e5-(e.width*t.width*s/1e5-e.width*t.width/1e5)/2;a<0&&(n+=a,a=0);let i=e.yInit*t.height/1e5-(e.height*t.height*s/1e5-e.height*t.height/1e5)/2;i<0&&(o+=i,i=0);let r=new cv.Rect(a,i,n,o),c=new cv.Mat,f=cv.matFromImageData(t);return c=xe(f,r),f.delete(),c}function ve(){return(ve=(0,F.Z)(function*(t){const e=t.payload;let s;if(s=e.template?yield Be(e.page,e.examId,e.indexDb):yield He(e.align,e.page,e.examId,e.indexDb),void 0!==s){const o=K(yield me(s),e.z,e.factor),i={image:q(o).data.buffer,page:e.page,width:o.size().width,height:o.size().height};ce.currentTarget.postMessage({msg:t.msg,payload:i,uid:t.uid},[i.image]),o.delete()}})).apply(this,arguments)}function we(){return(we=(0,F.Z)(function*(t){const e=t.payload;if(function st(t){return"pagesToAnalyze"in t}(e)){const s=[],n=[],o=new Map;for(let a of e.pagesToAnalyze){console.time("analysePage"),console.timeLog("analysePage","before getScan");const i=yield He(e.align,a,e.examId,e.indexDb);if(console.timeLog("analysePage","after getScan"),void 0!==i){console.timeLog("analysePage","before loadImage");const r=yield me(i);console.timeLog("analysePage","after loadImage");let c,f,d,p=0;console.timeLog("analysePage","before cropZone"),e.nameZone&&(c=K(r,e.nameZone,e.factor),p=e.nameZone.pageNumber),e.firstnameZone&&(f=K(r,e.firstnameZone,e.factor),p=e.firstnameZone.pageNumber),e.ineZone&&(d=K(r,e.ineZone,e.factor),p=e.ineZone.pageNumber),console.timeLog("analysePage","after cropZone");const l={page:a-p,resultPrediction:[]};let g,_,S;if(c&&(g=q(c).data.buffer,l.nameZoneW=c.size().width,l.nameZoneH=c.size().height,g&&s.push(g)),f&&(_=q(f).data.buffer,l.firstnameZoneW=f.size().width,l.firstnameZoneH=f.size().height,_&&s.push(_)),d&&(S=q(d).data.buffer,l.ineZoneW=d.size().width,l.ineZoneH=d.size().height,S&&s.push(S)),l.nameZone=g,l.firstnameZone=_,l.ineZone=S,e.assist){console.timeLog("analysePage","before template load");const u=yield Be(e.pageTemplate,e.examId,e.indexDb);if(console.timeLog("analysePage","after template load"),void 0!==u){console.timeLog("analysePage","before template image load");const b=yield me(u);let j,V,k,I,Z,G;if(console.timeLog("analysePage","after template image load"),console.timeLog("analysePage","before cropZone template"),e.nameZone&&(j=K(b,e.nameZone,e.factor)),e.firstnameZone&&(V=K(b,e.firstnameZone,e.factor)),e.ineZone&&(k=K(b,e.ineZone,e.factor)),console.timeLog("analysePage","after cropZone template"),console.timeLog("analysePage","before doPredidction4zone name"),void 0!==c&&void 0!==j&&(I=yield _e(!0,c,j,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),j.delete(),I.debug)){const x=q(I.debug).data.buffer;x&&(s.push(x),l.nameZoneDebug=x),I.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone name"),console.timeLog("analysePage","before doPredidction4zone firstname"),void 0!==f&&void 0!==V&&(Z=yield _e(!0,f,V,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),V.delete(),Z.debug)){const x=q(Z.debug).data.buffer;x&&(s.push(x),l.firstnameZoneDebug=x),Z.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone firstname"),console.timeLog("analysePage","before doPredidction4zone ine"),void 0!==d&&void 0!==k&&(G=yield _e(!1,d,k,e.preferences,e.looking4missing,e.removeHorizontal,e.debug),k.delete(),G.debug)){const x=q(G.debug).data.buffer;x&&(s.push(x),l.ineZoneDebug=x),G.debug.delete()}if(console.timeLog("analysePage","after doPredidction4zone ine"),console.timeLog("analysePage","before computescore"),I?.solution?.length>0&&Z?.solution?.length>0){const x=I.solution.length,D=Z.solution.length,B=e.candidates.filter(M=>Math.abs(x-M.name.length)<=2&&Math.abs(D-M.firstname.length)<=2);o.set(l.page,new Map),B.forEach(M=>{const H={...M},le=Math.abs(x-M.name.length)+Math.abs(D-M.firstname.length);H.score=1e3/Math.pow(2,le),H.proba=De(H,I,Z,G),o.get(l.page)?.set(H.id,H)});const z=Array.from(o.get(l.page).values()).sort((M,H)=>H.proba*H.score-M.proba*M.score);let L=[];L=z.length>2?[z[0],z[1],z[2]]:z,l.resultPrediction=L}else if(I?.solution?.length>0){const x=I.solution.length,D=e.candidates.filter(L=>Math.abs(x-L.name.length)<=2);o.set(l.page,new Map),D.forEach(L=>{const M={...L},H=Math.abs(x-L.name.length);M.score=1e3/Math.pow(2,H),M.proba=De(M,I,Z,G),o.get(l.page)?.set(M.id,M)});const B=Array.from(o.get(l.page).values()).sort((L,M)=>M.proba*M.score-L.proba*L.score);let z=[];z=B.length>2?[B[0],B[1],B[2]]:B,l.resultPrediction=z}console.timeLog("analysePage","after computescore")}}n.push(l),c?.delete(),f?.delete(),d?.delete()}console.timeEnd("analysePage")}ce.currentTarget.postMessage({msg:t.msg,payload:n,uid:t.uid},s)}})).apply(this,arguments)}function ye(t,e,s){let n=0;for(let r=0;r<e.length;r++)t.substring(r,r+1).toLowerCase()===e[r][0].toLowerCase()?n+=e[r][1]:n+=s?(1-e[r][1])/35:(1-e[r][1])/9;e>0&&(n/=e.length);const o=t.trim(),a=function ut(t,e){let s=new Array(t.length+1);for(let n=0;n<=t.length;n++)s[n]=new Array(e.length+1);for(let n=0;n<=t.length;n++)s[n][0]=n;for(let n=0;n<=e.length;n++)s[0][n]=n;for(let n=1;n<=t.length;n++)for(let o=1;o<=e.length;o++)s[n][o]=t[n-1]===e[o-1]?s[n-1][o-1]:Math.min(s[n-1][o],s[n][o-1],s[n-1][o-1])+1;return s[t.length][e.length]}(o,e.map(r=>r[0]).join(""));return n-=n*a/Math.max(e.map(r=>r[0]).join("").length,o.length),n}function De(t,e,s,n){let o=0,a=0,i=0,r=0,c=0;return e?.solution?.length>0&&(o=ye(t.name,e.solution,!0),r+=1,c+=o),s?.solution?.length>0&&(a=ye(t.firstname,s.solution,!0),r+=1,c+=a),n?.solution?.length>0&&(i=ye(t.ine,n.solution,!1),r+=1,c+=i),r>0?c/r:0}function _e(t,e,s,n,o,a,i){let r=new cv.Mat;cv.cvtColor(s,r,cv.COLOR_RGBA2GRAY,0);const c=function rt(t,e){const s=function Ye(t,e=[],s){const n=new cv.Mat;cv.threshold(t,n,248,255,cv.THRESH_BINARY);let o=new cv.MatVector,a=new cv.Mat;cv.findContours(n,o,a,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const i=[];for(let d=0;d<o.size();++d){const l=Ae(o.get(d),s);e.includes(l.nom)&&i.push(l.forme)}i.sort(ze);const r=[],c=[],f=[];return i.forEach(d=>{0===P(d).x&&0===P(d).y||(100*E(d).w/E(t).w+100*E(d).h/E(t).h)/2>80?c.push(d):f.push(d)}),f.forEach((d,p)=>{Oe(p,f)?c.push(d):r.push(d)}),c.forEach(d=>{d.delete()}),r}(t,["CARRE","RECTANGLE"],e),n=[],o=[];return s.forEach(a=>{const i=E(a),r=P(a);n.push(a),o.push(re(t,r,i))}),{cases:n,img_cases:o}}(r,n),f=c.cases.sort(Xe),d=[],p=[];for(let u=0;u<f.length;u++){const b=f[u],j=E(b);p.push(j);const V=P(b);d.push(V)}for(let u=0;u<c.cases.length;u++)c.cases[u].delete();for(let u=0;u<c.img_cases.length;u++)c.img_cases[u].delete();const l=d.map(u=>u.x);let g=[];for(let u=0;u<d.length-1;u++)g.push(l[u+1]-l[u]);let _=g.reduce((u,b)=>u+b,0)/g.length;g=g.filter(u=>u<1.1*_),_=g.reduce((u,b)=>u+b,0)/g.length;const S={w:p.map(u=>u.w).reduce((u,b)=>u+b,0)/p.length,h:p.map(u=>u.h).reduce((u,b)=>u+b,0)/p.length};return r.delete(),function ht(t,e,s,n,o,a,i,r){return Me.apply(this,arguments)}(e,o,a,t,n,S,_,i)}function q(t){const e=new cv.Mat,s=t.type()%8,n=s<=cv.CV_8S?1:s<=cv.CV_32S?1/256:255,o=s===cv.CV_8S||s===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,o),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}function Me(){return(Me=(0,F.Z)(function*(t,e,s,n,o,a,i,r){const c=function dt(t){return t?(void 0===be&&(be=new O(t)),be):(void 0===Re&&(Re=new O(t)),Re)}(n);yield c.isWarmedUp;const f=function ft(t,e,s,n,o,a){const i=n.linelength,r=n.repairsize,c=n.dilatesize,f=n.morphsize,d=n.drawcontoursizeh,p=n.drawcontoursizev;let l=t.clone(),g=new cv.Mat;cv.cvtColor(t,g,cv.COLOR_BGR2GRAY,0);let _=new cv.Mat;cv.threshold(g,_,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);const S=new cv.Point(-1,-1);if(e){let h=new cv.Mat,C=new cv.Size(1,i),N=cv.getStructuringElement(cv.MORPH_RECT,C,S);cv.morphologyEx(_,h,cv.MORPH_OPEN,N,S,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let U=new cv.MatVector,Y=new cv.Mat;cv.findContours(h,U,Y,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let T=new cv.Scalar(255,255,255);cv.drawContours(l,U,-1,T,p);let J=new cv.Mat,se=new cv.Size(i,1),ne=cv.getStructuringElement(cv.MORPH_RECT,se,S),ae=new cv.Point(-1,-1);cv.morphologyEx(_,J,cv.MORPH_OPEN,ne,ae,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let Q=new cv.MatVector,ie=new cv.Mat;cv.findContours(J,Q,ie,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let de=new cv.Scalar(255,255,255);cv.drawContours(l,Q,-1,de,d),h.delete(),U.delete(),Y.delete(),N.delete(),J.delete(),Q.delete(),ie.delete(),ne.delete()}let u=new cv.Size(r,r),b=cv.getStructuringElement(cv.MORPH_ELLIPSE,u,S),j=new cv.Mat,k=new cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);k.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(k,k,cv.COLOR_BGR2GRAY,0);let I=new cv.Mat;cv.cvtColor(l,I,cv.COLOR_BGR2GRAY,0);let Z=new cv.Mat;cv.subtract(k,I,Z,j,-1);let G=new cv.Mat;cv.dilate(Z,G,b,S,c,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let x=new cv.Mat,D=new cv.Mat;cv.bitwise_and(G,_,x),cv.morphologyEx(x,D,cv.MORPH_CLOSE,b,S,f,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let B=new cv.Mat;cv.bitwise_and(D,_,B);let z=new cv.Mat;cv.subtract(k,B,z,j,-1);let L=new cv.MatVector,M=new cv.Mat,H=new cv.Mat;cv.adaptiveThreshold(z,H,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,3,2),cv.findContours(H,L,M,cv.RETR_TREE,cv.CHAIN_APPROX_SIMPLE);const le=new Map;let w=[];for(let h=0;h<L.size();h++){let C=L.get(h),N=cv.boundingRect(C);(N.width>12||N.height>12)&&w.push(N)}w=w.filter(h=>Math.abs(h.width-o.w)/o.w<.8&&Math.abs(h.height-o.h)/o.h<.7),w.forEach(h=>{const C=h.width-o.w;C>0&&(h.x=h.x+C/2,h.width=o.w);const N=h.height-o.h;N>0&&(h.y=h.y+N/2,h.height=o.h)});let oe=Fe(w),Ce=0;for(;null!==oe&&Ce<200;){w=w.filter(U=>U!==oe.toRemove1&&U!==oe.toRemove2);const h=oe.u,C=h.width-o.w;C>0&&(h.x=h.x+C/2,h.width=o.w);const N=h.height-o.h;N>0&&(h.y=h.y+N/2,h.height=o.h),w.push(h),oe=Fe(w),Ce+=1}w.forEach(h=>{h.x=h.x-2,h.width=h.width+4,h.y=h.y-2,h.height=h.height+4}),w.sort((h,C)=>h.x<C.x?-1:1);const je=[];if(w.length>2)for(let h=0;h<w.length-1;h++)w[h+1].x-w[h].x<1.5*a||w[h+1].x-w[h].x<2.5*a||je.push(h+1);w=w.filter((h,C)=>!je.includes(C));const Ve=[];if(s&&w.length>1){const h=o.w;let C=0,N=0,U=800;const Y=[];for(let T=0;T<w.length-1;T++)w[T+1].x-w[T].x>2*h&&Y.push(T),w[T].y<U&&(U=w[T].y),w[T].height>C&&(C=w[T].height),w[T].width>N&&(N=w[T].width);Y.forEach(T=>{let se=new cv.Rect(w[T].x+a,U,N,C);Ve.push(se)})}w=w.concat(Ve),w.sort((h,C)=>h.x<C.x?-1:1),w.forEach(h=>{let C=new cv.Scalar(0,0,0),N=new cv.Point(h.x,h.y),U=new cv.Point(h.x+h.width,h.y+h.height),Y=new cv.Mat,T=new cv.Mat,J=new cv.Mat,se=new cv.Scalar(255,255,255,255);Y=xe(z,h);const ne=o.w/o.h,ae=Y.size().width/Y.size().height;let Q=new cv.Size(28,28);if(ne<ae){let Ee=Math.floor(26*ne/ae);Q=new cv.Size(26,Ee+1)}else{let Ee=Math.floor(26*ae/ne);Q=new cv.Size(Ee+1,26)}const ie=(28-Q.height)/2,de=(28-Q.width)/2;cv.resize(Y,T,Q,0,0,cv.INTER_AREA),cv.copyMakeBorder(T,J,ie,ie,de,de,cv.BORDER_CONSTANT,se),le.set(h,J),Y.delete(),T.delete(),cv.rectangle(z,N,U,C,2,cv.LINE_AA,0)}),g.delete(),_.delete(),H.delete(),b.delete(),j.delete(),k.delete(),I.delete(),Z.delete(),G.delete(),l.delete(),x.delete(),D.delete(),B.delete(),L.delete(),M.delete();let Ge=[...le];return Ge.sort((h,C)=>h[0].x<C[0].x?-1:1),{letter:Ge,invert_final:z}}(t,s,e,o,a,i),d=[];for(let p=0;p<f.letter.length;p++){let l=c.predict(q(f.letter[p][1]));console.error(l),n&&("1"===l[0]&&(l[0]="i"),"0"===l[0]&&(l[0]="o"),"5"===l[0]&&(l[0]="s"),"3"===l[0]&&(l[0]="b"),"9"===l[0]&&(l[0]="g")),d.push(l)}for(let p=0;p<f.letter.length;p++)f.letter[p][1].delete();return r?{debug:f.invert_final,solution:d}:(f.invert_final.delete(),{solution:d})})).apply(this,arguments)}function xe(t,e,s){const n=t.size().width,o=t.size().height;return e.x<0&&(e.x=0),e.y<0&&(e.y=0),e.x+e.width>n&&(e.width=n-e.x),e.y+e.height>o&&(e.height=o-e.y),t.roi(e)}function gt(t,e){const s=Math.min(t.x,e.x),n=Math.min(t.y,e.y),o=Math.max(t.x+t.width,e.x+e.width),a=Math.max(t.y+t.height,e.y+e.height);return new cv.Rect(s,n,o-s,a-n)}function mt(t,e){let s=e,n=t,o=t,a=e;t.x>e.x&&(s=t,n=e),t.y>e.y&&(o=e,a=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let i=e,r=t,c=e,f=t;return t.right>e.right&&(i=t,r=e),t.bottom>e.bottom&&(c=t,f=e),s.x<n.right&&a.y>o.y+o.height?new cv.Rect(n.x,f.y,i.right-n.x,c.bottom-o.y):s.x>n.x+n.width+5||a.y>o.y+o.height?null:new cv.Rect(n.x,f.y,i.right-n.x,c.bottom-o.y)}function Fe(t){for(let e=0;e<t.length-1;e++){const s=t[e];for(let n=e+1;n<t.length;n++){const o=t[n];if(null!==mt(s,o))return{u:gt(s,o),toRemove1:s,toRemove2:o}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"shareWorker":{const e=t.data.port;te=new et(e),e.onmessage=te.onmessage,e.onerror=te.onerror;break}case"load":{ce=t;const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(s=>{cv=s,s.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function lt(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),s=new cv.Mat;const n=new ImageData(new Uint8ClampedArray(t.payload.image),t.payload.imageWidth,t.payload.imageHeight);let o=cv.matFromImageData(n);s=xe(o,e);const a=q(s).data.buffer;ce.currentTarget.postMessage({msg:t.msg,payload:a,uid:t.uid},[a]),s.delete(),o.delete()}(t.data);case"doPredictions":return function at(t){(function it(t){return we.apply(this,arguments)})(t).then(()=>{}).catch(e=>{console.error(e)})}(t.data);case"imageCropFromZone":return function nt(t){!function ot(t){ve.apply(this,arguments)}(t)}(t.data);case"groupImagePerContoursLength":return function ct(t){0===t.payload.images.length&&postMessage({msg:t.msg,payload:[],uid:t.uid});const e=t.payload.images[t.payload.images.length-1].studentIndex+1,n=t.payload.nbrCluster,a=new cv.TermCriteria(cv.TermCriteria_EPS+cv.TermCriteria_MAX_ITER,1e3,.001),i=[];for(let g=0;g<e;g++){let _=0,S=0;const u=t.payload.images.length/e;for(let b=0;b<u;b++){const j=new ImageData(new Uint8ClampedArray(t.payload.images[g*u+b].image),t.payload.images[g*u+b].width,t.payload.images[g*u+b].height);let V=cv.matFromImageData(j);const k=new cv.Mat;cv.cvtColor(V,k,cv.COLOR_RGBA2GRAY);const I=new cv.Mat;cv.Canny(k,I,100,200,3);const D=new cv.MatVector,B=new cv.Mat;cv.findContours(I,D,B,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);for(let z=0;z<D.size();z++){const L=D.get(z),M=cv.arcLength(L,!0);M>3&&(_+=M,S+=1)}V.delete(),k.delete(),I.delete(),D.delete(),B.delete()}i.push(_),i.push(S)}const r=new cv.Mat,c=new cv.Mat,f=cv.matFromArray(i.length/2,2,cv.CV_32F,i);cv.kmeans(f,n,r,a,5,cv.KMEANS_PP_CENTERS,c);let d=[];for(let g=0;g<n;g++)d.push(c.data32F[2*g+1]);d.sort(function(g,_){return g-_});let p=new Map;for(let g=0;g<n;g++)p.set((c.data32F.indexOf(d[g])-1)/2,g);let l=[];for(let g=0;g<e;g++)l.push(p.get(r.data32S[g]));postMessage({msg:t.msg,payload:l,uid:t.uid}),r.delete(),c.delete(),f.delete()}(t.data);case"qcmresolution":return function X(t){const e={solutions:[]};let s=cv.matFromImageData(t.payload.imageTemplate),n=new cv.Mat;cv.cvtColor(s,n,cv.COLOR_RGBA2GRAY,0);const o=Ie(n,t.payload.preference);t.payload.pages?.forEach((a,i)=>{let r=new cv.Mat,c=cv.matFromImageData(a.imageInput),f=new cv.Mat,d=new cv.Size(s.size().width,s.size().height);cv.resize(c,f,d,0,0,cv.INTER_AREA),cv.cvtColor(f,r,cv.COLOR_RGBA2GRAY,0);const p=Ie(r,t.payload.preference);let l;if(void 0!==p&&void 0!==p.cases&&p.cases.length>0){const u=function Je(t,e){const s=[];return t.cases.forEach(n=>{let a,o=500;if(e.cases.forEach(i=>{const r=function $e(t,e){const s=cv.boundingRect(t),n=cv.boundingRect(e);let o=s.x+s.width/2,a=s.y+s.height/2,i=n.x+n.width/2,r=n.y+n.height/2;return Math.sqrt((o-i)*(o-i)+(a-r)*(a-r))}(n,i);o>r&&r<25&&(o=r,a=i)}),void 0!==a){const i=P(n),r=P(a),c=E(n),f=E(a);s.push({x:i.x-r.x,y:i.y-r.y,deltaw:c.w-f.w,deltah:c.h-f.h})}}),function Ue(t){if(t.length>0){const e=Math.min(...t.map(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y))),s=t.filter(n=>Math.abs(n.deltaw)*Math.abs(n.deltaw)+Math.abs(n.deltah)*Math.abs(n.deltah)+Math.abs(n.x)+Math.abs(n.y)===e)[0];return{x:s.x,y:s.y}}return{x:0,y:0}}(s)}(p,o);l=function Qe(t,e){let s=new cv.Mat;if(0!==e.x||0!==e.y){let n=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),o=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,s,n,o,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),s}return t}(f,u)}else l=f;let g=function qe(t,e,s,n){const o=[],a=[];let i=new Map;const r=new Map,c=new cv.Mat;cv.cvtColor(e,c,cv.COLOR_RGBA2GRAY,0);let f=new cv.Mat;cv.threshold(c,f,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);const d=new cv.Mat;cv.cvtColor(s,d,cv.COLOR_RGBA2GRAY,0);let p=new cv.Mat;return cv.threshold(d,p,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU),t.cases.forEach((l,g)=>{const _=Ne(re(f,P(l),E(l)));r.set(g,_)}),c.delete(),f.delete(),t.cases.forEach((l,g)=>{const _=re(p,P(l),E(l)),u=Ne(_)-r.get(g);u>n.qcm_differences_avec_case_blanche?(i.set(g,{verdict:!0,prediction:u}),o.push(l)):(i.set(g,{verdict:!1,prediction:u}),a.push(l)),u>n.qcm_differences_avec_case_blanche&&u<1.15*n.qcm_differences_avec_case_blanche?cv.putText(s,""+u.toFixed(2),{x:P(l).x,y:P(l).y+10},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(s,""+u.toFixed(2),{x:P(l).x,y:P(l).y+10},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),_.delete()}),d.delete(),p.delete(),Le(s,o,new cv.Scalar(0,255,0,128),2),Le(s,a,new cv.Scalar(0,0,255,128),2),i}(o,s,l,t.payload.preference),_=function W(t){const e=new cv.Mat,s=t.type()%8,n=s<=cv.CV_8S?1:s<=cv.CV_32S?1/256:255,o=s===cv.CV_8S||s===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,n,o),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}(l),S=[];g.forEach((u,b)=>{u.verdict&&S.push(String.fromCharCode(97+b))}),e.solutions?.push({imageSolution:_,numero:i,solution:S.join("&")}),r.delete(),f.delete(),c.delete(),l!==f&&l.delete(),p.cases.forEach(u=>u.delete()),p.img_cases.forEach(u=>u.delete())}),s.delete(),n.delete(),o.img_cases.forEach(a=>a.delete()),postMessage({msg:t.msg,payload:e,uid:t.uid})}(t.data)}})}},Se={};function v(m){var A=Se[m];if(void 0!==A)return A.exports;var y=Se[m]={exports:{}};return Pe[m](y,y.exports,v),y.exports}v.m=Pe,v.x=()=>{var m=v.O(void 0,[166,592],()=>v(1065));return v.O(m)},m=[],v.O=(A,y,F,R)=>{if(!y){var W=1/0;for(O=0;O<m.length;O++){for(var[y,F,R]=m[O],ee=!0,X=0;X<y.length;X++)(!1&R||W>=R)&&Object.keys(v.O).every(he=>v.O[he](y[X]))?y.splice(X--,1):(ee=!1,R<W&&(W=R));if(ee){m.splice(O--,1);var E=F();void 0!==E&&(A=E)}}return A}R=R||0;for(var O=m.length;O>0&&m[O-1][2]>R;O--)m[O]=m[O-1];m[O]=[y,F,R]},v.d=(m,A)=>{for(var y in A)v.o(A,y)&&!v.o(m,y)&&Object.defineProperty(m,y,{enumerable:!0,get:A[y]})},v.f={},v.e=m=>Promise.all(Object.keys(v.f).reduce((A,y)=>(v.f[y](m,A),A),[])),v.u=m=>(592===m?"common":m)+"."+{166:"eae8c3b8f450e31b",592:"c7953d2bd00bf388"}[m]+".js",v.miniCssF=m=>{},v.o=(m,A)=>Object.prototype.hasOwnProperty.call(m,A),v.j=65,(()=>{var m;v.tt=()=>(void 0===m&&(m={createScriptURL:A=>A},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(m=trustedTypes.createPolicy("angular#bundler",m))),m)})(),v.tu=m=>v.tt().createScriptURL(m),v.p="",(()=>{var m={65:1};v.f.i=(R,O)=>{m[R]||importScripts(v.tu(v.p+v.u(R)))};var y=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],F=y.push.bind(y);y.push=R=>{var[O,W,ee]=R;for(var X in W)v.o(W,X)&&(v.m[X]=W[X]);for(ee&&ee(v);O.length;)m[O.pop()]=1;F(R)}})(),(()=>{var m=v.x;v.x=()=>Promise.all([v.e(166),v.e(592)]).then(m)})(),v.x()})();