(()=>{"use strict";class se{constructor(e){e?(this.alphabet="abcdefghijklmnopqrstuvwxyz",this.characters="0123456789"+this.alphabet.toUpperCase()+this.alphabet):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(n=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),n()})})})}loadModel(e){return console.time("Load model"),e?tf.loadLayersModel("content/classifier/letteranddigitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")}):tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")})}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const a=e.width>e.height,o=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),d=a?[[o,o],[0,0],[0,0]]:[[0,0],[o,o],[0,0]];return tf.tidy(()=>{let i=tf.browser.fromPixels(e,1).pad(d,255);return i=tf.image.resizeBilinear(i,[24,24]).pad([[2,2],[2,2],[0,0]],255),i=tf.scalar(1).sub(i.toFloat().div(tf.scalar(255))),i.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const n=this.preprocessImage(e),l=this._model.predict(n).as1D(),c=l.argMax().dataSync()[0],a=l.max().dataSync()[0];return[this.characters[c],a]}}function Z(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function U(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function re(t,e,n){let l=new cv.Mat;const c=new cv.Rect(e.x,e.y,n.w,n.h);return l=t.roi(c),l}function Se(t){const e=.0145*cv.arcLength(t,!0),n=new cv.Mat;let l;cv.approxPolyDP(t,n,e,!0);const c=Z(n);if(c.w>=10&&c.h>=10){const a=n.rows;if(1===a)l="LIGNE";else if(3===a)l="TRIANGLE";else if(4===a){const o=c.w/c.h;l=o>=.95&&o<=1.05?"CARRE":"RECTANGLE"}else l=void 0}return{nom:l,forme:n}}function ze(t,e){let n=U(t),l=U(e);return n.y<l.y?-1:n.y>l.y?1:n.x-l.x}function de(t,e){let n=U(t),l=U(e),c=Z(t),a=Z(e);return(l.x>=n.x&&l.x<=n.x+c.w||l.x+a.w>=n.x&&l.x+a.w<=n.x+c.w)&&(l.y>=n.y&&l.y<=n.y+c.h||l.y+a.h>=n.y&&l.y+a.h<=n.y+c.h)}function ve(t){const e=function Oe(t,e=[]){const n=new cv.Mat;cv.threshold(t,n,240,255,cv.THRESH_BINARY);let l=new cv.MatVector,c=new cv.Mat;cv.findContours(n,l,c,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const a=[];for(let i=0;i<l.size();++i){const _=Se(l.get(i));e.includes(_.nom)&&a.push(_.forme)}a.sort(ze);const o=[],d=[];return a.forEach((i,s)=>{!function Fe(t,e){let n=e[t],l=!1;return e.forEach((c,a)=>{t<a&&function Ne(t,e){return de(t,e)||de(e,t)}(n,c)&&(l=!0)}),l}(s,a)?o.push(i):d.push(i)}),d.forEach(i=>{i.delete()}),o}(t,["CARRE","RECTANGLE"]),n=[],l=[];return e.forEach(c=>{const a=Z(c),o=U(c);n.push(c),l.push(re(t,o,a))}),{cases:n,img_cases:l}}function he(t,e,n=new cv.Scalar(255,0,0,128),l=2){return e.forEach(c=>{const a=U(c),o=Z(c);let d=new cv.Point(a.x,a.y),i=new cv.Point(a.x+o.w,a.y+o.h);cv.rectangle(t,d,i,n,l,0)}),t}let oe,ce;function ge(t,e){let n=cv.matFromImageData(t.payload.image);const l=function Ve(t){return t?(void 0===oe&&(oe=new se(t)),oe):(void 0===ce&&(ce=new se(t)),ce)}(e);l.isWarmedUp.then(()=>{const c=function Ue(t,e,n,l,c){const a=function Ye(t,e,n){let s=t.clone(),_=new cv.Mat;cv.cvtColor(t,_,cv.COLOR_BGR2GRAY,0);let F=new cv.Mat;cv.threshold(_,F,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let L=new cv.Point(-1,-1);if(e){let g=new cv.Mat,B=new cv.Size(1,15),x=cv.getStructuringElement(cv.MORPH_RECT,B);cv.morphologyEx(F,g,cv.MORPH_OPEN,x,L,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let H=new cv.MatVector,v=new cv.Mat;cv.findContours(g,H,v,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let r=new cv.Scalar(255,255,255);cv.drawContours(s,H,-1,r,4);let h=new cv.Mat,u=new cv.Size(15,1),f=cv.getStructuringElement(cv.MORPH_RECT,u),P=new cv.Point(-1,-1);cv.morphologyEx(F,h,cv.MORPH_OPEN,f,P,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let M=new cv.MatVector,E=new cv.Mat;cv.findContours(h,M,E,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let A=new cv.Scalar(255,255,255);cv.drawContours(s,M,-1,A,4),g.delete(),H.delete(),v.delete(),x.delete(),h.delete(),M.delete(),E.delete(),f.delete()}let R=new cv.Size(3,3),y=cv.getStructuringElement(cv.MORPH_ELLIPSE,R),T=new cv.Mat,O=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);O.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(O,O,cv.COLOR_BGR2GRAY,0);let p=new cv.Mat;cv.cvtColor(s,p,cv.COLOR_BGR2GRAY,0);let V=new cv.Mat;cv.subtract(O,p,V,T,-1);let k=new cv.Mat;cv.dilate(V,k,y,L,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let z=new cv.Mat,I=new cv.Mat;cv.bitwise_and(k,F,z),cv.morphologyEx(z,I,cv.MORPH_CLOSE,y,L,3,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let b=new cv.Mat;cv.bitwise_and(I,F,b);let N=new cv.Mat;cv.subtract(O,b,N,T,-1);let C=new cv.MatVector,Y=new cv.Mat;cv.findContours(b,C,Y,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const W=new Map;let w=[];for(let g=0;g<C.size();g++){let B=C.get(g),x=cv.boundingRect(B);(x.width>12||x.height>12)&&w.push(x)}let D=ue(w),j=0;for(;null!==D&&j<200;)w=w.filter(g=>g!==D.toRemove1&&g!==D.toRemove2),w.push(D.u),D=ue(w),j+=1;w.forEach(g=>{let B=new cv.Scalar(0,0,0),x=new cv.Point(g.x,g.y),H=new cv.Point(g.x+g.width,g.y+g.height),v=new cv.Mat,r=new cv.Mat,h=new cv.Mat,u=new cv.Scalar(255,0,0,255);v=J(N,g),g.width>g.height?cv.copyMakeBorder(v,v,(g.width-g.height)/2,(g.width-g.height)/2,1,1,cv.BORDER_CONSTANT,u):cv.copyMakeBorder(v,v,1,1,(g.height-g.width)/2,(g.height-g.width)/2,cv.BORDER_CONSTANT,u);let f=new cv.Size(26,26);cv.resize(v,r,f,0,0,cv.INTER_AREA),cv.copyMakeBorder(r,h,1,1,1,1,cv.BORDER_CONSTANT,u),W.set(g,h),v.delete(),r.delete(),cv.rectangle(N,x,H,B,2,cv.LINE_AA,0)}),_.delete(),F.delete(),y.delete(),T.delete(),O.delete(),p.delete(),V.delete(),k.delete(),s.delete(),z.delete(),I.delete(),b.delete(),C.delete(),Y.delete();let m=[...W];if(m.sort((g,B)=>g[0].x<B[0].x?-1:1),n&&m.length>3){const g=(m[m.length-1][0].x-m[0][0].x)/m.length;let B=g,x=0,H=0,v=800;const r=[];for(let u=0;u<m.length-1;u++){let f=m[u+1][0].x-m[u][0].x;f<B&&(B=f),f>1.7*g&&r.push(u),m[u][0].y<v&&(v=m[u][0].y),m[u][0].height>x&&(x=m[u][0].height),m[u][0].width>H&&(H=m[u][0].width)}const h=(m[m.length-1][0].x-m[0][0].x)/(m.length+r.length);r.forEach(u=>{let f=m[u][0].x+h,P=new cv.Scalar(0,0,0),M=new cv.Point(f,v),E=new cv.Point(f+H,v+x),A=new cv.Rect(f,v,H,x),G=new cv.Mat,X=new cv.Mat,ee=new cv.Mat;G=J(N,A);let Q=new cv.Size(26,26);cv.resize(G,X,Q,0,0,cv.INTER_AREA);let te=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(X,ee,1,1,1,1,cv.BORDER_CONSTANT,te),W.set(A,ee),G.delete(),X.delete(),cv.rectangle(N,M,E,P,2,cv.LINE_AA,0)}),m=[...W],m.sort((u,f)=>u[0].x<f[0].x?-1:1)}return{letter:m,invert_final:N}}(t,!1,l);let o=[];e.forEach(i=>{o.push([i.padEnd(13," "),0])});const d=[];for(let i=0;i<a.letter.length;i++){let s=n.predict(K(a.letter[i][1]));c&&("1"===s[0]&&(s[0]="i"),"0"===s[0]&&(s[0]="o"),"5"===s[0]&&(s[0]="s"),"3"===s[0]&&(s[0]="b"),"9"===s[0]&&(s[0]="g")),d.push(s)}for(let i=0;i<o.length;i++){for(let s=0;s<13;s++)s<d.length&&(o[i][1]=o[i][0].substring(s,s+1).toLowerCase()===d[s][0].toLowerCase()?o[i][1]+d[s][1]:c?o[i][1]+(1-d[s][1])/35:o[i][1]+(1-d[s][1])/9);o[i][1]=o[i][1]/d.length}for(let i=0;i<o.length;i++)o[i][0]=o[i][0].trim(),o[i][1]=o[i][1]-Math.abs(o[i][0].length-d.length)/o[i][0].length;return o.sort((i,s)=>i[1]<s[1]?1:-1),{debug:a.invert_final,solution:o[0]}}(n,t.payload.match,l,!0,e);postMessage({msg:t.msg,payload:{debug:K(c.debug),solution:c.solution},uid:t.uid}),c.debug.delete(),n.delete()})}function K(t){const e=new cv.Mat,n=t.type()%8,l=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,c=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,l,c),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}function J(t,e,n){const l=t.size().width,c=t.size().height;return e.x+e.width>l&&(e.width=l-e.x),e.y+e.height>c&&(e.height=c-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function We(t,e){let n=e,l=t,c=t,a=e;t.x>e.x&&(n=t,l=e),t.y>e.y&&(c=e,a=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let o=e,d=t,i=e,s=t;return t.right>e.right&&(o=t,d=e),t.bottom>e.bottom&&(i=t,s=e),n.x<l.right&&a.y>c.y+c.height?new cv.Rect(l.x,s.y,o.right-l.x,i.bottom-c.y):n.x>l.x+l.width+5||a.y>c.y+c.height?null:new cv.Rect(l.x,s.y,o.right-l.x,i.bottom-c.y)}function ue(t){for(let e=0;e<t.length-1;e++){const n=t[e];for(let l=e+1;l<t.length;l++){const c=t[l],a=We(n,c);if(null!==a)return{u:a,toRemove1:n,toRemove2:c}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(n=>{cv=n,n.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageProcessing":return function Ie(t){const e=cv.matFromImageData(t.payload);let n=new cv.Mat;cv.cvtColor(e,n,cv.COLOR_BGR2GRAY),postMessage({msg:t.msg,payload:K(n),uid:t.uid}),e.delete(),n.delete()}(t.data);case"imageAlignement":return function Pe(t){if(t.payload.marker){const e=function De(t){let o,d,i,s,_,F,L,R,y,T,S,O,e=cv.matFromImageData(t.imageA),n=new cv.Mat,l=new cv.Mat;cv.cvtColor(e,e,cv.COLOR_RGBA2GRAY),cv.HoughCircles(e,l,cv.HOUGH_GRADIENT,1,45,75,20,6*e.cols/1e3,20*e.cols/1e3),l.cols>0&&(o=l.data32F[0],d=l.data32F[1],i=l.data32F[2],s=l.data32F[0],_=l.data32F[1],F=l.data32F[2],L=l.data32F[0],R=l.data32F[1],y=l.data32F[2],T=l.data32F[0],S=l.data32F[1],O=l.data32F[2]);const p=e.size().width,V=e.size().height;if(l.cols>0)for(let v=1;v<l.cols;v++){let r=l.data32F[3*v],h=l.data32F[3*v+1],u=l.data32F[3*v+2];r*r+h*h<=o*o+d*d&&(o=r,d=h,i=u),r*r+h*h>=T*T+S*S&&(T=r,S=h,O=u),(p-r)*(p-r)+h*h<=(p-s)*(p-s)+_*_&&(s=r,_=h,F=u),r*r+(V-h)*(V-h)<=L*L+(V-R)*(V-R)&&(L=r,R=h,y=u)}let k=cv.matFromImageData(t.imageB),z=new cv.Mat,I=new cv.Mat;cv.cvtColor(k,z,cv.COLOR_RGBA2GRAY);const b=z.size().width,N=z.size().height;cv.HoughCircles(z,I,cv.HOUGH_GRADIENT,1,45,75,15,y-3,y+3);let C=[],Y=[];const W=180*(4*y*y-3.14159*y*y)/100;for(let v=0;v<I.cols;v++){let r=I.data32F[3*v],h=I.data32F[3*v+1];const u=r-y,f=h-y;let P=2*y,M=2*y;u+P>b&&(P=b-u),f+M>N&&(M=N-f);let E=new cv.Rect(r-y,h-y,P,M),A=new cv.Mat;A=J(z,E),cv.threshold(A,A,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(A)<W&&(C.push(r),Y.push(h)),A.delete()}let w,D,j,m,g,B,x,H;if(C.length>0&&(w=C[0],D=Y[1],j=C[0],m=Y[1],g=C[0],B=Y[1],x=C[0],H=Y[1]),C.length>1)for(let v=0;v<C.length;v++){let r=C[v],h=Y[v];r*r+h*h<=w*w+D*D&&(w=r,D=h),r*r+h*h>=x*x+H*H&&(x=r,H=h),(b-r)*(b-r)+h*h<=(b-j)*(b-j)+m*m&&(j=r,m=h),r*r+(N-h)*(N-h)<=g*g+(N-B)*(N-B)&&(g=r,B=h)}if(C.length>=4){let v=cv.matFromArray(4,1,cv.CV_32FC2,[o,d,s,_,L,R,T,S]),r=cv.matFromArray(4,1,cv.CV_32FC2,[w,D,j,m,g,B,x,H]),h=cv.findHomography(r,v,cv.RANSAC),u=new cv.Size(e.cols,e.rows);if(h.empty())return void console.log("homography matrix empty!");cv.warpPerspective(k,n,h,u);let f=n.clone();for(let M=0;M<r.rows;++M){let G=15,X=new cv.Point(r.data32F[2*M],r.data32F[2*M+1]);cv.circle(k,X,G,[0,0,255,255],1)}for(let M=0;M<v.rows;++M){let G=15,X=new cv.Point(v.data32F[2*M],v.data32F[2*M+1]);cv.circle(e,X,G,[0,0,255,255],1),cv.circle(f,X,G,[0,0,255,255],1)}let P={};return P.imageAligned=K(f),P.imageAlignedWidth=f.size().width,P.imageAlignedHeight=f.size().height,e.delete(),n.delete(),l.delete(),z.delete(),k.delete(),I.delete(),v.delete(),r.delete(),f.delete(),P}{let v=new cv.KeyPointVector,r=new cv.KeyPointVector,h=new cv.Mat,u=new cv.Mat,f=new cv.AKAZE,P=new cv.Mat,M=new cv.Mat;f.detectAndCompute(z,P,v,h),f.detectAndCompute(e,M,r,u);let E=new cv.DMatchVector,A=new cv.BFMatcher,G=new cv.DMatchVectorVector;A.knnMatch(h,u,G,2);for(let q=0;q<G.size();++q){let we=G.get(q),ye=we.get(0),je=we.get(1);ye.distance<=je.distance*parseFloat("0.7")&&E.push_back(ye)}let X=new cv.Mat,ee=new cv.Scalar(0,255,0,255);cv.drawMatches(k,v,e,r,E,X,ee);let Q={},te=new cv.Mat,me=new cv.Mat,fe=new cv.Scalar(0,255,0,255);cv.drawKeypoints(z,v,te,fe),cv.drawKeypoints(e,r,me,fe);let ne=[],le=[];for(let q=0;q<E.size();q++)ne.push(v.get(E.get(q).queryIdx).pt.x),ne.push(v.get(E.get(q).queryIdx).pt.y),le.push(r.get(E.get(q).trainIdx).pt.x),le.push(r.get(E.get(q).trainIdx).pt.y);let ie=new cv.Mat(ne.length,1,cv.CV_32FC2);ie.data32F.set(ne);let ae=new cv.Mat(le.length,1,cv.CV_32FC2);ae.data32F.set(le);let pe=cv.findHomography(ie,ae,cv.RANSAC);if(pe.empty())return void console.log("homography matrix empty!");let $=new cv.Mat;return cv.warpPerspective(z,$,pe,e.size()),Q.imageAligned=K($),Q.imageAlignedWidth=$.size().width,Q.imageAlignedHeight=$.size().height,$.delete(),ie.delete(),ae.delete(),te.delete(),me.delete(),X.delete(),G.delete(),A.delete(),E.delete(),f.delete(),v.delete(),r.delete(),h.delete(),u.delete(),P.delete(),M.delete(),e.delete(),n.delete(),l.delete(),z.delete(),k.delete(),I.delete(),Q}}(t.payload);postMessage({msg:t.msg,payload:e,uid:t.uid})}else{const e=function Ge(t,e){let n=cv.matFromImageData(t),l=cv.matFromImageData(e),c=new cv.Mat,a=new cv.Mat;cv.cvtColor(l,c,cv.COLOR_BGRA2GRAY),cv.cvtColor(n,a,cv.COLOR_BGRA2GRAY);let o=new cv.KeyPointVector,d=new cv.KeyPointVector,i=new cv.Mat,s=new cv.Mat,_=new cv.AKAZE,F=new cv.Mat,L=new cv.Mat;_.detectAndCompute(c,F,o,i),_.detectAndCompute(a,L,d,s);let R=new cv.DMatchVector,y=new cv.BFMatcher,T=new cv.DMatchVectorVector;y.knnMatch(i,s,T,2);for(let w=0;w<T.size();++w){let D=T.get(w),j=D.get(0),m=D.get(1);j.distance<=m.distance*parseFloat("0.7")&&R.push_back(j)}let S=new cv.Mat,O=new cv.Scalar(0,255,0,255);cv.drawMatches(l,o,n,d,R,S,O);let p={};p.imageCompareMatches=K(S),p.imageCompareMatchesWidth=S.size().width,p.imageCompareMatchesHeight=S.size().height;let V=new cv.Mat,k=new cv.Mat,z=new cv.Scalar(0,255,0,255);cv.drawKeypoints(c,o,V,z),cv.drawKeypoints(a,d,k,z),p.keypoints1=K(V),p.keypoints1Width=V.size().width,p.keypoints1Height=V.size().height,p.keypoints2=K(k),p.keypoints2Width=k.size().width,p.keypoints2Height=k.size().height;let I=[],b=[];for(let w=0;w<R.size();w++)I.push(o.get(R.get(w).queryIdx).pt.x),I.push(o.get(R.get(w).queryIdx).pt.y),b.push(d.get(R.get(w).trainIdx).pt.x),b.push(d.get(R.get(w).trainIdx).pt.y);let N=new cv.Mat(I.length,1,cv.CV_32FC2);N.data32F.set(I);let C=new cv.Mat(b.length,1,cv.CV_32FC2);C.data32F.set(b);let Y=cv.findHomography(N,C,cv.RANSAC);if(Y.empty())return void console.log("homography matrix empty!");console.log("h:",Y);let W=new cv.Mat;return cv.warpPerspective(l,W,Y,n.size()),p.imageAligned=K(W),p.imageAlignedWidth=W.size().width,p.imageAlignedHeight=W.size().height,W.delete(),N.delete(),C.delete(),V.delete(),k.delete(),S.delete(),T.delete(),y.delete(),R.delete(),_.delete(),c.delete(),o.delete(),a.delete(),d.delete(),i.delete(),s.delete(),F.delete(),L.delete(),p}(t.payload.imageA,t.payload.imageB);postMessage({msg:t.msg,payload:e,uid:t.uid})}}(t.data);case"imageCrop":return function Le(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),n=new cv.Mat,l=cv.matFromImageData(t.payload.image);n=J(l,e),postMessage({msg:t.msg,payload:K(n),uid:t.uid}),n.delete(),l.delete()}(t.data);case"nameprediction":return ge(t.data,!0);case"ineprediction":return ge(t.data,!1);case"qcmresolution":return function Me(t){var e;const n={solutions:[]};let l=cv.matFromImageData(t.payload.imageTemplate),c=new cv.Mat;cv.cvtColor(l,c,cv.COLOR_RGBA2GRAY,0);const a=ve(c);null===(e=t.payload.pages)||void 0===e||e.forEach((o,d)=>{var i;let s=new cv.Mat,_=cv.matFromImageData(o.imageInput);cv.cvtColor(_,s,cv.COLOR_RGBA2GRAY,0);const F=ve(s),L=function ke(t,e){const n=[];return t.cases.forEach(l=>{let a,c=500;if(e.cases.forEach(o=>{const d=function Be(t,e){const n=cv.boundingRect(t),l=cv.boundingRect(e);let c=n.x+n.width/2,a=n.y+n.height/2,o=l.x+l.width/2,d=l.y+l.height/2;return Math.sqrt((c-o)*(c-o)+(a-d)*(a-d))}(l,o);c>d&&d<25&&(c=d,a=o)}),void 0!==a){let o=U(l),d=U(a);n.push({x:o.x-d.x,y:o.y-d.y})}}),function Ae(t){if(t.length>0){let e=0,n=0;return t.forEach(l=>{e+=l.x,n+=l.y}),{x:e/t.length,y:n/t.length}}return{x:0,y:0}}(n)}(F,a),R=function be(t,e){let n=new cv.Mat;if(0!==e.x||0!==e.y){let l=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),c=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,n,l,c,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),n}return t}(_,L);let y=function Te(t,e,n){const l=[],c=[];let a=new Map;return t.cases.forEach((o,d)=>{const i=re(n,U(o),Z(o)),s=function He(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let n=new cv.Mat;return cv.threshold(e,n,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(n)/(t.rows*t.cols)}(i);s>.25?(a.set(d,{verdict:!0,prediction:s}),l.push(o)):(a.set(d,{verdict:!1,prediction:s}),c.push(o)),s>.16&&s<.25?cv.putText(n,""+s.toFixed(2),{x:U(o).x,y:U(o).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(n,""+s.toFixed(2),{x:U(o).x,y:U(o).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),i.delete()}),he(n,l,new cv.Scalar(0,255,0,128)),he(n,c,new cv.Scalar(0,0,255,128)),a}(a,0,R),T=function _e(t){const e=new cv.Mat,n=t.type()%8,l=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,c=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,l,c),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const a=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),a}(R),S=[];y.forEach((O,p)=>{O.verdict&&S.push(String.fromCharCode(97+p))}),null===(i=n.solutions)||void 0===i||i.push({imageSolution:T,numero:d,solution:S.join("&")}),s.delete(),_.delete(),R!==_&&R.delete(),F.cases.forEach(O=>O.delete()),F.img_cases.forEach(O=>O.delete())}),l.delete(),c.delete(),a.cases.forEach(o=>o.delete()),a.img_cases.forEach(o=>o.delete()),postMessage({msg:t.msg,payload:n,uid:t.uid})}(t.data)}})})();