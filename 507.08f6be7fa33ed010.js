(()=>{"use strict";var l,xe={4681:(l,C,a)=>{var V=a(4942),_=a(5e3),b=a(2076),m=a(4968),Q=a(4004),M=a(9300),X=a(971),N=a(4351),c=a(4469);var Re=a(9751);!function se(Y){const e=new Y,t=(0,m.R)(self,"message");return function de(Y,e){const t=e.pipe((0,Q.U)(r=>r.data),(0,Q.U)(r=>new _.P_(r.kind,r.value,r.error)),(0,M.h)(r=>"C"!==r.kind),(0,X.D)());return function _e(Y){return!!Y.workUnit}(Y)?t.pipe((0,N.b)(r=>(0,b.D)(Y.workUnit(r)).pipe((0,c.i)()))):Y.work(t).pipe((0,c.i)())}(e,t).subscribe(r=>{const p=postMessage;(function x(Y){return!!Y.selectTransferables})(e)&&r.hasValue?p(r,e.selectTransferables(r.value)):p(r)})}(class Fe{constructor(){(0,V.Z)(this,"opencvready",new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(r=>{cv=r,cv.ready.then(()=>{e()}).catch(p=>{console.log(p)})})}},t.importScripts(t.Module.scriptUrl)}))}workUnit(e){return new Re.y(t=>{this.opencvready.then(()=>{if(console.error("start worker"),e.marker){const r=this.alignImageBasedOnCircle(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,e.pageNumber,e.preference);r.pageNumber=e.pageNumber,t.next(r),t.complete()}else try{const r=this.alignImage(e.imageA,e.imageB,e.widthA,e.heightA,e.widthB,e.heightB,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.pageNumber);e.imageA=void 0,e.imageB=void 0,r.pageNumber=e.pageNumber,t.next(r),t.complete()}catch(r){console.error(r)}}).catch(r=>{console.log(r)})})}selectTransferables(e){return[e.imageAligned,e.imagesDebugTraces]}imageDataFromMat(e){const t=new cv.Mat,r=e.type()%8,p=r<=cv.CV_8S?1:r<=cv.CV_32S?1/256:255,u=r===cv.CV_8S||r===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,p,u),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const $=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),$}roi(e,t){const r=e.size().width,p=e.size().height;return t.x+t.width>r&&(t.width=r-t.x),t.y+t.height>p&&(t.height=p-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,r,p,u,$,G,B,te,W){const H=new ImageData(new Uint8ClampedArray(e),r,p),g=new ImageData(new Uint8ClampedArray(t),u,$),R=cv.matFromImageData(H);let v=cv.matFromImageData(g),z=new cv.Mat,J=new cv.Size(R.size().width,R.size().height);cv.resize(v,z,J,0,0,cv.INTER_AREA);let A=new cv.Mat,E=new cv.Mat;cv.cvtColor(z,A,cv.COLOR_BGRA2GRAY),cv.cvtColor(R,E,cv.COLOR_BGRA2GRAY);const k=Math.trunc(R.size().width/20);let S=[],F=[],n={},o=!1,j=!1,D=!1,I=!1;const T=Math.min(A.size().width,E.size().width),K=Math.min(A.size().height,E.size().height);if(G){let s=new cv.Rect(0,0,T,K);o=this.matchSmallImage(A,E,S,F,s,1,B,te,W),j=!0,D=!0,I=!0}else{let s=k;for(;!o&&s<3*T/4&&s<2*K/3;){let w=new cv.Rect(0,0,s,s);o=this.matchSmallImage(A,E,S,F,w,1,B,te,W),o||(s+=Math.trunc(T/10))}for(s=k;!j&&s<3*T/4&&s<2*K/3;){let w=new cv.Rect(T-s,0,T,s);j=this.matchSmallImage(A,E,S,F,w,2,B,te,W),j||(s+=Math.trunc(T/10))}for(s=k;!D&&s<3*T/4&&s<2*K/3;){let w=new cv.Rect(0,K-s,s,K);D=this.matchSmallImage(A,E,S,F,w,3,B,te,W),D||(s+=Math.trunc(T/10))}for(s=k;!I&&s<3*T/4&&s<2*K/3;){let w=new cv.Rect(T-s,K-s,T,K);I=this.matchSmallImage(A,E,S,F,w,4,B,te,W),I||(s+=Math.trunc(T/10))}}if(o&&j&&D&&I){let s=cv.matFromArray(S.length/2,1,cv.CV_32FC2,S),w=cv.matFromArray(F.length/2,1,cv.CV_32FC2,F),i=cv.findHomography(s,w,cv.RANSAC),P=new cv.MatVector;P.push_back(R),P.push_back(z);let Z=new cv.Mat;cv.hconcat(P,Z);const d=F.length/2;for(let q=0;q<d;q++){let le={x:F[2*q],y:F[2*q+1]},ee={x:R.size().width+S[2*q],y:S[2*q+1]};cv.circle(Z,le,5,[0,255,0,255],1),cv.circle(Z,ee,5,[0,255,0,255],1),cv.line(Z,le,ee,[0,255,0,255],1)}let O=new cv.Mat;cv.warpPerspective(z,O,i,R.size()),n.imageAligned=this.imageDataFromMat(O).data.buffer,n.imageAlignedWidth=O.size().width,n.imageAlignedHeight=O.size().height,n.imagesDebugTraces=this.imageDataFromMat(Z).data.buffer,n.imagesDebugTracesWidth=Z.size().width,n.imagesDebugTracesHeight=Z.size().height,s.delete(),w.delete(),i.delete(),O.delete(),console.log("Good match for page "+W)}else{n.imageAligned=t.slice(0),n.imageAlignedWidth=u,n.imageAlignedHeight=$;let s=new cv.MatVector;s.push_back(R),s.push_back(z);let w=new cv.Mat;cv.hconcat(s,w),n.imagesDebugTraces=this.imageDataFromMat(w).data.buffer,n.imagesDebugTracesWidth=w.size().width,n.imagesDebugTracesHeight=w.size().height,console.log("no match for page "+W)}return v.delete(),z.delete(),R.delete(),A.delete(),E.delete(),n}matchSmallImage(e,t,r,p,u,$,G,B,te){let W=new cv.Mat;W=this.roi(e,u);let H=new cv.Mat;H=this.roi(t,u);let g=new cv.KeyPointVector,R=new cv.KeyPointVector,v=new cv.Mat,z=new cv.Mat,J=new cv.AKAZE,A=new cv.Mat,E=new cv.Mat;J.detectAndCompute(W,A,g,v),J.detectAndCompute(H,E,R,z);let k=new cv.DMatchVector,S=new cv.BFMatcher,F=new cv.DMatchVectorVector;S.knnMatch(v,z,F,2);for(let i=0;i<F.size();++i){let P=F.get(i),Z=P.get(0),d=P.get(1);void 0!==Z&&void 0!==d&&Z.distance<=d.distance*parseFloat("0.7")&&k.push_back(Z)}let n=[],o=[];for(let i=0;i<k.size();i++)n.push(g.get(k.get(i).queryIdx).pt.x+u.x),n.push(g.get(k.get(i).queryIdx).pt.y+u.y),o.push(R.get(k.get(i).trainIdx).pt.x+u.x),o.push(R.get(k.get(i).trainIdx).pt.y+u.y);let j=0,D=[];if(0===k.size())return J.delete(),g.delete(),R.delete(),v.delete(),z.delete(),A.delete(),E.delete(),W.delete(),H.delete(),F.delete(),k.delete(),S.delete(),!1;const I=[];for(let i=0;i<k.size();i++){let P=(n[2*i]-o[2*i])*(n[2*i]-o[2*i])+(n[2*i+1]-o[2*i+1])*(n[2*i+1]-o[2*i+1]);P<Math.trunc(3*W.size().width/20)*Math.trunc(3*W.size().height/20)&&(D.push(P),j+=1,I.push(i))}const T=this.numAverage(D);let K=this.dev(D);if(K<1&&(K=1),j<=G)return J.delete(),g.delete(),R.delete(),v.delete(),z.delete(),A.delete(),E.delete(),W.delete(),H.delete(),F.delete(),k.delete(),S.delete(),!1;let s=0,w=[];for(let i=0;i<I.length;i++){let P=(n[2*I[i]]-o[2*I[i]])*(n[2*I[i]]-o[2*I[i]])+(n[2*I[i]+1]-o[2*I[i]+1])*(n[2*I[i]+1]-o[2*I[i]+1]);P<=T+1*K&&P>=T-1*K&&(s+=1,w.push(I[i]))}if(console.error("first realgoodmatchtokeep",s,B),s<=B)return J.delete(),g.delete(),R.delete(),v.delete(),z.delete(),A.delete(),E.delete(),W.delete(),H.delete(),F.delete(),k.delete(),S.delete(),!1;{let i=[];const P=[];w.forEach(d=>{P.push((n[2*d]-o[2*d])*(n[2*d]-o[2*d])+(n[2*d+1]-o[2*d+1])*(n[2*d+1]-o[2*d+1]))});const Z=this.numAverage(P);return w.sort((d,O)=>Math.abs((n[2*d]-o[2*d])*(n[2*d]-o[2*d])+(n[2*d+1]-o[2*d+1])*(n[2*d+1]-o[2*d+1])-Z)-Math.abs((n[2*O]-o[2*O])*(n[2*O]-o[2*O])+(n[2*O+1]-o[2*O+1]*(n[2*O+1]-o[2*O+1]))-Z)),i.push(w[0]),i.push(w[1]),i.push(w[2]),i.push(w[3]),i.push(w[4]),console.error("last realgoodmatchtokeep",i.length,B),i.forEach(d=>{r.push(g.get(k.get(+d).queryIdx).pt.x+u.x),r.push(g.get(k.get(+d).queryIdx).pt.y+u.y),p.push(R.get(k.get(+d).trainIdx).pt.x+u.x),p.push(R.get(k.get(+d).trainIdx).pt.y+u.y)}),J.delete(),g.delete(),R.delete(),v.delete(),z.delete(),A.delete(),E.delete(),W.delete(),H.delete(),F.delete(),k.delete(),S.delete(),!0}}numAverage(e){return e.reduce((t,r)=>t+r,0)/e.length}dev(e){let t=e.reduce((p,u)=>p+u,0)/e.length,r=(e=e.map(p=>(p-t)**2)).reduce((p,u)=>p+u,0);return Math.sqrt(r/e.length)}alignImageBasedOnCircle(e,t,r,p,u,$,G,B){const te=new ImageData(new Uint8ClampedArray(e),r,p),W=new ImageData(new Uint8ClampedArray(t),u,$);let A,E,k,S,F,n,o,j,D,I,T,K,H=cv.matFromImageData(te),g=new cv.Mat,R=new cv.Mat,v=new cv.Mat;cv.cvtColor(H,g,cv.COLOR_RGBA2GRAY),cv.HoughCircles(g,v,cv.HOUGH_GRADIENT,1,45,75,20,g.cols*B.minCircle/1e3,g.cols*B.maxCircle/1e3),v.cols>0&&(A=v.data32F[0],E=v.data32F[1],k=v.data32F[2],S=v.data32F[0],F=v.data32F[1],n=v.data32F[2],o=v.data32F[0],j=v.data32F[1],D=v.data32F[2],I=v.data32F[0],T=v.data32F[1],K=v.data32F[2]);const s=g.size().width,w=g.size().height;if(v.cols>0)for(let L=1;L<v.cols;L++){let f=v.data32F[3*L],y=v.data32F[3*L+1],ne=v.data32F[3*L+2];f*f+y*y<=A*A+E*E&&(A=f,E=y,k=ne),f*f+y*y>=I*I+T*T&&(I=f,T=y,K=ne),(s-f)*(s-f)+y*y<=(s-S)*(s-S)+F*F&&(S=f,F=y,n=ne),f*f+(w-y)*(w-y)<=o*o+(w-j)*(w-j)&&(o=f,j=y,D=ne)}let i=cv.matFromImageData(W),P=new cv.Mat,Z=new cv.Size(g.size().width,g.size().height);cv.resize(i,P,Z,0,0,cv.INTER_AREA);let d=new cv.Mat,O=new cv.Mat;cv.cvtColor(P,d,cv.COLOR_RGBA2GRAY);const q=d.size().width,le=d.size().height;cv.HoughCircles(d,O,cv.HOUGH_GRADIENT,1,45,75,15,D-3,D+3);let ee=[],he=[];const Oe=180*(4*D*D-3.14159*D*D)/100;for(let L=0;L<O.cols;L++){let f=O.data32F[3*L],y=O.data32F[3*L+1];const ne=f-D,ce=y-D;let re=2*D,oe=2*D;ne+re>q&&(re=q-ne),ce+oe>le&&(oe=le-ce);let Ce=new cv.Rect(f-D,y-D,re,oe),U=new cv.Mat;U=this.roi(d,Ce),cv.threshold(U,U,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(U)<Oe&&(ee.push(f),he.push(y)),U.delete()}let ue,fe,me,ge,ve,pe,ye,we;if(ee.length>0&&(ue=ee[0],fe=he[0],me=ee[0],ge=he[0],ve=ee[0],pe=he[0],ye=ee[0],we=he[0]),ee.length>1)for(let L=0;L<ee.length;L++){let f=ee[L],y=he[L];f*f+y*y<=ue*ue+fe*fe&&(ue=f,fe=y),f*f+y*y>=ye*ye+we*we&&(ye=f,we=y),(q-f)*(q-f)+y*y<=(q-me)*(q-me)+ge*ge&&(me=f,ge=y),f*f+(le-y)*(le-y)<=ve*ve+(le-pe)*(le-pe)&&(ve=f,pe=y)}if(ee.length>=4){let L=cv.matFromArray(4,1,cv.CV_32FC2,[A,E,S,F,o,j,I,T]),f=cv.matFromArray(4,1,cv.CV_32FC2,[ue,fe,me,ge,ve,pe,ye,we]),y=cv.getPerspectiveTransform(f,L),ne=new cv.Size(g.cols,g.rows);for(let Ae=0;Ae<L.rows;++Ae){let Ie=15,Pe=new cv.Point(f.data32F[2*Ae],f.data32F[2*Ae+1]);cv.circle(P,Pe,Ie,[0,0,255,255],1)}cv.warpPerspective(P,R,y,ne,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let ce=R.clone(),re={};re.imageAligned=this.imageDataFromMat(ce).data.buffer,re.imageAlignedWidth=ce.size().width,re.imageAlignedHeight=ce.size().height;let oe=new cv.MatVector;oe.push_back(H),oe.push_back(P),console.error(g.size()),console.error(P.size());let Ce=new cv.Size(2*H.size().width,g.size().height),U=new cv.Mat(Ce,H.type());cv.hconcat(oe,U);let ie={x:A,y:E},ae={x:g.size().width+ue,y:fe};return cv.circle(U,ie,15,[0,255,0,255],1),cv.circle(U,ae,15,[0,255,0,255],1),cv.line(U,ie,ae,[0,255,0,255],1),ie={x:S,y:F},ae={x:g.size().width+me,y:ge},cv.circle(U,ie,15,[0,255,0,255],1),cv.circle(U,ae,15,[0,255,0,255],1),cv.line(U,ie,ae,[0,255,0,255],1),ie={x:o,y:j},ae={x:g.size().width+ve,y:pe},cv.circle(U,ie,15,[0,255,0,255],1),cv.circle(U,ae,15,[0,255,0,255],1),cv.line(U,ie,ae,[0,255,0,255],1),ie={x:I,y:T},ae={x:g.size().width+ye,y:we},cv.circle(U,ie,15,[0,255,0,255],1),cv.circle(U,ae,15,[0,255,0,255],1),cv.line(U,ie,ae,[0,255,0,255],1),re.imagesDebugTraces=this.imageDataFromMat(U).data.buffer,re.imagesDebugTracesWidth=U.size().width,re.imagesDebugTracesHeight=U.size().height,H.delete(),g.delete(),R.delete(),v.delete(),d.delete(),P.delete(),i.delete(),O.delete(),L.delete(),f.delete(),ce.delete(),console.error("find circle"),re}return H.delete(),g.delete(),R.delete(),v.delete(),d.delete(),P.delete(),i.delete(),O.delete(),console.error("cannot find circle"),this.alignImage(e,t,r,p,u,$,!1,B.numberofpointToMatch,B.numberofgoodpointToMatch,G)}})},6921:(l,C,a)=>{a.d(C,{Nn:()=>M,w0:()=>m});var V=a(576),_=a(7896),b=a(8737);class m{constructor(c){this.initialTeardown=c,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let c;if(!this.closed){this.closed=!0;const{_parentage:x}=this;if(x)if(this._parentage=null,Array.isArray(x))for(const se of x)se.remove(this);else x.remove(this);const{initialTeardown:_e}=this;if((0,V.m)(_e))try{_e()}catch(se){c=se instanceof _.B?se.errors:[se]}const{_finalizers:de}=this;if(de){this._finalizers=null;for(const se of de)try{X(se)}catch(Me){c=c??[],Me instanceof _.B?c=[...c,...Me.errors]:c.push(Me)}}if(c)throw new _.B(c)}}add(c){var x;if(c&&c!==this)if(this.closed)X(c);else{if(c instanceof m){if(c.closed||c._hasParent(this))return;c._addParent(this)}(this._finalizers=null!==(x=this._finalizers)&&void 0!==x?x:[]).push(c)}}_hasParent(c){const{_parentage:x}=this;return x===c||Array.isArray(x)&&x.includes(c)}_addParent(c){const{_parentage:x}=this;this._parentage=Array.isArray(x)?(x.push(c),x):x?[x,c]:c}_removeParent(c){const{_parentage:x}=this;x===c?this._parentage=null:Array.isArray(x)&&(0,b.P)(x,c)}remove(c){const{_finalizers:x}=this;x&&(0,b.P)(x,c),c instanceof m&&c._removeParent(this)}}function M(N){return N instanceof m||N&&"closed"in N&&(0,V.m)(N.remove)&&(0,V.m)(N.add)&&(0,V.m)(N.unsubscribe)}function X(N){(0,V.m)(N)?N():N.unsubscribe()}m.EMPTY=(()=>{const N=new m;return N.closed=!0,N})()},3269:(l,C,a)=>{a.d(C,{yG:()=>m});var V=a(3532);function m(M){return(0,V.K)(function _(M){return M[M.length-1]}(M))?M.pop():void 0}},4482:(l,C,a)=>{a.d(C,{e:()=>b});var V=a(576);function b(m){return Q=>{if(function _(m){return(0,V.m)(m?.lift)}(Q))return Q.lift(function(M){try{return m(M,this)}catch(X){this.error(X)}});throw new TypeError("Unable to lift unknown Observable type")}}},9635:(l,C,a)=>{a.d(C,{U:()=>b});var V=a(4671);function b(m){return 0===m.length?V.y:1===m.length?m[0]:function(M){return m.reduce((X,N)=>N(X),M)}}}},ze={};function h(l){var C=ze[l];if(void 0!==C)return C.exports;var a=ze[l]={exports:{}};return xe[l](a,a.exports,h),a.exports}h.m=xe,h.x=()=>{var l=h.O(void 0,[696],()=>h(4681));return h.O(l)},l=[],h.O=(C,a,V,_)=>{if(!a){var m=1/0;for(b=0;b<l.length;b++){for(var[a,V,_]=l[b],Q=!0,M=0;M<a.length;M++)(!1&_||m>=_)&&Object.keys(h.O).every(de=>h.O[de](a[M]))?a.splice(M--,1):(Q=!1,_<m&&(m=_));if(Q){l.splice(b--,1);var X=V();void 0!==X&&(C=X)}}return C}_=_||0;for(var b=l.length;b>0&&l[b-1][2]>_;b--)l[b]=l[b-1];l[b]=[a,V,_]},h.d=(l,C)=>{for(var a in C)h.o(C,a)&&!h.o(l,a)&&Object.defineProperty(l,a,{enumerable:!0,get:C[a]})},h.f={},h.e=l=>Promise.all(Object.keys(h.f).reduce((C,a)=>(h.f[a](l,C),C),[])),h.u=l=>l+".9359b519a07dd466.js",h.miniCssF=l=>{},h.o=(l,C)=>Object.prototype.hasOwnProperty.call(l,C),(()=>{var l;h.tt=()=>(void 0===l&&(l={createScriptURL:C=>C},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(l=trustedTypes.createPolicy("angular#bundler",l))),l)})(),h.tu=l=>h.tt().createScriptURL(l),h.p="",(()=>{var l={507:1};h.f.i=(_,b)=>{l[_]||importScripts(h.tu(h.p+h.u(_)))};var a=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],V=a.push.bind(a);a.push=_=>{var[b,m,Q]=_;for(var M in m)h.o(m,M)&&(h.m[M]=m[M]);for(Q&&Q(h);b.length;)l[b.pop()]=1;V(_)}})(),(()=>{var l=h.x;h.x=()=>h.e(696).then(l)})(),h.x()})();