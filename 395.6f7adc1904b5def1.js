(()=>{"use strict";class te{constructor(e){e?(this.alphabet=" abcdefghijklmnopqrstuvwxyz",this.characters=this.alphabet.toUpperCase()):this.characters="0123456789",this.isWarmedUp=this.initModel(e)}initModel(e){return new Promise(n=>{tf.setBackend("wasm").then(()=>{this.loadModel(e).then().then(()=>{console.info("Backend running on:",tf.getBackend()),n()})})})}loadModel(e){return console.time("Load model"),e?(console.log("load letter"),tf.loadLayersModel("content/classifier/letterclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")})):(console.log("load digit"),tf.loadLayersModel("content/classifier/digitclassifier/model.json").then(n=>{this._model=n,console.timeEnd("Load model")}))}warmUp(){console.time("Warmup"),this._model.predict(tf.randomNormal([1,28,28,1])).as1D().dataSync(),console.timeEnd("Warmup")}preprocessImage(e){const i=e.width>e.height,a=Math.round((Math.max(e.width,e.height)-Math.min(e.width,e.height))/2),c=i?[[a,a],[0,0],[0,0]]:[[0,0],[a,a],[0,0]];return tf.tidy(()=>{let h=tf.browser.fromPixels(e,1).pad(c,255);return h=tf.image.resizeBilinear(h,[24,24]).pad([[2,2],[2,2],[0,0]],255),h=tf.scalar(1).sub(h.toFloat().div(tf.scalar(255))),h.expandDims(0)})}predict(e){if(!this._model)return console.warn("Model not loaded yet!");const n=this.preprocessImage(e),o=this._model.predict(n).as1D(),l=o.argMax().dataSync()[0],i=o.max().dataSync()[0];return[this.characters[l],i]}}function N(t){const e=cv.boundingRect(t);return{w:e.width,h:e.height}}function _(t){const e=cv.boundingRect(t);return{x:e.x,y:e.y}}function ue(t,e){const n=e.qcm_epsilon*cv.arcLength(t,!0),o=new cv.Mat;let l;cv.approxPolyDP(t,o,n,!0);const i=N(o);if(i.w>=e.qcm_min_width_shape&&i.h>=e.qcm_min_height_shape){const a=o.rows;if(1===a)l="LIGNE";else if(3===a)l="TRIANGLE";else if(4===a){const c=i.w/i.h;l=c>=.95&&c<=1.05?"CARRE":"RECTANGLE"}else l=void 0}return{nom:l,forme:o}}function ge(t,e){let n=_(t),o=_(e);return n.y<o.y?-1:n.y>o.y?1:n.x-o.x}function me(t,e){let n=_(t),o=_(e);return n.x-o.x}function ne(t,e){let n=_(t),o=_(e),l=N(t),i=N(e);return(o.x>=n.x&&o.x<=n.x+l.w||o.x+i.w>=n.x&&o.x+i.w<=n.x+l.w)&&(o.y>=n.y&&o.y<=n.y+l.h||o.y+i.h>=n.y&&o.y+i.h<=n.y+l.h)}function q(t,e){const n=function fe(t,e=[],n){const o=new cv.Mat;cv.threshold(t,o,245,255,cv.THRESH_BINARY);let l=new cv.MatVector,i=new cv.Mat;cv.findContours(o,l,i,cv.RETR_TREE,cv.CHAIN_APPROX_NONE);const a=[];for(let r=0;r<l.size();++r){const m=ue(l.get(r),n);e.includes(m.nom)&&a.push(m.forme)}a.sort(ge);const c=[],h=[];return a.forEach((r,d)=>{!function pe(t,e){let n=e[t],o=!1;return e.forEach((l,i)=>{t<i&&function we(t,e){return ne(t,e)||ne(e,t)}(n,l)&&(o=!0)}),o}(d,a)?c.push(r):h.push(r)}),h.forEach(r=>{r.delete()}),c}(t,["CARRE","RECTANGLE"],e),o=[],l=[];return n.forEach(i=>{const a=N(i),c=_(i);o.push(i),l.push(W(t,c,a))}),{cases:o,img_cases:l}}function W(t,e,n){let o=new cv.Mat;const l=new cv.Rect(e.x,e.y,n.w,n.h);return o=t.roi(l),o}function oe(t,e,n=new cv.Scalar(255,0,0,128),o=2){return e.forEach(l=>{const i=_(l),a=N(l);let c=new cv.Point(i.x,i.y),h=new cv.Point(i.x+a.w,i.y+a.h);cv.rectangle(t,c,h,n,o,0)}),t}function Ee(t){let e=new cv.Mat;cv.adaptiveThreshold(t,e,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY_INV,3,2);let l,n=new cv.MatVector,o=new cv.Mat;cv.findContours(e,n,o,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE);for(let i=0;i<n.size();++i){let a=n.get(i),c=cv.boundingRect(a);c.width>1&&c.height>1&&(void 0!==l&&(l.width>c.width||l.height>c.height)||(l=c))}if(void 0!==l){let i=new cv.Mat;i=e.roi(l);let a=cv.countNonZero(i)/(l.width*l.height);return i.delete(),e.delete(),a}return e.delete(),0}let Z,Q;function ce(t){return t?(void 0===Z&&(Z=new te(t)),Z):(void 0===Q&&(Q=new te(t)),Q)}function le(t,e){let n=cv.matFromImageData(t.payload.image);const o=ce(e);o.isWarmedUp.then(()=>{const l=function Ae(t,e,n,o,l,i){const a=function Oe(t,e,n,o){const l=o.linelength,i=o.repairsize,a=o.dilatesize,c=o.morphsize,h=o.drawcontoursizeh,r=o.drawcontoursizev;let d=t.clone(),m=new cv.Mat;cv.cvtColor(t,m,cv.COLOR_BGR2GRAY,0);let R=new cv.Mat;cv.threshold(m,R,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU);let O=new cv.Point(-1,-1);if(e){let v=new cv.Mat,E=new cv.Size(1,l),C=cv.getStructuringElement(cv.MORPH_RECT,E);cv.morphologyEx(R,v,cv.MORPH_OPEN,C,O,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let x=new cv.MatVector,p=new cv.Mat;cv.findContours(v,x,p,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let A=new cv.Scalar(255,255,255);cv.drawContours(d,x,-1,A,r);let T=new cv.Mat,g=new cv.Size(l,1),y=cv.getStructuringElement(cv.MORPH_RECT,g),K=new cv.Point(-1,-1);cv.morphologyEx(R,T,cv.MORPH_OPEN,y,K,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let V=new cv.MatVector,Y=new cv.Mat;cv.findContours(T,V,Y,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let j=new cv.Scalar(255,255,255);cv.drawContours(d,V,-1,j,h),v.delete(),x.delete(),p.delete(),C.delete(),T.delete(),V.delete(),Y.delete(),y.delete()}let M=new cv.Size(i,i),s=cv.getStructuringElement(cv.MORPH_ELLIPSE,M),u=new cv.Mat,S=cv.Mat.ones(t.rows,t.cols,cv.CV_8UC3);S.setTo(new cv.Scalar(255,255,255)),cv.cvtColor(S,S,cv.COLOR_BGR2GRAY,0);let b=new cv.Mat;cv.cvtColor(d,b,cv.COLOR_BGR2GRAY,0);let B=new cv.Mat;cv.subtract(S,b,B,u,-1);let k=new cv.Mat;cv.dilate(B,k,s,O,a,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let L=new cv.Mat,I=new cv.Mat;cv.bitwise_and(k,R,L),cv.morphologyEx(L,I,cv.MORPH_CLOSE,s,O,c,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue());let G=new cv.Mat;cv.bitwise_and(I,R,G);let P=new cv.Mat;cv.subtract(S,G,P,u,-1);let U=new cv.MatVector,re=new cv.Mat;cv.findContours(G,U,re,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);const F=new Map;let z=[];for(let v=0;v<U.size();v++){let E=U.get(v),C=cv.boundingRect(E);(C.width>12||C.height>12)&&z.push(C)}let D=se(z),J=0;for(;null!==D&&J<200;)z=z.filter(v=>v!==D.toRemove1&&v!==D.toRemove2),z.push(D.u),D=se(z),J+=1;z.forEach(v=>{let E=new cv.Scalar(0,0,0),C=new cv.Point(v.x,v.y),x=new cv.Point(v.x+v.width,v.y+v.height),p=new cv.Mat,A=new cv.Mat,T=new cv.Mat,g=new cv.Scalar(255,0,0,255);p=$(P,v),v.width>v.height?cv.copyMakeBorder(p,p,(v.width-v.height)/2,(v.width-v.height)/2,1,1,cv.BORDER_CONSTANT,g):cv.copyMakeBorder(p,p,1,1,(v.height-v.width)/2,(v.height-v.width)/2,cv.BORDER_CONSTANT,g);let y=new cv.Size(26,26);cv.resize(p,A,y,0,0,cv.INTER_AREA),cv.copyMakeBorder(A,T,1,1,1,1,cv.BORDER_CONSTANT,g),F.set(v,T),p.delete(),A.delete(),cv.rectangle(P,C,x,E,2,cv.LINE_AA,0)}),m.delete(),R.delete(),s.delete(),u.delete(),S.delete(),b.delete(),B.delete(),k.delete(),d.delete(),L.delete(),I.delete(),G.delete(),U.delete(),re.delete();let f=[...F];if(f.sort((v,E)=>v[0].x<E[0].x?-1:1),n&&f.length>3){const v=(f[f.length-1][0].x-f[0][0].x)/f.length;let E=v,C=0,x=0,p=800;const A=[];for(let g=0;g<f.length-1;g++){let y=f[g+1][0].x-f[g][0].x;y<E&&(E=y),y>1.7*v&&A.push(g),f[g][0].y<p&&(p=f[g][0].y),f[g][0].height>C&&(C=f[g][0].height),f[g][0].width>x&&(x=f[g][0].width)}const T=(f[f.length-1][0].x-f[0][0].x)/(f.length+A.length);A.forEach(g=>{let y=f[g][0].x+T,K=new cv.Scalar(0,0,0),V=new cv.Point(y,p),Y=new cv.Point(y+x,p+C),j=new cv.Rect(y,p,x,C),X=new cv.Mat,ee=new cv.Mat,ae=new cv.Mat;X=$(P,j);let Ne=new cv.Size(26,26);cv.resize(X,ee,Ne,0,0,cv.INTER_AREA);let be=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(ee,ae,1,1,1,1,cv.BORDER_CONSTANT,be),F.set(j,ae),X.delete(),ee.delete(),cv.rectangle(P,V,Y,K,2,cv.LINE_AA,0)}),f=[...F],f.sort((g,y)=>g[0].x<y[0].x?-1:1)}return{letter:f,invert_final:P}}(t,!1,o,i);let c=[];e.forEach(r=>{c.push([r.padEnd(22," "),0])});const h=[];for(let r=0;r<a.letter.length;r++){let d=n.predict(H(a.letter[r][1]));l&&("1"===d[0]&&(d[0]="i"),"0"===d[0]&&(d[0]="o"),"5"===d[0]&&(d[0]="s"),"3"===d[0]&&(d[0]="b"),"9"===d[0]&&(d[0]="g")),h.push(d)}for(let r=0;r<c.length;r++){for(let d=0;d<13;d++)d<h.length&&(c[r][1]=c[r][0].substring(d,d+1).toLowerCase()===h[d][0].toLowerCase()?c[r][1]+h[d][1]:l?c[r][1]+(1-h[d][1])/35:c[r][1]+(1-h[d][1])/9);c[r][1]=c[r][1]/h.length}for(let r=0;r<c.length;r++)c[r][0]=c[r][0].trim(),c[r][1]=c[r][1]-Math.abs(c[r][0].length-h.length)/c[r][0].length;return c.sort((r,d)=>r[1]<d[1]?1:-1),{debug:a.invert_final,solution:c[0]}}(n,t.payload.match,o,!0,e,t.payload.preference);postMessage({msg:t.msg,payload:{debug:H(l.debug),solution:l.solution},uid:t.uid}),l.debug.delete(),n.delete()})}function ie(t,e){let n=cv.matFromImageData(t.payload.image),o=cv.matFromImageData(t.payload.template);const l=ce(e);l.isWarmedUp.then(()=>{const i=function Se(t,e,n,o,l,i,a){let c=[];n.forEach(s=>{c.push([s.padEnd(22," "),0])});let h=new cv.Mat;cv.cvtColor(t,h,cv.COLOR_RGBA2GRAY,0);let r=new cv.Mat;cv.cvtColor(e,r,cv.COLOR_RGBA2GRAY,0);const d=q(h,a),m=new Map;console.error("casesTemplate.cases.length ",d.cases.length);for(let s=0;s<d.cases.length;s++){const u=d.cases.sort(me)[s],w=N(u),S=_(u);let b=new cv.Mat,B=new cv.Mat,k=new cv.Size(26,26);const L=W(r,S,w);cv.resize(L,b,k,0,0,cv.INTER_AREA);let I=new cv.Scalar(255,0,0,255);cv.copyMakeBorder(b,B,1,1,1,1,cv.BORDER_CONSTANT,I),m.set(S,B),b.delete(),L.delete()}const R=[];for(let s=0;s<[...m].length;s++)if(Ee([...m][s][1])>.15){let w=o.predict(H([...m][s][1]));i&&("1"===w[0]&&(w[0]="i"),"0"===w[0]&&(w[0]="o"),"5"===w[0]&&(w[0]="s"),"3"===w[0]&&(w[0]="b"),"9"===w[0]&&(w[0]="g")),R.push(w)}else R.push(["",1]);console.error("predict",R);let O=0;R.forEach((s,u)=>{""!==s[0]&&(O=u)});let M=R.slice(0,O+1);for(let s=0;s<c.length;s++){for(let u=0;u<13;u++)u<M.length&&(c[s][1]=c[s][0].substring(u,u+1).toLowerCase()===M[u][0].toLowerCase()?c[s][1]+M[u][1]:i?c[s][1]+(1-M[u][1])/35:c[s][1]+(1-M[u][1])/9);c[s][1]=c[s][1]/M.length}for(let s=0;s<c.length;s++)c[s][0]=c[s][0].trim(),c[s][1]=c[s][1]-Math.abs(c[s][0].length-M.length)/c[s][0].length;c.sort((s,u)=>s[1]<u[1]?1:-1),h.delete(),r.delete();for(let s=0;s<[...m].length;s++)[...m][s][1].delete();for(let s=0;s<d.cases.length;s++)d.cases[s].delete();for(let s=0;s<d.img_cases.length;s++)d.img_cases[s].delete();return{solution:c[0]}}(o,n,t.payload.match,l,0,e,t.payload.preference);postMessage({msg:t.msg,payload:{solution:i.solution},uid:t.uid}),i.debug.delete(),n.delete(),o.delete()})}function H(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,l=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,l),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}function $(t,e,n){const o=t.size().width,l=t.size().height;return e.x+e.width>o&&(e.width=o-e.x),e.y+e.height>l&&(e.height=l-e.y),e.x<0&&(e.x=0),e.y<0&&(e.y=0),t.roi(e)}function Te(t,e){let n=e,o=t,l=t,i=e;t.x>e.x&&(n=t,o=e),t.y>e.y&&(l=e,i=t),t.right=t.x+t.width,e.right=e.x+e.width,t.bottom=t.y+t.height,e.bottom=e.y+e.height;let a=e,c=t,h=e,r=t;return t.right>e.right&&(a=t,c=e),t.bottom>e.bottom&&(h=t,r=e),n.x<o.right&&i.y>l.y+l.height?new cv.Rect(o.x,r.y,a.right-o.x,h.bottom-l.y):n.x>o.x+o.width+5||i.y>l.y+l.height?null:new cv.Rect(o.x,r.y,a.right-o.x,h.bottom-l.y)}function se(t){for(let e=0;e<t.length-1;e++){const n=t[e];for(let o=e+1;o<t.length;o++){const l=t[o],i=Te(n,l);if(null!==i)return{u:i,toRemove1:n,toRemove2:l}}}return null}addEventListener("message",t=>{switch(t.data.msg){case"hello":postMessage({msg:`worker response to ${t.data.msg}`,uid:t.data.uid});break;case"load":{const e=self;e.Module={scriptUrl:"content/opencv/4/opencv.js",onRuntimeInitialized(){cv.then(n=>{cv=n,n.ready.then(()=>postMessage({msg:"opencvready",uid:t.data.uid}))})}},e.importScripts(e.Module.scriptUrl),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),e.importScripts("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/tf-backend-wasm.min.js"),tf.wasm.setWasmPaths("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.20.0/dist/");break}case"imageCrop":return function xe(t){let e=new cv.Rect(t.payload.x,t.payload.y,t.payload.width,t.payload.height),n=new cv.Mat,o=cv.matFromImageData(t.payload.image);n=$(o,e),postMessage({msg:t.msg,payload:H(n),uid:t.uid}),n.delete(),o.delete()}(t.data);case"nameprediction":return le(t.data,!0);case"ineprediction":return le(t.data,!1);case"namepredictionTemplate":return ie(t.data,!0);case"inepredictionTemplate":return ie(t.data,!1);case"qcmresolution":return function he(t){const e={solutions:[]};let n=cv.matFromImageData(t.payload.imageTemplate),o=new cv.Mat;cv.cvtColor(n,o,cv.COLOR_RGBA2GRAY,0);const l=q(o,t.payload.preference);t.payload.pages?.forEach((i,a)=>{let c=new cv.Mat,h=cv.matFromImageData(i.imageInput);cv.cvtColor(h,c,cv.COLOR_RGBA2GRAY,0);const r=q(c,t.payload.preference),d=function Re(t,e){const n=[];return t.cases.forEach(o=>{let i,l=500;if(e.cases.forEach(a=>{const c=function Ce(t,e){const n=cv.boundingRect(t),o=cv.boundingRect(e);let l=n.x+n.width/2,i=n.y+n.height/2,a=o.x+o.width/2,c=o.y+o.height/2;return Math.sqrt((l-a)*(l-a)+(i-c)*(i-c))}(o,a);l>c&&c<25&&(l=c,i=a)}),void 0!==i){let a=_(o),c=_(i);n.push({x:a.x-c.x,y:a.y-c.y})}}),function ve(t){if(t.length>0){let e=0,n=0;return t.forEach(o=>{e+=o.x,n+=o.y}),{x:e/t.length,y:n/t.length}}return{x:0,y:0}}(n)}(r,l),m=function ye(t,e){let n=new cv.Mat;if(0!==e.x||0!==e.y){let o=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,-e.x,0,1,-e.y]),l=new cv.Size(t.cols,t.rows);return cv.warpAffine(t,n,o,l,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),n}return t}(h,d);let R=function _e(t,e,n,o){const l=[],i=[];let a=new Map;return t.cases.forEach((c,h)=>{const r=W(n,_(c),N(c)),d=function Me(t){let e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY,0);let n=new cv.Mat;return cv.threshold(e,n,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU),cv.countNonZero(n)/(t.rows*t.cols)}(r);d>o.qcm_differences_avec_case_blanche?(a.set(h,{verdict:!0,prediction:d}),l.push(c)):(a.set(h,{verdict:!1,prediction:d}),i.push(c)),d>.16&&d<.25?cv.putText(n,""+d.toFixed(2),{x:_(c).x,y:_(c).y-5},cv.FONT_HERSHEY_COMPLEX,.5,new cv.Scalar(255,0,0,128),1):cv.putText(n,""+d.toFixed(2),{x:_(c).x,y:_(c).y-5},cv.FONT_HERSHEY_COMPLEX,.33,new cv.Scalar(255,0,0,128),1),r.delete()}),oe(n,l,new cv.Scalar(0,255,0,128)),oe(n,i,new cv.Scalar(0,0,255,128)),a}(l,0,m,t.payload.preference),O=function de(t){const e=new cv.Mat,n=t.type()%8,o=n<=cv.CV_8S?1:n<=cv.CV_32S?1/256:255,l=n===cv.CV_8S||n===cv.CV_16S?128:0;switch(t.convertTo(e,cv.CV_8U,o,l),e.type()){case cv.CV_8UC1:cv.cvtColor(e,e,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(e,e,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const i=new ImageData(new Uint8ClampedArray(e.data),e.cols,e.rows);return e.delete(),i}(m),M=[];R.forEach((s,u)=>{s.verdict&&M.push(String.fromCharCode(97+u))}),e.solutions?.push({imageSolution:O,numero:a,solution:M.join("&")}),c.delete(),h.delete(),m!==h&&m.delete(),r.cases.forEach(s=>s.delete()),r.img_cases.forEach(s=>s.delete())}),n.delete(),o.delete(),l.cases.forEach(i=>i.delete()),l.img_cases.forEach(i=>i.delete()),postMessage({msg:t.msg,payload:e,uid:t.uid})}(t.data)}})})();